<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>FATE ROLL</title>
<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;500;600;700&family=Orbitron:wght@700;900&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#060810;
  --panel:#0b0e1c;
  --panel2:#0f1225;
  --panel3:#141829;
  --border:#1a2040;
  --border2:#232b4a;
  --text:#c8d3f5;
  --muted:#3d4670;
  --muted2:#5a6490;
  --gold:#f0b429;
  --gold2:#e8960a;
  --rose:#f43f5e;
  --violet:#8b5cf6;
  --cyan:#22d3ee;
  --glow-gold:rgba(240,180,41,.18);
  --glow-rose:rgba(244,63,94,.15);
  --glow-violet:rgba(139,92,246,.15);
  --common:#8899b8;--uncommon:#4ade80;--rare:#38bdf8;
  --epic:#c084fc;--legendary:#f0b429;--mythic:#fb923c;
  --divine:#f43f5e;--celestial:#e879f9;--eternal:#818cf8;--genesis:#22d3ee;
  --r:12px; /* border radius */
}
*{box-sizing:border-box;margin:0;padding:0;}

/* Scrollbar */
::-webkit-scrollbar{width:4px;height:4px;}
::-webkit-scrollbar-track{background:transparent;}
::-webkit-scrollbar-thumb{background:var(--border2);border-radius:4px;}

body{background:var(--bg);color:var(--text);font-family:'Outfit',sans-serif;font-weight:500;
  display:grid;grid-template-columns:290px 1fr;grid-template-rows:60px 1fr;height:100vh;overflow:hidden;}

/* Constellation background */
body::before{content:'';position:fixed;inset:0;pointer-events:none;z-index:0;
  background-image:
    radial-gradient(ellipse 60% 50% at 15% 20%, rgba(139,92,246,.07) 0%, transparent 70%),
    radial-gradient(ellipse 50% 60% at 85% 75%, rgba(240,180,41,.06) 0%, transparent 65%),
    radial-gradient(ellipse 40% 40% at 50% 50%, rgba(34,211,238,.04) 0%, transparent 70%);
}

/* ── USERNAME SCREEN ── */
#un-screen{position:fixed;inset:0;z-index:999;background:var(--bg);
  display:flex;align-items:center;justify-content:center;flex-direction:column;}
#un-screen::before{content:'';position:absolute;inset:0;pointer-events:none;
  background:radial-gradient(ellipse at 30% 40%,rgba(251,191,36,.05) 0%,transparent 55%),
    radial-gradient(ellipse at 70% 60%,rgba(244,63,94,.05) 0%,transparent 55%);}
.un-box{background:var(--panel);border:1px solid var(--border);border-radius:16px;
  padding:52px 48px;width:400px;text-align:center;position:relative;z-index:1;
  box-shadow:0 0 80px rgba(0,0,0,.7);}
.un-logo{font-family:'Orbitron',sans-serif;font-size:1.6rem;font-weight:900;letter-spacing:.22em;
  background:linear-gradient(135deg,#fbbf24,#fb923c,#f43f5e);-webkit-background-clip:text;
  -webkit-text-fill-color:transparent;background-clip:text;margin-bottom:8px;}
.un-sub{font-size:.75rem;color:var(--muted);letter-spacing:.1em;margin-bottom:36px;}
.un-label{font-size:.58rem;letter-spacing:.18em;text-transform:uppercase;color:var(--muted);text-align:left;margin-bottom:8px;}
.un-input{width:100%;background:var(--panel2);border:1px solid var(--border);border-radius:8px;
  color:var(--text);font-family:'Outfit',sans-serif;font-size:1.05rem;font-weight:600;
  padding:13px 16px;outline:none;margin-bottom:6px;letter-spacing:.06em;text-align:center;transition:border-color .2s;}
.un-input:focus{border-color:rgba(251,191,36,.5);}
.un-hint{font-size:.62rem;color:var(--muted);margin-bottom:18px;letter-spacing:.05em;}
.un-err{color:#f43f5e;font-size:.7rem;font-weight:600;margin-bottom:10px;display:none;}
.un-btn{width:100%;padding:14px;font-family:'Orbitron',sans-serif;font-size:.78rem;font-weight:700;
  letter-spacing:.18em;cursor:pointer;border:none;border-radius:8px;
  background:linear-gradient(135deg,#fbbf24,#f97316);color:#060810;transition:opacity .15s,transform .1s;}
.un-btn:hover{opacity:.88;} .un-btn:active{transform:scale(.97);}

/* ── HEADER ── */
header{grid-column:1/-1;background:var(--panel);border-bottom:1px solid var(--border);
  display:flex;align-items:center;justify-content:space-between;padding:0 18px;height:56px;gap:10px;}
.logo{font-family:'Orbitron',sans-serif;font-size:.88rem;font-weight:900;letter-spacing:.2em;flex-shrink:0;
  background:linear-gradient(90deg,#fbbf24,#f43f5e);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;}
.hstats{display:flex;gap:14px;align-items:center;flex-wrap:nowrap;}
.hstat{text-align:right;white-space:nowrap;}
.hstat-lbl{font-size:.5rem;letter-spacing:.12em;text-transform:uppercase;color:var(--muted);margin-bottom:1px;}
.hstat-val{font-family:'Orbitron',sans-serif;font-size:.8rem;font-weight:700;transition:color .3s;}
.coin-pill{display:flex;align-items:center;gap:5px;background:rgba(251,191,36,.08);
  border:1px solid rgba(251,191,36,.25);border-radius:20px;padding:4px 10px;}
.coin-val{font-family:'Orbitron',sans-serif;font-size:.9rem;font-weight:700;color:#fbbf24;}
.boost-pill{display:none;align-items:center;gap:5px;padding:3px 10px;border-radius:20px;
  background:rgba(74,222,128,.07);border:1px solid rgba(74,222,128,.28);}
.boost-pill.on{display:flex;}
.boost-txt{font-family:'Orbitron',sans-serif;font-size:.56rem;font-weight:700;color:#4ade80;white-space:nowrap;}
.boost-timer{font-size:.58rem;color:var(--muted);white-space:nowrap;}
.bg-indicator{display:none;align-items:center;gap:5px;padding:3px 10px;border-radius:20px;
  background:rgba(192,132,252,.07);border:1px solid rgba(192,132,252,.28);}
.bg-indicator.on{display:flex;}
.bg-txt{font-family:'Orbitron',sans-serif;font-size:.55rem;font-weight:700;color:#c084fc;white-space:nowrap;animation:bgPulse 1.5s ease-in-out infinite;}
@keyframes bgPulse{0%,100%{opacity:1;}50%{opacity:.5;}}
.hdr-acts{display:flex;gap:5px;flex-shrink:0;}
.hdr-btn{padding:5px 10px;font-family:'Orbitron',sans-serif;font-size:.52rem;font-weight:700;
  letter-spacing:.08em;cursor:pointer;border:1px solid var(--border);border-radius:4px;
  background:transparent;color:var(--muted);transition:all .2s;text-transform:uppercase;white-space:nowrap;}
.hdr-btn:hover{border-color:var(--muted);color:var(--text);}
.hdr-btn.save{border-color:#4ade8050;color:#4ade80;} .hdr-btn.save:hover{background:#4ade8010;}
.hdr-btn.reset{border-color:#f43f5e50;color:#f43f5e;} .hdr-btn.reset:hover{background:#f43f5e10;}
.hdr-btn.admin{border-color:#c084fc50;color:#c084fc;} .hdr-btn.admin:hover{background:#c084fc10;}

/* ── LEFT PANEL ── */
.left-panel{grid-column:1;grid-row:2;background:var(--panel);border-right:1px solid var(--border);
  display:flex;flex-direction:column;overflow:hidden;}
.sec-head{padding:8px 14px 7px;font-size:.52rem;letter-spacing:.2em;text-transform:uppercase;
  color:var(--muted);border-bottom:1px solid var(--border);flex-shrink:0;
  display:flex;justify-content:space-between;align-items:center;}
.rar-table{flex-shrink:0;overflow-y:auto;max-height:260px;}
.rar-row{display:grid;grid-template-columns:80px 54px 66px 1fr 28px;align-items:center;gap:4px;
  padding:4px 14px;border-bottom:1px solid rgba(30,37,53,.4);}
.rar-name{font-weight:700;font-size:.77rem;}
.rar-pct{font-size:.63rem;color:var(--muted);font-weight:600;text-align:right;}
.rar-1in{font-size:.58rem;color:var(--muted);text-align:right;white-space:nowrap;}
.bar-bg{height:4px;background:rgba(255,255,255,.05);border-radius:2px;overflow:hidden;}
.bar-fill{height:100%;border-radius:2px;transition:width .4s ease;}
.rar-cnt{font-family:'Orbitron',sans-serif;font-size:.55rem;font-weight:700;text-align:right;color:var(--muted);transition:color .3s;}

/* CONTROLS */
.controls{padding:10px 14px;border-bottom:1px solid var(--border);flex-shrink:0;display:flex;flex-direction:column;gap:6px;}
.roll-btn{width:100%;padding:10px;font-family:'Orbitron',sans-serif;font-size:.7rem;font-weight:700;
  letter-spacing:.14em;cursor:pointer;border:none;border-radius:4px;
  background:linear-gradient(135deg,#fbbf24,#f97316);color:#060810;
  transition:opacity .15s,transform .1s;text-transform:uppercase;}
.roll-btn:hover:not(:disabled){opacity:.85;} .roll-btn:active:not(:disabled){transform:scale(.97);}
.roll-btn:disabled{opacity:.3;cursor:not-allowed;}
.auto-row{display:flex;gap:5px;}
.auto-btn{flex:1;padding:8px;font-family:'Orbitron',sans-serif;font-size:.56rem;font-weight:700;
  letter-spacing:.07em;cursor:pointer;border:1px solid var(--border);border-radius:4px;
  background:transparent;color:var(--text);transition:all .2s;text-transform:uppercase;}
.auto-btn:hover{border-color:var(--muted);}
.auto-btn.active{background:#f43f5e1a;border-color:#f43f5e;color:#f43f5e;}
.speed-sel{background:var(--panel2);border:1px solid var(--border);border-radius:4px;
  color:var(--text);font-family:'Outfit',sans-serif;font-size:.8rem;font-weight:600;
  padding:7px 6px;cursor:pointer;outline:none;}
.turbo-btn{padding:8px 9px;font-family:'Orbitron',sans-serif;font-size:.54rem;font-weight:700;
  letter-spacing:.07em;cursor:pointer;border:1px solid var(--border);border-radius:4px;
  background:transparent;color:var(--muted);transition:all .2s;text-transform:uppercase;white-space:nowrap;}
.turbo-btn.unlocked{border-color:#e879f944;color:#e879f9;}
.turbo-btn.unlocked:hover{background:#e879f910;}
.turbo-btn.active{background:#e879f91a;border-color:#e879f9;color:#e879f9;}
.turbo-lock{font-size:.58rem;color:var(--muted);text-align:center;padding:2px 0;letter-spacing:.04em;}
.prog-wrap{height:2px;background:rgba(255,255,255,.04);overflow:hidden;opacity:0;transition:opacity .2s;flex-shrink:0;}
.prog-wrap.vis{opacity:1;}
.prog-fill{height:100%;background:linear-gradient(90deg,#fbbf24,#f43f5e);}
.bg-badge{font-family:'Orbitron',sans-serif;font-size:.5rem;color:#c084fc;
  padding:3px 14px;text-align:center;background:rgba(192,132,252,.05);border-top:1px solid rgba(192,132,252,.12);
  display:none;letter-spacing:.07em;}
.bg-badge.on{display:block;}

/* HISTORY */
.hist-wrap{flex:1;display:flex;flex-direction:column;overflow:hidden;min-height:0;}
.hist-list{flex:1;overflow-y:auto;scrollbar-width:thin;scrollbar-color:var(--border) transparent;}
.hist-item{display:grid;grid-template-columns:22px 1fr auto;align-items:center;gap:7px;
  padding:4px 14px;border-bottom:1px solid rgba(30,37,53,.3);
  opacity:0;transform:translateX(-7px);animation:slideIn .2s ease forwards;font-size:.79rem;}
@keyframes slideIn{to{opacity:1;transform:translateX(0);}}
.hi-em{text-align:center;font-size:.86rem;}
.hi-name{font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.hi-tag{font-size:.58rem;font-weight:700;letter-spacing:.06em;text-transform:uppercase;white-space:nowrap;}

/* ── RIGHT PANEL ── */
.right-panel{grid-column:2;grid-row:2;display:flex;flex-direction:column;overflow:hidden;
  background:radial-gradient(ellipse at 50% 40%,#0d1020 0%,#07090f 70%);position:relative;}
.right-panel::before{content:'';position:absolute;inset:0;pointer-events:none;
  background-image:linear-gradient(rgba(255,255,255,.009) 1px,transparent 1px),
    linear-gradient(90deg,rgba(255,255,255,.009) 1px,transparent 1px);
  background-size:48px 48px;}

/* TABS */
.tabs{display:flex;border-bottom:1px solid var(--border);background:var(--panel);flex-shrink:0;position:relative;z-index:5;}
.tab-btn{padding:0 16px;height:42px;font-family:'Orbitron',sans-serif;font-size:.58rem;font-weight:700;
  letter-spacing:.12em;text-transform:uppercase;background:transparent;border:none;
  color:var(--muted);cursor:pointer;border-bottom:2px solid transparent;
  transition:color .2s,border-color .2s;display:flex;align-items:center;gap:5px;white-space:nowrap;}
.tab-btn:hover{color:var(--text);}
.tab-btn.active{color:var(--text);border-bottom-color:#fbbf24;}
.tab-badge{background:var(--border);color:var(--muted);font-size:.54rem;padding:1px 5px;
  border-radius:10px;font-family:'Outfit',sans-serif;font-weight:700;transition:all .2s;}
.tab-btn.active .tab-badge{background:#fbbf2430;color:#fbbf24;}

/* TAB VIEWS */
.tab-view{flex:1;overflow:hidden;display:none;position:relative;z-index:1;}
.tab-view.active{display:flex;}
#view-roll{align-items:center;justify-content:center;flex-direction:column;gap:15px;}

/* ROLL */
#flash{position:absolute;inset:0;pointer-events:none;opacity:0;z-index:10;}
#toast{position:absolute;top:13px;left:50%;transform:translateX(-50%) translateY(-80px);
  background:linear-gradient(135deg,#fbbf24,#f43f5e);color:#060810;
  font-family:'Orbitron',sans-serif;font-size:.56rem;font-weight:700;letter-spacing:.18em;
  padding:5px 13px;border-radius:20px;z-index:20;pointer-events:none;
  transition:transform .42s cubic-bezier(.34,1.56,.64,1);white-space:nowrap;}
#toast.show{transform:translateX(-50%) translateY(0);}
#coin-pop{position:absolute;top:46px;left:50%;transform:translateX(-50%) translateY(18px);
  font-family:'Orbitron',sans-serif;font-size:.76rem;font-weight:700;color:#fbbf24;
  z-index:20;pointer-events:none;opacity:0;text-shadow:0 0 8px #fbbf24;}
#coin-pop.show{animation:coinPop .85s ease forwards;}
@keyframes coinPop{0%{opacity:0;transform:translateX(-50%) translateY(18px);}
  20%{opacity:1;transform:translateX(-50%) translateY(-7px);}
  80%{opacity:1;transform:translateX(-50%) translateY(-11px);}
  100%{opacity:0;transform:translateX(-50%) translateY(-28px);}}

/* CINEMATIC */
#cinematic{position:absolute;inset:0;z-index:50;pointer-events:none;
  display:flex;align-items:center;justify-content:center;opacity:0;}
#cinematic.active{pointer-events:all;}
#cin-bg{position:absolute;inset:0;opacity:0;transition:opacity .5s;}
#cinematic.active #cin-bg{opacity:1;}
#cin-canvas{position:absolute;inset:0;pointer-events:none;}
#cin-card{position:relative;z-index:5;width:295px;border-radius:14px;overflow:hidden;
  transform:scale(0) rotateY(180deg);opacity:0;}
#cin-card.reveal{animation:cinReveal 1s cubic-bezier(.34,1.56,.64,1) .3s forwards;}
@keyframes cinReveal{0%{transform:scale(0) rotateY(180deg);opacity:0;}40%{opacity:1;}70%{transform:scale(1.08) rotateY(-4deg);}100%{transform:scale(1) rotateY(0deg);opacity:1;}}
#cin-card .card-body{padding:26px 20px 20px;gap:9px;}
#cin-card .card-icon{font-size:4.3rem;}
#cin-label{position:absolute;bottom:54px;left:50%;transform:translateX(-50%);
  font-family:'Orbitron',sans-serif;font-size:.56rem;letter-spacing:.27em;text-transform:uppercase;
  color:rgba(255,255,255,.32);opacity:0;white-space:nowrap;z-index:6;}
#cin-label.show{animation:fadeInUp .6s ease .8s forwards;}
@keyframes fadeInUp{from{opacity:0;transform:translateX(-50%) translateY(9px);}to{opacity:1;transform:translateX(-50%) translateY(0);}}
#cin-skip{position:absolute;bottom:16px;right:18px;background:rgba(255,255,255,.06);
  border:1px solid rgba(255,255,255,.1);color:rgba(255,255,255,.32);
  font-family:'Orbitron',sans-serif;font-size:.5rem;letter-spacing:.12em;
  padding:4px 10px;border-radius:3px;cursor:pointer;opacity:0;z-index:20;transition:opacity .3s;}
#cin-skip.vis{opacity:1;} #cin-skip:hover{color:rgba(255,255,255,.7);}

/* CARD */
.idle-msg{font-family:'Orbitron',sans-serif;font-size:.66rem;letter-spacing:.22em;color:var(--muted);}
.card-wrap{position:relative;}
.card{width:248px;background:var(--panel2);border-radius:10px;overflow:hidden;
  position:relative;transform:scale(.2) rotateX(50deg);opacity:0;}
.card.show{animation:cardPop .48s cubic-bezier(.34,1.56,.64,1) forwards;}
@keyframes cardPop{0%{transform:scale(.2) rotateX(50deg);opacity:0;}55%{transform:scale(1.04) rotateX(-2deg);opacity:1;}100%{transform:scale(1) rotateX(0deg);opacity:1;}}
.card-top-bar{height:4px;width:100%;}
.card-body{padding:19px 17px 15px;display:flex;flex-direction:column;align-items:center;gap:6px;}
.card-icon{font-size:3.1rem;line-height:1;filter:drop-shadow(0 0 14px var(--c,#fff));animation:float 3s ease-in-out infinite;}
@keyframes float{0%,100%{transform:translateY(0);}50%{transform:translateY(-6px);}}
.card-rar{font-family:'Orbitron',sans-serif;font-size:.54rem;letter-spacing:.22em;font-weight:700;text-transform:uppercase;}
.card-name{font-family:'Orbitron',sans-serif;font-size:.9rem;font-weight:700;text-align:center;letter-spacing:.04em;line-height:1.3;}
.card-sep{width:28px;height:1px;opacity:.24;}
.card-odds{display:flex;gap:16px;text-align:center;}
.odds-col{display:flex;flex-direction:column;gap:2px;}
.odds-key{font-size:.5rem;letter-spacing:.1em;text-transform:uppercase;color:var(--muted);}
.odds-val{font-family:'Orbitron',sans-serif;font-size:.78rem;font-weight:700;}
.card-ring{position:absolute;inset:0;border-radius:10px;pointer-events:none;}
.card-coin{font-family:'Orbitron',sans-serif;font-size:.66rem;font-weight:700;color:#fbbf24;
  text-align:center;opacity:0;animation:rewardFade 1.5s ease .6s forwards;}
@keyframes rewardFade{0%{opacity:0;transform:translateY(4px);}30%{opacity:1;transform:translateY(0);}80%{opacity:1;}100%{opacity:0;}}
.pcvs{position:absolute;inset:-120px;pointer-events:none;overflow:visible;z-index:3;}
.p{position:absolute;border-radius:50%;top:50%;left:50%;opacity:0;}
@keyframes pBurst{0%{opacity:1;transform:translate(-50%,-50%) rotate(var(--a)) translateX(0) scale(1);}100%{opacity:0;transform:translate(-50%,-50%) rotate(var(--a)) translateX(var(--d)) scale(0);}}
.shock{position:absolute;width:10px;height:10px;border-radius:50%;top:50%;left:50%;
  transform:translate(-50%,-50%) scale(0);opacity:0;pointer-events:none;z-index:1;}
.roll-lbl{font-family:'Orbitron',sans-serif;font-size:.64rem;letter-spacing:.17em;color:var(--muted);text-transform:uppercase;}

/* ── INVENTORY ── */
#view-inv{flex-direction:column;overflow:hidden;}
.inv-toolbar{display:flex;align-items:center;gap:6px;padding:9px 15px;
  border-bottom:1px solid var(--border);background:var(--panel);flex-shrink:0;flex-wrap:wrap;}
.inv-filt{padding:3px 8px;font-family:'Orbitron',sans-serif;font-size:.5rem;font-weight:700;
  letter-spacing:.08em;text-transform:uppercase;border:1px solid var(--border);border-radius:20px;
  background:transparent;color:var(--muted);cursor:pointer;transition:all .14s;white-space:nowrap;}
.inv-filt:hover{border-color:var(--muted);color:var(--text);}
.inv-filt.on{color:#060810!important;border-color:transparent!important;}
.inv-sort{margin-left:auto;background:var(--panel2);border:1px solid var(--border);border-radius:4px;
  color:var(--text);font-family:'Outfit',sans-serif;font-size:.76rem;font-weight:600;
  padding:4px 6px;cursor:pointer;outline:none;}
.inv-sum{padding:5px 15px;font-size:.66rem;color:var(--muted);letter-spacing:.06em;
  border-bottom:1px solid var(--border);flex-shrink:0;display:flex;gap:9px;align-items:center;flex-wrap:wrap;}
.i-dot{width:5px;height:5px;border-radius:50%;flex-shrink:0;display:inline-block;}
.inv-grid{flex:1;overflow-y:auto;padding:13px 15px;display:grid;
  grid-template-columns:repeat(auto-fill,minmax(104px,1fr));gap:8px;
  align-content:start;scrollbar-width:thin;scrollbar-color:var(--border) transparent;}
.inv-empty{grid-column:1/-1;text-align:center;padding:44px 20px;color:var(--muted);}
.inv-empty-icon{font-size:1.9rem;margin-bottom:8px;opacity:.28;}
.inv-empty-txt{font-family:'Orbitron',sans-serif;font-size:.58rem;letter-spacing:.17em;}
.inv-item{background:var(--panel2);border-radius:7px;overflow:hidden;position:relative;cursor:pointer;
  transition:transform .14s;border:1px solid rgba(255,255,255,.04);
  animation:invPop .26s cubic-bezier(.34,1.56,.64,1) both;}
@keyframes invPop{from{opacity:0;transform:scale(.7);}to{opacity:1;transform:scale(1);}}
.inv-item:hover{transform:translateY(-3px) scale(1.03);}
.inv-item-bar{height:3px;width:100%;}
.inv-item-body{padding:8px 6px 7px;display:flex;flex-direction:column;align-items:center;gap:4px;text-align:center;}
.inv-em{font-size:1.75rem;line-height:1;}
.inv-iname{font-size:.64rem;font-weight:700;line-height:1.2;color:var(--text);}
.inv-itar{font-family:'Orbitron',sans-serif;font-size:.44rem;font-weight:700;letter-spacing:.08em;text-transform:uppercase;}
.inv-cnt{position:absolute;top:4px;right:4px;background:rgba(0,0,0,.6);
  border:1px solid rgba(255,255,255,.1);border-radius:9px;font-family:'Orbitron',sans-serif;
  font-size:.52rem;font-weight:700;padding:1px 4px;color:var(--text);min-width:18px;text-align:center;}
.inv-new{position:absolute;top:4px;left:4px;background:linear-gradient(135deg,#fbbf24,#f43f5e);
  color:#060810;font-family:'Orbitron',sans-serif;font-size:.42rem;font-weight:700;
  padding:1px 4px;border-radius:3px;animation:newPulse 1s ease-in-out 3;}
@keyframes newPulse{0%,100%{opacity:1;}50%{opacity:.4;}}
.det-overlay{display:none;position:absolute;inset:0;background:rgba(7,9,15,.9);z-index:20;
  align-items:center;justify-content:center;backdrop-filter:blur(4px);}
.det-overlay.open{display:flex;}
.det-card{background:var(--panel2);border-radius:12px;overflow:hidden;width:262px;position:relative;
  animation:invPop .26s cubic-bezier(.34,1.56,.64,1) both;}
.det-bar{height:5px;} .det-body{padding:22px 20px 18px;display:flex;flex-direction:column;align-items:center;gap:8px;text-align:center;}
.det-icon{font-size:3.3rem;line-height:1;} .det-rar{font-family:'Orbitron',sans-serif;font-size:.56rem;letter-spacing:.16em;font-weight:700;text-transform:uppercase;}
.det-name{font-family:'Orbitron',sans-serif;font-size:.92rem;font-weight:700;}
.det-sep{width:28px;height:1px;opacity:.23;}
.det-stats{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;width:100%;}
.det-stat{display:flex;flex-direction:column;gap:2px;align-items:center;}
.det-sk{font-size:.48rem;letter-spacing:.1em;text-transform:uppercase;color:var(--muted);}
.det-sv{font-family:'Orbitron',sans-serif;font-size:.8rem;font-weight:700;}
.det-close{position:absolute;top:7px;right:8px;background:transparent;border:none;color:var(--muted);font-size:.95rem;cursor:pointer;transition:color .2s;}
.det-close:hover{color:var(--text);} .det-ring{position:absolute;inset:0;border-radius:12px;pointer-events:none;}


/* ── ACHIEVEMENTS ── */
#view-ach{flex-direction:column;overflow:hidden;}
.ach-hdr{padding:11px 18px 9px;border-bottom:1px solid var(--border);background:var(--panel);
  flex-shrink:0;display:flex;align-items:center;justify-content:space-between;}
.ach-title{font-family:'Orbitron',sans-serif;font-size:.74rem;font-weight:700;letter-spacing:.14em;}
.ach-sub{font-size:.66rem;color:var(--muted);}
.ach-progress-bar{height:4px;background:rgba(255,255,255,.06);margin:0;flex-shrink:0;}
.ach-progress-fill{height:100%;background:linear-gradient(90deg,#fbbf24,#f43f5e);transition:width .5s ease;}
.ach-body{flex:1;overflow-y:auto;padding:14px 16px;scrollbar-width:thin;scrollbar-color:var(--border) transparent;}
.ach-section-title{font-family:'Orbitron',sans-serif;font-size:.56rem;letter-spacing:.2em;text-transform:uppercase;
  color:var(--muted);padding:0 0 9px;border-bottom:1px solid var(--border);margin-bottom:11px;margin-top:18px;}
.ach-section-title:first-child{margin-top:0;}
.ach-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(175px,1fr));gap:9px;margin-bottom:4px;}
.ach-card{background:var(--panel2);border:1px solid var(--border);border-radius:9px;padding:13px 13px 11px;
  display:flex;flex-direction:column;gap:6px;position:relative;transition:border-color .2s;}
.ach-card.unlocked{border-color:#fbbf2444;background:rgba(251,191,36,.035);}
.ach-card.locked{opacity:.48;}
.ach-icon{font-size:1.5rem;line-height:1;}
.ach-name{font-family:'Orbitron',sans-serif;font-size:.62rem;font-weight:700;letter-spacing:.04em;}
.ach-desc{font-size:.67rem;color:var(--muted);line-height:1.4;}
.ach-reward{font-size:.6rem;font-weight:700;color:#fbbf24;}
.ach-check{position:absolute;top:9px;right:10px;font-size:.9rem;}
.ach-prog{width:100%;height:3px;background:rgba(255,255,255,.07);border-radius:2px;margin-top:2px;}
.ach-prog-fill{height:100%;background:linear-gradient(90deg,#818cf8,#c084fc);border-radius:2px;transition:width .4s;}
.ach-prog-txt{font-size:.56rem;color:var(--muted);margin-top:2px;}

/* ── SHOP ── */
#view-ach{flex-direction:column;overflow:hidden;}
#view-shop{flex-direction:column;overflow:hidden;}
.shop-hdr{padding:12px 18px;border-bottom:1px solid var(--border);background:var(--panel);
  flex-shrink:0;display:flex;align-items:center;justify-content:space-between;}
.shop-title-grp{display:flex;flex-direction:column;gap:2px;}
.shop-title{font-family:'Orbitron',sans-serif;font-size:.68rem;font-weight:700;letter-spacing:.13em;}
.shop-sub{font-size:.7rem;color:var(--muted);}
.shop-bal{display:flex;align-items:center;gap:6px;font-family:'Orbitron',sans-serif;font-size:.78rem;font-weight:700;color:#fbbf24;}
.shop-body{flex:1;overflow-y:auto;padding:16px;scrollbar-width:thin;scrollbar-color:var(--border) transparent;}
.shop-section{margin-bottom:22px;}
.shop-sec-title{font-family:'Orbitron',sans-serif;font-size:.6rem;letter-spacing:.2em;text-transform:uppercase;
  color:var(--muted);padding:0 0 10px;border-bottom:1px solid var(--border);margin-bottom:12px;
  display:flex;align-items:center;gap:8px;}
.boost-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:10px;}
.boost-card{background:var(--panel2);border:1px solid var(--border);border-radius:10px;
  overflow:hidden;display:flex;flex-direction:column;transition:border-color .2s,transform .15s;}
.boost-card:hover{transform:translateY(-2px);}
.boost-card.active-boost{border-color:#4ade8066;background:rgba(74,222,128,.03);}
.boost-card.cant-afford{opacity:.55;}
.boost-top{padding:16px 14px 10px;display:flex;flex-direction:column;align-items:center;gap:7px;flex:1;}
.boost-icon{font-size:2rem;line-height:1;}
.boost-name{font-family:'Orbitron',sans-serif;font-size:.68rem;font-weight:700;text-align:center;letter-spacing:.04em;}
.boost-desc{font-size:.7rem;color:var(--muted);text-align:center;line-height:1.4;}
.boost-duration{font-size:.62rem;font-weight:700;color:var(--text);text-align:center;letter-spacing:.04em;}
.boost-timer-disp{font-family:'Orbitron',sans-serif;font-size:.62rem;font-weight:700;color:#4ade80;text-align:center;}
.boost-effect{font-size:.64rem;font-weight:700;text-align:center;}
.boost-bottom{padding:8px 13px 12px;border-top:1px solid var(--border);
  display:flex;align-items:center;justify-content:space-between;gap:8px;}
.boost-price{display:flex;align-items:center;gap:4px;font-family:'Orbitron',sans-serif;font-size:.72rem;font-weight:700;color:#fbbf24;}
.boost-btn{padding:5px 12px;font-family:'Orbitron',sans-serif;font-size:.58rem;font-weight:700;
  letter-spacing:.08em;cursor:pointer;border:none;border-radius:4px;
  background:linear-gradient(135deg,#fbbf24,#f97316);color:#060810;transition:opacity .15s;white-space:nowrap;}
.boost-btn:hover{opacity:.84;} .boost-btn:disabled{opacity:.32;cursor:not-allowed;}
.boost-btn.active-btn{background:rgba(74,222,128,.14);color:#4ade80;border:1px solid #4ade8044;cursor:default;}

/* ── LEADERBOARD ── */
#view-board{flex-direction:column;overflow:hidden;}
.board-hdr{padding:11px 18px 9px;border-bottom:1px solid var(--border);background:var(--panel);
  flex-shrink:0;display:flex;align-items:center;justify-content:space-between;}
.board-title{font-family:'Orbitron',sans-serif;font-size:.74rem;font-weight:700;letter-spacing:.14em;}
.board-sub{font-size:.66rem;color:var(--muted);}
.board-refresh{padding:5px 10px;font-family:'Orbitron',sans-serif;font-size:.52rem;font-weight:700;
  letter-spacing:.08em;cursor:pointer;border:1px solid var(--border);border-radius:4px;
  background:transparent;color:var(--muted);transition:all .2s;}
.board-refresh:hover{color:var(--text);border-color:var(--muted);}
.board-body{flex:1;overflow-y:auto;padding:13px 18px;scrollbar-width:thin;scrollbar-color:var(--border) transparent;}
.board-col-head{display:grid;grid-template-columns:36px 1fr 96px 76px 90px;gap:10px;
  padding:3px 13px 7px;font-size:.5rem;letter-spacing:.1em;text-transform:uppercase;color:var(--muted);}
.board-entry{display:grid;grid-template-columns:36px 1fr 96px 76px 90px;align-items:center;gap:10px;
  padding:8px 13px;border-radius:5px;margin-bottom:5px;background:var(--panel2);
  border:1px solid var(--border);}
.board-entry.me{border-color:#fbbf2444;background:rgba(251,191,36,.03);}
.board-entry.top1{border-color:#fbbf2477;} .board-entry.top2{border-color:#94a3b855;} .board-entry.top3{border-color:#fb923c55;}
.board-rank{font-family:'Orbitron',sans-serif;font-size:.8rem;font-weight:700;text-align:center;}
.board-name{font-weight:700;font-size:.86rem;}
.you-tag{font-size:.5rem;color:#fbbf24;font-family:'Orbitron',sans-serif;margin-left:5px;letter-spacing:.08em;}
.board-coins{font-family:'Orbitron',sans-serif;font-size:.74rem;font-weight:700;color:#fbbf24;text-align:right;}
.board-rolls{font-family:'Orbitron',sans-serif;font-size:.7rem;font-weight:700;color:var(--muted);text-align:right;}
.board-best{font-size:.62rem;font-weight:700;text-align:right;}

/* ── EDITOR VIEW ── */
.editor-wrap{flex:1;overflow-y:auto;padding:18px;display:flex;flex-direction:column;gap:24px;}
.editor-section{background:var(--panel);border:1px solid var(--border);border-radius:10px;padding:20px;}
.editor-title{font-family:'Orbitron',sans-serif;font-size:1.1rem;font-weight:700;margin-bottom:16px;letter-spacing:.05em;color:#fbbf24;}
.editor-subtitle{font-size:.75rem;color:var(--muted);margin-bottom:16px;line-height:1.5;}
.editor-list{display:flex;flex-direction:column;gap:10px;margin-bottom:16px;}
.editor-rarity-item{background:var(--panel2);border:1px solid var(--border);border-radius:6px;padding:12px;display:grid;grid-template-columns:auto 1fr auto auto auto;gap:12px;align-items:center;}
.editor-rarity-color{width:32px;height:32px;border-radius:4px;cursor:pointer;border:2px solid var(--border);}
.editor-rarity-info{display:flex;flex-direction:column;gap:4px;}
.editor-rarity-name{font-weight:700;font-size:.85rem;}
.editor-rarity-chance{font-size:.7rem;color:var(--muted);}
.editor-btn{padding:6px 12px;font-family:'Orbitron',sans-serif;font-size:.6rem;font-weight:700;letter-spacing:.08em;cursor:pointer;border:1px solid var(--border);border-radius:4px;background:transparent;color:var(--text);transition:all .2s;text-transform:uppercase;}
.editor-btn:hover{border-color:var(--muted);background:rgba(255,255,255,.05);}
.editor-btn.primary{background:#fbbf2420;border-color:#fbbf2450;color:#fbbf24;}
.editor-btn.primary:hover{background:#fbbf2430;}
.editor-btn.danger{border-color:#f43f5e50;color:#f43f5e;}
.editor-btn.danger:hover{background:#f43f5e10;}
.editor-input{background:var(--panel2);border:1px solid var(--border);border-radius:4px;padding:8px;color:var(--text);font-family:'Outfit',sans-serif;font-size:.82rem;outline:none;width:100%;}
.editor-input:focus{border-color:var(--muted);}
.editor-form{display:flex;flex-direction:column;gap:12px;margin-top:16px;padding-top:16px;border-top:1px solid var(--border);}
.editor-form-group{display:flex;flex-direction:column;gap:6px;}
.editor-label{font-size:.65rem;letter-spacing:.1em;text-transform:uppercase;color:var(--muted);font-weight:700;}
.editor-item-list{display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:12px;margin-bottom:16px;}
.editor-item-card{background:var(--panel2);border:1px solid var(--border);border-radius:6px;padding:12px;display:flex;flex-direction:column;gap:8px;}
.editor-item-preview{display:flex;align-items:center;gap:10px;}
.editor-item-emoji{font-size:2rem;width:48px;height:48px;display:flex;align-items:center;justify-content:center;border-radius:4px;background:var(--panel);}
.editor-item-emoji img{width:100%;height:100%;object-fit:cover;border-radius:4px;}
.editor-item-details{flex:1;}
.editor-item-name{font-weight:700;font-size:.82rem;margin-bottom:2px;}
.editor-item-rarity{font-size:.62rem;text-transform:uppercase;letter-spacing:.08em;}
.editor-item-actions{display:flex;gap:6px;}
.editor-file-input{display:none;}
.editor-upload-btn{padding:8px 12px;background:var(--panel);border:1px dashed var(--border);border-radius:4px;cursor:pointer;text-align:center;font-size:.7rem;color:var(--muted);transition:all .2s;}
.editor-upload-btn:hover{border-color:var(--muted);color:var(--text);}
.editor-color-preview{width:24px;height:24px;border-radius:4px;border:1px solid var(--border);}

.board-loading{text-align:center;padding:36px;color:var(--muted);font-family:'Orbitron',sans-serif;font-size:.6rem;letter-spacing:.17em;}
.board-status{font-size:.62rem;color:var(--muted);text-align:center;padding:6px;letter-spacing:.06em;display:flex;align-items:center;justify-content:center;gap:6px;}
.board-dot{width:6px;height:6px;border-radius:50%;animation:blink 1.5s ease-in-out infinite;}
@keyframes blink{0%,100%{opacity:.3;}50%{opacity:1;}}

/* ── MODALS ── */
.modal-ov{display:none;position:fixed;inset:0;background:rgba(0,0,0,.82);z-index:200;
  align-items:center;justify-content:center;backdrop-filter:blur(5px);}
.modal-ov.open{display:flex;}
.modal-box{background:var(--panel);border:1px solid var(--border);border-radius:12px;
  width:420px;max-width:92vw;max-height:82vh;overflow-y:auto;
  animation:invPop .28s cubic-bezier(.34,1.56,.64,1) both;}
.modal-hdr{padding:13px 17px;border-bottom:1px solid var(--border);
  display:flex;align-items:center;justify-content:space-between;
  position:sticky;top:0;background:var(--panel);z-index:2;}
.modal-ttl{font-family:'Orbitron',sans-serif;font-size:.7rem;font-weight:700;letter-spacing:.13em;}
.modal-x{background:transparent;border:none;color:var(--muted);font-size:.95rem;cursor:pointer;transition:color .2s;}
.modal-x:hover{color:var(--text);}
.modal-body{padding:17px;}
.m-inp{width:100%;background:var(--panel2);border:1px solid var(--border);border-radius:6px;
  color:var(--text);font-family:'Outfit',sans-serif;font-size:.88rem;font-weight:600;
  padding:9px 12px;outline:none;margin-bottom:9px;letter-spacing:.06em;}
.m-inp:focus{border-color:var(--muted);}
.m-btn{width:100%;padding:9px;font-family:'Orbitron',sans-serif;font-size:.66rem;font-weight:700;
  letter-spacing:.12em;cursor:pointer;border:none;border-radius:6px;
  background:linear-gradient(135deg,#fbbf24,#f97316);color:#060810;margin-bottom:7px;}
.m-btn.danger{background:linear-gradient(135deg,#f43f5e,#dc2626);}
.m-btn.sec{background:transparent;border:1px solid var(--border);color:var(--muted);}
.m-btn.sec:hover{border-color:var(--muted);color:var(--text);}
.m-err{color:#f43f5e;font-size:.68rem;font-weight:600;margin-bottom:8px;display:none;}
.m-lbl{font-size:.54rem;letter-spacing:.12em;text-transform:uppercase;color:var(--muted);margin-bottom:5px;}
.m-row{display:flex;gap:7px;margin-bottom:7px;}
.adm-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:11px;}
.adm-stat{background:var(--panel2);border:1px solid var(--border);border-radius:6px;padding:9px 11px;}
.adm-sl{font-size:.5rem;letter-spacing:.1em;text-transform:uppercase;color:var(--muted);margin-bottom:3px;}
.adm-sv{font-family:'Orbitron',sans-serif;font-size:.92rem;font-weight:700;}
.adm-sec{font-family:'Orbitron',sans-serif;font-size:.54rem;letter-spacing:.15em;text-transform:uppercase;color:var(--muted);margin:11px 0 6px;}
.adm-row{display:flex;align-items:center;gap:6px;padding:5px 8px;background:var(--panel2);border-radius:4px;margin-bottom:4px;font-size:.76rem;}
.adm-name{flex:1;font-weight:600;}
.adm-coins{color:#fbbf24;font-family:'Orbitron',sans-serif;font-size:.66rem;font-weight:700;min-width:54px;text-align:right;}
.adm-del{background:transparent;border:1px solid #f43f5e44;border-radius:3px;color:#f43f5e;font-size:.54rem;padding:2px 5px;cursor:pointer;font-family:'Orbitron',sans-serif;}

/* NOTIF */
.notif{position:fixed;bottom:18px;right:18px;z-index:300;padding:8px 15px;border-radius:5px;
  font-family:'Orbitron',sans-serif;font-size:.58rem;font-weight:700;letter-spacing:.1em;
  transform:translateY(70px);opacity:0;transition:all .32s cubic-bezier(.34,1.56,.64,1);}
.notif.show{transform:translateY(0);opacity:1;}
.notif.ok{background:#4ade8020;border:1px solid #4ade8060;color:#4ade80;}
.notif.err{background:#f43f5e20;border:1px solid #f43f5e60;color:#f43f5e;}

/* ══════════════════════════════════════════════════════
   USERNAME / LOGIN SCREEN
══════════════════════════════════════════════════════ */
#un-screen{position:fixed;inset:0;z-index:999;background:var(--bg);
  display:flex;align-items:center;justify-content:center;flex-direction:column;}
#un-screen::before{content:'';position:absolute;inset:0;pointer-events:none;
  background:
    radial-gradient(ellipse 70% 60% at 30% 35%,rgba(139,92,246,.12) 0%,transparent 60%),
    radial-gradient(ellipse 60% 50% at 75% 65%,rgba(240,180,41,.10) 0%,transparent 60%),
    radial-gradient(ellipse 40% 30% at 55% 20%,rgba(244,63,94,.08) 0%,transparent 60%);}
.un-box{background:rgba(11,14,28,.85);border:1px solid var(--border2);border-radius:20px;
  padding:52px 48px;width:420px;text-align:center;position:relative;z-index:1;
  backdrop-filter:blur(20px);
  box-shadow:0 0 0 1px rgba(255,255,255,.04) inset, 0 32px 80px rgba(0,0,0,.6), 0 0 60px rgba(139,92,246,.08);}
.un-logo{font-family:'Orbitron',sans-serif;font-size:1.8rem;font-weight:900;letter-spacing:.18em;
  background:linear-gradient(135deg,#f0b429 0%,#fb923c 45%,#f43f5e 100%);
  -webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;
  margin-bottom:6px;display:flex;align-items:center;justify-content:center;gap:12px;}
.un-logo-hex{-webkit-text-fill-color:#f0b42980;opacity:.6;}
.un-sub{font-size:.78rem;color:var(--muted2);letter-spacing:.06em;margin-bottom:38px;font-weight:400;}
.un-label{font-size:.58rem;letter-spacing:.18em;text-transform:uppercase;color:var(--muted2);text-align:left;margin-bottom:8px;font-family:'Orbitron',sans-serif;}
.un-input{width:100%;background:rgba(255,255,255,.04);border:1px solid var(--border2);border-radius:10px;
  color:var(--text);font-family:'Outfit',sans-serif;font-size:1.05rem;font-weight:600;
  padding:13px 16px;outline:none;margin-bottom:6px;letter-spacing:.06em;text-align:center;
  transition:border-color .2s,box-shadow .2s;}
.un-input:focus{border-color:rgba(240,180,41,.4);box-shadow:0 0 0 3px rgba(240,180,41,.08);}
.un-hint{font-size:.62rem;color:var(--muted);margin-bottom:20px;letter-spacing:.04em;}
.un-err{color:#f43f5e;font-size:.7rem;font-weight:600;margin-bottom:10px;display:none;}
.un-btn{width:100%;padding:14px;font-family:'Orbitron',sans-serif;font-size:.76rem;font-weight:700;
  letter-spacing:.16em;cursor:pointer;border:none;border-radius:10px;
  background:linear-gradient(135deg,#f0b429,#f97316,#f43f5e);color:#060810;
  transition:opacity .15s,transform .12s,box-shadow .2s;
  box-shadow:0 4px 20px rgba(240,180,41,.3);}
.un-btn:hover{opacity:.9;box-shadow:0 6px 28px rgba(240,180,41,.4);}
.un-btn:active{transform:scale(.97);}

/* ══════════════════════════════════════════════════════
   HEADER
══════════════════════════════════════════════════════ */
header{grid-column:1/-1;background:rgba(11,14,28,.92);border-bottom:1px solid var(--border);
  display:flex;align-items:center;justify-content:space-between;padding:0 20px;height:60px;gap:12px;
  backdrop-filter:blur(12px);position:relative;z-index:100;}
header::after{content:'';position:absolute;bottom:0;left:0;right:0;height:1px;
  background:linear-gradient(90deg,transparent,rgba(240,180,41,.2),rgba(244,63,94,.15),transparent);}

.logo{font-family:'Orbitron',sans-serif;font-size:.9rem;font-weight:900;letter-spacing:.18em;flex-shrink:0;
  background:linear-gradient(90deg,#f0b429,#fb923c,#f43f5e);
  -webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;
  display:flex;align-items:center;gap:10px;}
.logo-hex{display:inline-flex;align-items:center;justify-content:center;
  width:28px;height:28px;background:linear-gradient(135deg,rgba(240,180,41,.2),rgba(244,63,94,.15));
  border:1px solid rgba(240,180,41,.3);border-radius:6px;-webkit-text-fill-color:#f0b429;
  font-size:.85rem;}

.hstats{display:flex;gap:6px;align-items:center;flex-wrap:nowrap;}
.hstat{text-align:right;white-space:nowrap;padding:4px 10px;border-radius:8px;
  background:rgba(255,255,255,.03);border:1px solid var(--border);}
.hstat-lbl{font-size:.48rem;letter-spacing:.14em;text-transform:uppercase;color:var(--muted);margin-bottom:2px;font-family:'Orbitron',sans-serif;}
.hstat-val{font-family:'Space Mono',monospace;font-size:.78rem;font-weight:700;transition:color .3s;}

.coin-pill{display:flex;align-items:center;gap:6px;
  background:rgba(240,180,41,.08);border:1px solid rgba(240,180,41,.22);
  border-radius:20px;padding:5px 12px;
  box-shadow:0 0 14px rgba(240,180,41,.06) inset;}
.coin-val{font-family:'Space Mono',monospace;font-size:.88rem;font-weight:700;color:var(--gold);}

.boost-pill{display:none;align-items:center;gap:5px;padding:4px 11px;border-radius:20px;
  background:rgba(139,92,246,.08);border:1px solid rgba(139,92,246,.25);}
.boost-pill.on{display:flex;}
.boost-txt{font-family:'Orbitron',sans-serif;font-size:.54rem;font-weight:700;color:#a78bfa;white-space:nowrap;}
.boost-timer{font-size:.58rem;color:var(--muted2);white-space:nowrap;}

.bg-indicator{display:none;align-items:center;gap:5px;padding:4px 11px;border-radius:20px;
  background:rgba(34,211,238,.07);border:1px solid rgba(34,211,238,.22);}
.bg-indicator.on{display:flex;}
.bg-txt{font-family:'Orbitron',sans-serif;font-size:.54rem;font-weight:700;color:#22d3ee;
  white-space:nowrap;animation:bgPulse 1.6s ease-in-out infinite;}
@keyframes bgPulse{0%,100%{opacity:1;}50%{opacity:.4;}}

.hdr-acts{display:flex;gap:5px;flex-shrink:0;}
.hdr-btn{padding:5px 11px;font-family:'Orbitron',sans-serif;font-size:.5rem;font-weight:700;
  letter-spacing:.08em;cursor:pointer;border:1px solid var(--border);border-radius:8px;
  background:rgba(255,255,255,.03);color:var(--muted2);transition:all .18s;white-space:nowrap;}
.hdr-btn:hover{border-color:var(--border2);color:var(--text);background:rgba(255,255,255,.06);}
.hdr-btn.save{border-color:rgba(74,222,128,.25);color:#4ade80;background:rgba(74,222,128,.05);}
.hdr-btn.save:hover{background:rgba(74,222,128,.10);}
.hdr-btn.reset{border-color:rgba(244,63,94,.22);color:#f43f5e;background:rgba(244,63,94,.05);}
.hdr-btn.reset:hover{background:rgba(244,63,94,.10);}
.hdr-btn.admin{border-color:rgba(139,92,246,.25);color:#a78bfa;background:rgba(139,92,246,.05);}

/* ══════════════════════════════════════════════════════
   LEFT PANEL
══════════════════════════════════════════════════════ */
.left-panel{grid-column:1;grid-row:2;background:var(--panel);
  border-right:1px solid var(--border);
  display:flex;flex-direction:column;overflow:hidden;position:relative;z-index:10;}
.left-panel::before{content:'';position:absolute;inset:0;pointer-events:none;
  background:radial-gradient(ellipse 80% 40% at 50% 0%, rgba(240,180,41,.04) 0%,transparent 70%);}

.sec-head{padding:9px 16px 8px;font-family:'Orbitron',sans-serif;font-size:.5rem;letter-spacing:.2em;
  text-transform:uppercase;color:var(--muted);border-bottom:1px solid var(--border);flex-shrink:0;
  display:flex;justify-content:space-between;align-items:center;}

/* Rarity table */
.rar-table{flex-shrink:0;overflow-y:auto;max-height:264px;}
.rar-row{display:grid;grid-template-columns:76px 50px 58px 1fr 26px;align-items:center;gap:4px;
  padding:5px 16px;border-bottom:1px solid rgba(26,32,64,.5);
  transition:background .15s;}
.rar-row:hover{background:rgba(255,255,255,.02);}
.rar-name{font-weight:700;font-size:.76rem;}
.rar-pct{font-family:'Space Mono',monospace;font-size:.58rem;color:var(--muted2);font-weight:400;text-align:right;}
.rar-1in{font-size:.56rem;text-align:right;white-space:nowrap;opacity:.7;}
.bar-bg{height:3px;background:rgba(255,255,255,.04);border-radius:4px;overflow:hidden;}
.bar-fill{height:100%;border-radius:4px;transition:width .4s ease;}
.rar-cnt{font-family:'Space Mono',monospace;font-size:.56rem;font-weight:700;text-align:right;color:var(--muted);transition:color .3s;}

/* Controls */
.controls{padding:12px 16px;border-bottom:1px solid var(--border);flex-shrink:0;
  display:flex;flex-direction:column;gap:8px;}
.roll-btn{width:100%;padding:12px;font-family:'Orbitron',sans-serif;font-size:.72rem;font-weight:700;
  letter-spacing:.14em;cursor:pointer;border:none;border-radius:10px;
  background:linear-gradient(135deg,#f0b429,#f97316,#f43f5e);color:#060810;
  transition:opacity .15s,transform .1s,box-shadow .2s;text-transform:uppercase;
  box-shadow:0 4px 18px rgba(240,180,41,.25),0 0 0 0 rgba(240,180,41,.3);}
.roll-btn:hover:not(:disabled){opacity:.9;box-shadow:0 6px 26px rgba(240,180,41,.35);}
.roll-btn:active:not(:disabled){transform:scale(.97);}
.roll-btn:disabled{opacity:.25;cursor:not-allowed;box-shadow:none;}

.auto-row{display:flex;gap:6px;}
.auto-btn{flex:1;padding:9px;font-family:'Orbitron',sans-serif;font-size:.56rem;font-weight:700;
  letter-spacing:.07em;cursor:pointer;border:1px solid var(--border2);border-radius:8px;
  background:rgba(255,255,255,.03);color:var(--muted2);transition:all .2s;text-transform:uppercase;}
.auto-btn:hover{border-color:var(--muted);color:var(--text);}
.auto-btn.active{background:rgba(244,63,94,.08);border-color:rgba(244,63,94,.4);color:#f43f5e;
  box-shadow:0 0 12px rgba(244,63,94,.1) inset;}

.prog-wrap{height:2px;background:rgba(255,255,255,.04);overflow:hidden;opacity:0;transition:opacity .2s;flex-shrink:0;}
.prog-wrap.vis{opacity:1;}
.prog-fill{height:100%;background:linear-gradient(90deg,#f0b429,#f43f5e);}
.bg-badge{font-family:'Orbitron',sans-serif;font-size:.48rem;color:#22d3ee;
  padding:4px 16px;text-align:center;background:rgba(34,211,238,.04);
  border-top:1px solid rgba(34,211,238,.1);display:none;letter-spacing:.08em;}
.bg-badge.on{display:block;}

/* History */
.hist-wrap{flex:1;display:flex;flex-direction:column;overflow:hidden;min-height:0;}
.hist-list{flex:1;overflow-y:auto;scrollbar-width:none;}
.hist-item{display:grid;grid-template-columns:22px 1fr auto;align-items:center;gap:8px;
  padding:5px 16px;border-bottom:1px solid rgba(26,32,64,.4);
  opacity:0;transform:translateX(-8px);animation:slideIn .22s ease forwards;font-size:.78rem;}
@keyframes slideIn{to{opacity:1;transform:translateX(0);}}
.hi-em{text-align:center;font-size:.9rem;}
.hi-name{font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.hi-tag{font-size:.56rem;font-weight:700;letter-spacing:.07em;text-transform:uppercase;white-space:nowrap;font-family:'Orbitron',sans-serif;}

/* ══════════════════════════════════════════════════════
   RIGHT PANEL
══════════════════════════════════════════════════════ */
.right-panel{grid-column:2;grid-row:2;display:flex;flex-direction:column;overflow:hidden;
  background:var(--bg);position:relative;}
/* Star field */
.right-panel::before{content:'';position:absolute;inset:0;pointer-events:none;z-index:0;
  background-image:
    radial-gradient(1px 1px at 12% 22%, rgba(255,255,255,.35) 0%, transparent 100%),
    radial-gradient(1px 1px at 34% 67%, rgba(255,255,255,.25) 0%, transparent 100%),
    radial-gradient(1.5px 1.5px at 56% 14%, rgba(255,255,255,.4) 0%, transparent 100%),
    radial-gradient(1px 1px at 78% 41%, rgba(255,255,255,.3) 0%, transparent 100%),
    radial-gradient(1px 1px at 91% 78%, rgba(255,255,255,.2) 0%, transparent 100%),
    radial-gradient(1px 1px at 23% 88%, rgba(255,255,255,.25) 0%, transparent 100%),
    radial-gradient(1.5px 1.5px at 67% 92%, rgba(255,255,255,.3) 0%, transparent 100%),
    radial-gradient(1px 1px at 44% 44%, rgba(255,255,255,.2) 0%, transparent 100%),
    radial-gradient(1px 1px at 88% 18%, rgba(255,255,255,.35) 0%, transparent 100%),
    radial-gradient(1px 1px at 5% 55%, rgba(255,255,255,.2) 0%, transparent 100%);
}

/* ══════════════════════════════════════════════════════
   TABS
══════════════════════════════════════════════════════ */
.tabs{display:flex;border-bottom:1px solid var(--border);
  background:rgba(11,14,28,.95);flex-shrink:0;position:relative;z-index:5;
  padding:0 8px;gap:2px;align-items:center;}
.tab-btn{padding:0 14px;height:44px;font-family:'Orbitron',sans-serif;font-size:.54rem;font-weight:700;
  letter-spacing:.1em;text-transform:uppercase;background:transparent;border:none;
  color:var(--muted);cursor:pointer;position:relative;
  transition:color .18s;display:flex;align-items:center;gap:5px;white-space:nowrap;}
.tab-btn::after{content:'';position:absolute;bottom:0;left:12px;right:12px;height:2px;
  border-radius:2px 2px 0 0;background:transparent;transition:background .18s,opacity .18s;}
.tab-btn:hover{color:var(--text);}
.tab-btn.active{color:var(--gold);}
.tab-btn.active::after{background:linear-gradient(90deg,#f0b429,#fb923c);}
.tab-badge{background:var(--border);color:var(--muted);font-size:.52rem;padding:1px 5px;
  border-radius:10px;font-family:'Outfit',sans-serif;font-weight:700;transition:all .2s;}
.tab-btn.active .tab-badge{background:rgba(240,180,41,.2);color:var(--gold);}

/* TAB VIEWS */
.tab-view{flex:1;overflow:hidden;display:none;position:relative;z-index:1;}
.tab-view.active{display:flex;}
#view-roll{align-items:center;justify-content:center;flex-direction:column;gap:18px;}

/* ══════════════════════════════════════════════════════
   ROLL VIEW
══════════════════════════════════════════════════════ */
#flash{position:absolute;inset:0;pointer-events:none;opacity:0;z-index:10;}
#toast{position:absolute;top:14px;left:50%;transform:translateX(-50%) translateY(-80px);
  background:linear-gradient(135deg,#f0b429,#f43f5e);color:#060810;
  font-family:'Orbitron',sans-serif;font-size:.54rem;font-weight:700;letter-spacing:.18em;
  padding:6px 16px;border-radius:20px;z-index:20;pointer-events:none;
  transition:transform .42s cubic-bezier(.34,1.56,.64,1);white-space:nowrap;
  box-shadow:0 4px 16px rgba(240,180,41,.35);}
#toast.show{transform:translateX(-50%) translateY(0);}
#coin-pop{position:absolute;top:52px;left:50%;transform:translateX(-50%) translateY(18px);
  font-family:'Space Mono',monospace;font-size:.78rem;font-weight:700;color:var(--gold);
  z-index:20;pointer-events:none;opacity:0;text-shadow:0 0 12px rgba(240,180,41,.6);}
#coin-pop.show{animation:coinPop .9s ease forwards;}
@keyframes coinPop{0%{opacity:0;transform:translateX(-50%) translateY(18px);}
  20%{opacity:1;transform:translateX(-50%) translateY(-7px);}
  80%{opacity:1;transform:translateX(-50%) translateY(-12px);}
  100%{opacity:0;transform:translateX(-50%) translateY(-30px);}}

/* Cinematic */
#cinematic{position:absolute;inset:0;z-index:50;pointer-events:none;
  display:flex;align-items:center;justify-content:center;opacity:0;}
#cinematic.active{pointer-events:all;}
#cin-bg{position:absolute;inset:0;opacity:0;transition:opacity .5s;}
#cinematic.active #cin-bg{opacity:1;}
#cin-canvas{position:absolute;inset:0;pointer-events:none;}
#cin-card{position:relative;z-index:5;width:295px;border-radius:18px;overflow:hidden;
  transform:scale(0) rotateY(180deg);opacity:0;}
#cin-card.reveal{animation:cinReveal 1s cubic-bezier(.34,1.56,.64,1) .3s forwards;}
@keyframes cinReveal{0%{transform:scale(0) rotateY(180deg);opacity:0;}40%{opacity:1;}70%{transform:scale(1.08) rotateY(-4deg);}100%{transform:scale(1) rotateY(0deg);opacity:1;}}
#cin-card .card-body{padding:28px 22px 22px;gap:10px;}
#cin-card .card-icon{font-size:4.5rem;}
#cin-label{position:absolute;bottom:56px;left:50%;transform:translateX(-50%);
  font-family:'Orbitron',sans-serif;font-size:.54rem;letter-spacing:.28em;text-transform:uppercase;
  color:rgba(255,255,255,.28);opacity:0;white-space:nowrap;z-index:6;}
#cin-label.show{animation:fadeInUp .6s ease .8s forwards;}
@keyframes fadeInUp{from{opacity:0;transform:translateX(-50%) translateY(9px);}to{opacity:1;transform:translateX(-50%) translateY(0);}}
#cin-skip{position:absolute;bottom:16px;right:20px;
  background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.08);
  color:rgba(255,255,255,.28);font-family:'Orbitron',sans-serif;font-size:.48rem;letter-spacing:.12em;
  padding:5px 11px;border-radius:6px;cursor:pointer;opacity:0;z-index:20;transition:opacity .3s;}
#cin-skip.vis{opacity:1;} #cin-skip:hover{color:rgba(255,255,255,.65);}

/* Cards */
.idle-msg{font-family:'Orbitron',sans-serif;font-size:.62rem;letter-spacing:.24em;
  color:var(--muted);opacity:.6;}
.card-wrap{position:relative;}
.card{width:252px;background:var(--panel2);border-radius:14px;overflow:hidden;
  position:relative;transform:scale(.2) rotateX(50deg);opacity:0;
  box-shadow:0 8px 32px rgba(0,0,0,.5);}
.card.show{animation:cardPop .5s cubic-bezier(.34,1.56,.64,1) forwards;}
@keyframes cardPop{0%{transform:scale(.2) rotateX(50deg);opacity:0;}55%{transform:scale(1.05) rotateX(-2deg);opacity:1;}100%{transform:scale(1) rotateX(0deg);opacity:1;}}
.card-top-bar{height:4px;width:100%;}
.card-body{padding:20px 18px 16px;display:flex;flex-direction:column;align-items:center;gap:7px;}
.card-icon{font-size:3.2rem;line-height:1;filter:drop-shadow(0 0 16px var(--c,#fff));animation:float 3.2s ease-in-out infinite;}
@keyframes float{0%,100%{transform:translateY(0);}50%{transform:translateY(-7px);}}
.card-rar{font-family:'Orbitron',sans-serif;font-size:.52rem;letter-spacing:.24em;font-weight:700;text-transform:uppercase;}
.card-name{font-family:'Orbitron',sans-serif;font-size:.88rem;font-weight:700;text-align:center;letter-spacing:.04em;line-height:1.3;}
.card-sep{width:28px;height:1px;opacity:.2;}
.card-odds{display:flex;gap:18px;text-align:center;}
.odds-col{display:flex;flex-direction:column;gap:2px;}
.odds-key{font-size:.48rem;letter-spacing:.1em;text-transform:uppercase;color:var(--muted);}
.odds-val{font-family:'Space Mono',monospace;font-size:.76rem;font-weight:700;}
.card-ring{position:absolute;inset:0;border-radius:14px;pointer-events:none;}
.card-coin{font-family:'Space Mono',monospace;font-size:.64rem;font-weight:700;color:var(--gold);
  text-align:center;opacity:0;animation:rewardFade 1.6s ease .6s forwards;}
@keyframes rewardFade{0%{opacity:0;transform:translateY(5px);}30%{opacity:1;transform:translateY(0);}80%{opacity:1;}100%{opacity:0;}}
.pcvs{position:absolute;inset:-120px;pointer-events:none;overflow:visible;z-index:3;}
.p{position:absolute;border-radius:50%;top:50%;left:50%;opacity:0;}
@keyframes pBurst{0%{opacity:1;transform:translate(-50%,-50%) rotate(var(--a)) translateX(0) scale(1);}100%{opacity:0;transform:translate(-50%,-50%) rotate(var(--a)) translateX(var(--d)) scale(0);}}
.shock{position:absolute;width:10px;height:10px;border-radius:50%;top:50%;left:50%;
  transform:translate(-50%,-50%) scale(0);opacity:0;pointer-events:none;z-index:1;}
.roll-lbl{font-family:'Space Mono',monospace;font-size:.6rem;letter-spacing:.14em;color:var(--muted);text-transform:uppercase;}

/* ══════════════════════════════════════════════════════
   INVENTORY
══════════════════════════════════════════════════════ */
#view-inv{flex-direction:column;overflow:hidden;}
.inv-toolbar{display:flex;align-items:center;gap:5px;padding:9px 16px;
  border-bottom:1px solid var(--border);background:var(--panel);flex-shrink:0;flex-wrap:wrap;}
.inv-filt{padding:3px 9px;font-family:'Orbitron',sans-serif;font-size:.48rem;font-weight:700;
  letter-spacing:.08em;text-transform:uppercase;border:1px solid var(--border);border-radius:20px;
  background:transparent;color:var(--muted);cursor:pointer;transition:all .14s;white-space:nowrap;}
.inv-filt:hover{border-color:var(--muted2);color:var(--text);}
.inv-filt.on{color:#060810!important;border-color:transparent!important;}
.inv-sort{margin-left:auto;background:rgba(255,255,255,.04);border:1px solid var(--border2);border-radius:8px;
  color:var(--text);font-family:'Outfit',sans-serif;font-size:.76rem;font-weight:600;
  padding:4px 8px;cursor:pointer;outline:none;}
.inv-sum{padding:5px 16px;font-size:.65rem;color:var(--muted);letter-spacing:.05em;
  border-bottom:1px solid var(--border);flex-shrink:0;display:flex;gap:10px;align-items:center;flex-wrap:wrap;}
.i-dot{width:5px;height:5px;border-radius:50%;flex-shrink:0;display:inline-block;}
.inv-grid{flex:1;overflow-y:auto;padding:14px 16px;display:grid;
  grid-template-columns:repeat(auto-fill,minmax(108px,1fr));gap:9px;
  align-content:start;scrollbar-width:thin;scrollbar-color:var(--border) transparent;}
.inv-empty{grid-column:1/-1;text-align:center;padding:50px 20px;color:var(--muted);}
.inv-empty-icon{font-size:2rem;margin-bottom:10px;opacity:.22;}
.inv-empty-txt{font-family:'Orbitron',sans-serif;font-size:.56rem;letter-spacing:.18em;}
.inv-item{background:var(--panel2);border-radius:10px;overflow:hidden;position:relative;cursor:pointer;
  transition:transform .14s,box-shadow .14s;border:1px solid var(--border);
  animation:invPop .28s cubic-bezier(.34,1.56,.64,1) both;}
@keyframes invPop{from{opacity:0;transform:scale(.7);}to{opacity:1;transform:scale(1);}}
.inv-item:hover{transform:translateY(-3px) scale(1.03);box-shadow:0 8px 20px rgba(0,0,0,.35);}
.inv-item-bar{height:3px;width:100%;}
.inv-item-body{padding:9px 7px 8px;display:flex;flex-direction:column;align-items:center;gap:4px;text-align:center;}
.inv-em{font-size:1.8rem;line-height:1;}
.inv-iname{font-size:.63rem;font-weight:700;line-height:1.2;color:var(--text);}
.inv-itar{font-family:'Orbitron',sans-serif;font-size:.42rem;font-weight:700;letter-spacing:.08em;text-transform:uppercase;}
.inv-cnt{position:absolute;top:4px;right:4px;background:rgba(6,8,16,.7);
  border:1px solid rgba(255,255,255,.08);border-radius:9px;font-family:'Space Mono',monospace;
  font-size:.5rem;font-weight:700;padding:1px 4px;color:var(--text);min-width:18px;text-align:center;}
.inv-new{position:absolute;top:4px;left:4px;
  background:linear-gradient(135deg,#f0b429,#f43f5e);color:#060810;
  font-family:'Orbitron',sans-serif;font-size:.4rem;font-weight:700;
  padding:1px 4px;border-radius:3px;animation:newPulse 1s ease-in-out 3;}
@keyframes newPulse{0%,100%{opacity:1;}50%{opacity:.35;}}
.det-overlay{display:none;position:absolute;inset:0;background:rgba(6,8,16,.92);z-index:20;
  align-items:center;justify-content:center;backdrop-filter:blur(6px);}
.det-overlay.open{display:flex;}
.det-card{background:var(--panel2);border:1px solid var(--border2);border-radius:16px;overflow:hidden;width:268px;position:relative;
  animation:invPop .28s cubic-bezier(.34,1.56,.64,1) both;box-shadow:0 12px 40px rgba(0,0,0,.6);}
.det-bar{height:5px;} .det-body{padding:24px 20px 20px;display:flex;flex-direction:column;align-items:center;gap:9px;text-align:center;}
.det-icon{font-size:3.4rem;line-height:1;} .det-rar{font-family:'Orbitron',sans-serif;font-size:.54rem;letter-spacing:.18em;font-weight:700;text-transform:uppercase;}
.det-name{font-family:'Orbitron',sans-serif;font-size:.9rem;font-weight:700;}
.det-sep{width:28px;height:1px;opacity:.2;}
.det-stats{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;width:100%;}
.det-stat{display:flex;flex-direction:column;gap:3px;align-items:center;
  background:rgba(255,255,255,.03);border-radius:8px;padding:8px 4px;}
.det-sk{font-size:.46rem;letter-spacing:.1em;text-transform:uppercase;color:var(--muted);font-family:'Orbitron',sans-serif;}
.det-sv{font-family:'Space Mono',monospace;font-size:.78rem;font-weight:700;}
.det-close{position:absolute;top:8px;right:10px;background:transparent;border:none;color:var(--muted);font-size:1rem;cursor:pointer;transition:color .2s;}
.det-close:hover{color:var(--text);} .det-ring{position:absolute;inset:0;border-radius:16px;pointer-events:none;}

/* ══════════════════════════════════════════════════════
   ACHIEVEMENTS
══════════════════════════════════════════════════════ */
#view-ach{flex-direction:column;overflow:hidden;}
.ach-hdr{padding:12px 20px 10px;border-bottom:1px solid var(--border);background:var(--panel);
  flex-shrink:0;display:flex;align-items:center;justify-content:space-between;}
.ach-title{font-family:'Orbitron',sans-serif;font-size:.72rem;font-weight:700;letter-spacing:.14em;}
.ach-sub{font-size:.65rem;color:var(--muted2);}
.ach-progress-bar{height:3px;background:rgba(255,255,255,.04);margin:0;flex-shrink:0;}
.ach-progress-fill{height:100%;background:linear-gradient(90deg,#f0b429,#f43f5e,#8b5cf6);
  transition:width .6s cubic-bezier(.25,.8,.25,1);}
.ach-body{flex:1;overflow-y:auto;padding:16px 18px;scrollbar-width:thin;scrollbar-color:var(--border) transparent;}
.ach-section-title{font-family:'Orbitron',sans-serif;font-size:.54rem;letter-spacing:.2em;text-transform:uppercase;
  color:var(--muted);padding:0 0 10px;border-bottom:1px solid var(--border);margin-bottom:12px;margin-top:20px;}
.ach-section-title:first-child{margin-top:0;}
.ach-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(178px,1fr));gap:10px;margin-bottom:6px;}
.ach-card{background:var(--panel2);border:1px solid var(--border);border-radius:12px;
  padding:14px 14px 12px;display:flex;flex-direction:column;gap:6px;position:relative;
  transition:border-color .2s,transform .15s;}
.ach-card.unlocked{border-color:rgba(240,180,41,.3);background:rgba(240,180,41,.04);
  box-shadow:0 0 18px rgba(240,180,41,.06) inset;}
.ach-card.unlocked:hover{transform:translateY(-2px);}
.ach-card.locked{opacity:.42;}
.ach-icon{font-size:1.55rem;line-height:1;}
.ach-name{font-family:'Orbitron',sans-serif;font-size:.6rem;font-weight:700;letter-spacing:.04em;}
.ach-desc{font-size:.66rem;color:var(--muted2);line-height:1.45;}
.ach-reward{font-size:.58rem;font-weight:700;color:var(--gold);font-family:'Space Mono',monospace;}
.ach-check{position:absolute;top:10px;right:11px;font-size:.88rem;}
.ach-prog{width:100%;height:3px;background:rgba(255,255,255,.06);border-radius:2px;margin-top:3px;}
.ach-prog-fill{height:100%;background:linear-gradient(90deg,#8b5cf6,#c084fc);border-radius:2px;transition:width .4s;}
.ach-prog-txt{font-size:.54rem;color:var(--muted);margin-top:3px;font-family:'Space Mono',monospace;}

/* ── UPGRADE TREE ── */
.tree-row{display:flex;align-items:stretch;gap:0;overflow-x:auto;padding-bottom:4px;scrollbar-width:none;}
.tree-row::-webkit-scrollbar{display:none;}
.tree-node{background:var(--panel2);border:1px solid var(--border);border-radius:10px;
  padding:11px 10px 10px;display:flex;flex-direction:column;align-items:center;text-align:center;
  min-width:108px;max-width:130px;flex:1;transition:border-color .2s,transform .15s,box-shadow .2s;}
.tree-node:hover{transform:translateY(-2px);box-shadow:0 6px 18px rgba(0,0,0,.3);}
.tree-node-empty{min-width:108px;max-width:130px;flex:1;}
.tree-arrow{display:flex;align-items:center;justify-content:center;padding:0 5px;
  font-size:1.1rem;font-weight:700;flex-shrink:0;align-self:center;transition:color .2s;}

/* ══════════════════════════════════════════════════════
   UPGRADES / SHOP
══════════════════════════════════════════════════════ */
#view-shop{flex-direction:column;overflow:hidden;}
.shop-hdr{padding:12px 20px;border-bottom:1px solid var(--border);background:var(--panel);
  flex-shrink:0;display:flex;align-items:center;justify-content:space-between;}
.shop-title-grp{display:flex;flex-direction:column;gap:2px;}
.shop-title{font-family:'Orbitron',sans-serif;font-size:.68rem;font-weight:700;letter-spacing:.14em;}
.shop-sub{font-size:.68rem;color:var(--muted2);}
.shop-bal{display:flex;align-items:center;gap:6px;font-family:'Space Mono',monospace;font-size:.82rem;font-weight:700;color:var(--gold);}
.shop-body{flex:1;overflow-y:auto;padding:18px;scrollbar-width:thin;scrollbar-color:var(--border) transparent;}
.shop-section{margin-bottom:24px;}
.shop-sec-title{font-family:'Orbitron',sans-serif;font-size:.58rem;letter-spacing:.2em;text-transform:uppercase;
  color:var(--muted);padding:0 0 10px;border-bottom:1px solid var(--border);margin-bottom:13px;
  display:flex;align-items:center;gap:8px;}
.boost-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:10px;}
.boost-card{background:var(--panel2);border:1px solid var(--border);border-radius:12px;
  overflow:hidden;display:flex;flex-direction:column;transition:border-color .2s,transform .15s,box-shadow .2s;}
.boost-card:hover{transform:translateY(-2px);box-shadow:0 6px 20px rgba(0,0,0,.3);}
.boost-card.active-boost{border-color:rgba(74,222,128,.3);background:rgba(74,222,128,.03);}
.boost-card.cant-afford{opacity:.4;}
.boost-top{padding:16px 14px 10px;display:flex;flex-direction:column;align-items:center;gap:7px;flex:1;}
.boost-icon{font-size:1.8rem;line-height:1;}
.boost-name{font-family:'Orbitron',sans-serif;font-size:.64rem;font-weight:700;text-align:center;letter-spacing:.04em;}
.boost-desc{font-size:.68rem;color:var(--muted2);text-align:center;line-height:1.45;}
.boost-duration{font-size:.6rem;font-weight:700;color:var(--text);text-align:center;letter-spacing:.04em;}
.boost-timer-disp{font-family:'Space Mono',monospace;font-size:.6rem;font-weight:700;color:#4ade80;text-align:center;}
.boost-effect{font-size:.62rem;font-weight:700;text-align:center;}
.boost-bottom{padding:9px 14px 12px;border-top:1px solid var(--border);
  display:flex;align-items:center;justify-content:space-between;gap:8px;}
.boost-price{display:flex;align-items:center;gap:4px;font-family:'Space Mono',monospace;font-size:.7rem;font-weight:700;color:var(--gold);}
.boost-btn{padding:6px 13px;font-family:'Orbitron',sans-serif;font-size:.56rem;font-weight:700;
  letter-spacing:.08em;cursor:pointer;border:none;border-radius:7px;
  background:linear-gradient(135deg,#f0b429,#f97316);color:#060810;
  transition:opacity .15s,box-shadow .15s;white-space:nowrap;
  box-shadow:0 2px 10px rgba(240,180,41,.2);}
.boost-btn:hover{opacity:.88;box-shadow:0 4px 14px rgba(240,180,41,.3);}
.boost-btn:disabled{opacity:.28;cursor:not-allowed;box-shadow:none;}
.boost-btn.active-btn{background:rgba(74,222,128,.12);color:#4ade80;border:1px solid rgba(74,222,128,.3);cursor:default;box-shadow:none;}

/* ══════════════════════════════════════════════════════
   LEADERBOARD
══════════════════════════════════════════════════════ */
#view-board{flex-direction:column;overflow:hidden;}
.board-hdr{padding:12px 20px 10px;border-bottom:1px solid var(--border);background:var(--panel);
  flex-shrink:0;display:flex;align-items:center;justify-content:space-between;}
.board-title{font-family:'Orbitron',sans-serif;font-size:.72rem;font-weight:700;letter-spacing:.14em;}
.board-sub{font-size:.65rem;color:var(--muted2);}
.board-refresh{padding:5px 11px;font-family:'Orbitron',sans-serif;font-size:.5rem;font-weight:700;
  letter-spacing:.08em;cursor:pointer;border:1px solid var(--border);border-radius:8px;
  background:rgba(255,255,255,.03);color:var(--muted2);transition:all .2s;}
.board-refresh:hover{color:var(--text);border-color:var(--border2);}
.board-body{flex:1;overflow-y:auto;padding:14px 20px;scrollbar-width:thin;scrollbar-color:var(--border) transparent;}
.board-col-head{display:grid;grid-template-columns:36px 1fr 96px 76px 90px;gap:10px;
  padding:3px 14px 8px;font-family:'Orbitron',sans-serif;font-size:.46rem;letter-spacing:.12em;
  text-transform:uppercase;color:var(--muted);}
.board-entry{display:grid;grid-template-columns:36px 1fr 96px 76px 90px;align-items:center;gap:10px;
  padding:9px 14px;border-radius:10px;margin-bottom:6px;background:var(--panel2);
  border:1px solid var(--border);transition:border-color .15s;}
.board-entry:hover{border-color:var(--border2);}
.board-entry.me{border-color:rgba(240,180,41,.3);background:rgba(240,180,41,.03);}
.board-entry.top1{border-color:rgba(240,180,41,.45);background:rgba(240,180,41,.04);}
.board-entry.top2{border-color:rgba(148,163,184,.3);}
.board-entry.top3{border-color:rgba(251,146,60,.3);}
.board-rank{font-family:'Space Mono',monospace;font-size:.78rem;font-weight:700;text-align:center;}
.board-name{font-weight:700;font-size:.84rem;}
.you-tag{font-size:.48rem;color:var(--gold);font-family:'Orbitron',sans-serif;margin-left:5px;letter-spacing:.08em;}
.board-coins{font-family:'Space Mono',monospace;font-size:.72rem;font-weight:700;color:var(--gold);text-align:right;}
.board-rolls{font-family:'Space Mono',monospace;font-size:.68rem;font-weight:700;color:var(--muted2);text-align:right;}
.board-best{font-size:.6rem;font-weight:700;text-align:right;}

/* ══════════════════════════════════════════════════════
   EDITOR
══════════════════════════════════════════════════════ */
.editor-wrap{flex:1;overflow-y:auto;padding:20px;display:flex;flex-direction:column;gap:24px;}
.editor-section{background:var(--panel);border:1px solid var(--border);border-radius:12px;padding:20px;}
.editor-title{font-family:'Orbitron',sans-serif;font-size:1rem;font-weight:700;margin-bottom:16px;letter-spacing:.05em;color:var(--gold);}
.editor-subtitle{font-size:.74rem;color:var(--muted2);margin-bottom:16px;line-height:1.6;}
.editor-list{display:flex;flex-direction:column;gap:10px;margin-bottom:16px;}
.editor-rarity-item{background:var(--panel2);border:1px solid var(--border);border-radius:8px;padding:12px;display:grid;grid-template-columns:auto 1fr auto auto auto;gap:12px;align-items:center;}
.editor-rarity-color{width:32px;height:32px;border-radius:6px;cursor:pointer;border:2px solid var(--border);}
.editor-rarity-info{display:flex;flex-direction:column;gap:4px;}
.editor-rarity-name{font-weight:700;font-size:.84rem;}
.editor-rarity-chance{font-size:.68rem;color:var(--muted2);}
.editor-btn{padding:6px 12px;font-family:'Orbitron',sans-serif;font-size:.58rem;font-weight:700;letter-spacing:.08em;cursor:pointer;border:1px solid var(--border);border-radius:7px;background:rgba(255,255,255,.03);color:var(--text);transition:all .2s;}
.editor-btn:hover{border-color:var(--border2);background:rgba(255,255,255,.06);}
.editor-btn.primary{background:rgba(240,180,41,.12);border-color:rgba(240,180,41,.35);color:var(--gold);}
.editor-btn.danger{border-color:rgba(244,63,94,.3);color:#f43f5e;background:rgba(244,63,94,.05);}
.editor-input{background:rgba(255,255,255,.04);border:1px solid var(--border2);border-radius:8px;padding:8px 10px;color:var(--text);font-family:'Outfit',sans-serif;font-size:.82rem;outline:none;width:100%;transition:border-color .2s;}
.editor-input:focus{border-color:rgba(240,180,41,.4);}
.editor-form{display:flex;flex-direction:column;gap:12px;margin-top:16px;padding-top:16px;border-top:1px solid var(--border);}
.editor-form-group{display:flex;flex-direction:column;gap:6px;}
.editor-label{font-size:.62rem;letter-spacing:.1em;text-transform:uppercase;color:var(--muted2);font-weight:700;font-family:'Orbitron',sans-serif;}
.editor-item-list{display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:12px;margin-bottom:16px;}
.editor-item-card{background:var(--panel2);border:1px solid var(--border);border-radius:8px;padding:12px;display:flex;flex-direction:column;gap:8px;}
.editor-item-preview{display:flex;align-items:center;gap:10px;}
.editor-item-emoji{font-size:2rem;width:48px;height:48px;display:flex;align-items:center;justify-content:center;border-radius:6px;background:var(--panel);}
.editor-item-emoji img{width:100%;height:100%;object-fit:cover;border-radius:6px;}
.editor-item-details{flex:1;}
.editor-item-name{font-weight:700;font-size:.82rem;margin-bottom:2px;}
.editor-item-rarity{font-size:.6rem;text-transform:uppercase;letter-spacing:.08em;}
.editor-item-actions{display:flex;gap:6px;}
.editor-file-input{display:none;}
.editor-upload-btn{padding:8px 12px;background:rgba(255,255,255,.03);border:1px dashed var(--border2);border-radius:7px;cursor:pointer;text-align:center;font-size:.7rem;color:var(--muted2);transition:all .2s;}
.editor-upload-btn:hover{border-color:var(--muted);color:var(--text);}
.editor-color-preview{width:24px;height:24px;border-radius:6px;border:1px solid var(--border);}

.board-loading{text-align:center;padding:40px;color:var(--muted);font-family:'Orbitron',sans-serif;font-size:.58rem;letter-spacing:.18em;}
.board-status{font-size:.6rem;color:var(--muted2);text-align:center;padding:6px;letter-spacing:.06em;display:flex;align-items:center;justify-content:center;gap:6px;}
.board-dot{width:6px;height:6px;border-radius:50%;animation:blink 1.6s ease-in-out infinite;}
@keyframes blink{0%,100%{opacity:.25;}50%{opacity:1;}}

/* ══════════════════════════════════════════════════════
   MODALS
══════════════════════════════════════════════════════ */
.modal-ov{display:none;position:fixed;inset:0;background:rgba(6,8,16,.88);z-index:200;
  align-items:center;justify-content:center;backdrop-filter:blur(8px);}
.modal-ov.open{display:flex;}
.modal-box{background:var(--panel);border:1px solid var(--border2);border-radius:16px;
  width:420px;max-width:92vw;max-height:82vh;overflow-y:auto;
  box-shadow:0 24px 60px rgba(0,0,0,.6),0 0 0 1px rgba(255,255,255,.04) inset;
  animation:invPop .28s cubic-bezier(.34,1.56,.64,1) both;}
.modal-hdr{padding:14px 18px;border-bottom:1px solid var(--border);
  display:flex;align-items:center;justify-content:space-between;
  position:sticky;top:0;background:var(--panel);z-index:2;}
.modal-ttl{font-family:'Orbitron',sans-serif;font-size:.68rem;font-weight:700;letter-spacing:.13em;}
.modal-x{background:transparent;border:none;color:var(--muted2);font-size:1rem;cursor:pointer;transition:color .2s;}
.modal-x:hover{color:var(--text);}
.modal-body{padding:18px;}
.m-inp{width:100%;background:rgba(255,255,255,.04);border:1px solid var(--border2);border-radius:8px;
  color:var(--text);font-family:'Outfit',sans-serif;font-size:.88rem;font-weight:600;
  padding:9px 12px;outline:none;margin-bottom:9px;letter-spacing:.05em;
  transition:border-color .2s;}
.m-inp:focus{border-color:rgba(240,180,41,.35);}
.m-btn{width:100%;padding:9px;font-family:'Orbitron',sans-serif;font-size:.64rem;font-weight:700;
  letter-spacing:.12em;cursor:pointer;border:none;border-radius:8px;
  background:linear-gradient(135deg,#f0b429,#f97316);color:#060810;margin-bottom:7px;
  transition:opacity .15s,box-shadow .15s;box-shadow:0 3px 12px rgba(240,180,41,.2);}
.m-btn:hover{opacity:.88;}
.m-btn.danger{background:linear-gradient(135deg,#f43f5e,#dc2626);box-shadow:0 3px 12px rgba(244,63,94,.2);}
.m-btn.sec{background:transparent;border:1px solid var(--border2);color:var(--muted2);box-shadow:none;}
.m-btn.sec:hover{border-color:var(--muted);color:var(--text);}
.m-err{color:#f43f5e;font-size:.68rem;font-weight:600;margin-bottom:8px;display:none;}
.m-lbl{font-size:.52rem;letter-spacing:.12em;text-transform:uppercase;color:var(--muted2);margin-bottom:5px;font-family:'Orbitron',sans-serif;}
.m-row{display:flex;gap:7px;margin-bottom:7px;}
.adm-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:11px;}
.adm-stat{background:var(--panel2);border:1px solid var(--border);border-radius:8px;padding:10px 12px;}
.adm-sl{font-size:.48rem;letter-spacing:.1em;text-transform:uppercase;color:var(--muted);margin-bottom:3px;font-family:'Orbitron',sans-serif;}
.adm-sv{font-family:'Space Mono',monospace;font-size:.9rem;font-weight:700;}
.adm-sec{font-family:'Orbitron',sans-serif;font-size:.52rem;letter-spacing:.15em;text-transform:uppercase;color:var(--muted);margin:11px 0 6px;}
.adm-row{display:flex;align-items:center;gap:6px;padding:5px 9px;background:var(--panel2);border-radius:6px;margin-bottom:4px;font-size:.76rem;}
.adm-name{flex:1;font-weight:600;}
.adm-coins{color:var(--gold);font-family:'Space Mono',monospace;font-size:.64rem;font-weight:700;min-width:54px;text-align:right;}
.adm-del{background:transparent;border:1px solid rgba(244,63,94,.3);border-radius:4px;color:#f43f5e;font-size:.52rem;padding:2px 6px;cursor:pointer;font-family:'Orbitron',sans-serif;}

/* NOTIF */
.notif{position:fixed;bottom:20px;right:20px;z-index:300;padding:9px 16px;border-radius:10px;
  font-family:'Orbitron',sans-serif;font-size:.56rem;font-weight:700;letter-spacing:.1em;
  transform:translateY(70px);opacity:0;transition:all .34s cubic-bezier(.34,1.56,.64,1);
  backdrop-filter:blur(8px);}
.notif.show{transform:translateY(0);opacity:1;}
.notif.ok{background:rgba(74,222,128,.1);border:1px solid rgba(74,222,128,.35);color:#4ade80;}
.notif.err{background:rgba(244,63,94,.1);border:1px solid rgba(244,63,94,.35);color:#f43f5e;}
.notif.info{background:rgba(240,180,41,.1);border:1px solid rgba(240,180,41,.35);color:var(--gold);}
.notif.warn{background:rgba(251,146,60,.1);border:1px solid rgba(251,146,60,.35);color:#fb923c;}
</style>

<!-- Firebase SDK -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

</head>
<body>

<!-- USERNAME SCREEN -->
<div id="un-screen">
  <div class="un-box">
    <div class="un-logo"><span class="un-logo-hex">⬡</span> FATE ROLL</div>
    <div class="un-sub">Test your luck against the cosmos</div>
    
    <!-- Sign In Step (shown first) -->
    <div id="signInStep">
      <div class="un-label">Sign in with Google</div>
      <div style="font-size:.7rem;color:var(--muted);margin-bottom:16px;line-height:1.5">
        Required to save your progress and compete on the leaderboard
      </div>
      <button class="un-btn" onclick="startSignIn()" style="display:flex;align-items:center;justify-content:center;gap:10px">
        <svg width="18" height="18" viewBox="0 0 18 18" style="fill:currentColor">
          <path d="M17.64 9.2c0-.637-.057-1.251-.164-1.84H9v3.481h4.844c-.209 1.125-.843 2.078-1.796 2.717v2.258h2.908c1.702-1.567 2.684-3.874 2.684-6.615z" fill="#4285F4"/>
          <path d="M9.003 18c2.43 0 4.467-.806 5.956-2.18L12.05 13.56c-.806.54-1.836.86-3.047.86-2.344 0-4.328-1.584-5.036-3.711H.96v2.332C2.44 15.983 5.485 18 9.003 18z" fill="#34A853"/>
          <path d="M3.964 10.71c-.18-.54-.282-1.117-.282-1.71s.102-1.17.282-1.71V4.958H.957C.347 6.173 0 7.548 0 9s.348 2.827.957 4.042l3.007-2.332z" fill="#FBBC05"/>
          <path d="M9.003 3.58c1.321 0 2.508.454 3.44 1.345l2.582-2.58C13.464.891 11.426 0 9.003 0 5.485 0 2.44 2.017.96 4.958L3.966 7.29c.708-2.127 2.692-3.71 5.036-3.71z" fill="#EA4335"/>
        </svg>
        SIGN IN WITH GOOGLE
      </button>
      <div style="font-size:.62rem;color:var(--muted);margin-top:12px">
        New here? No account needed — just sign in to start!
      </div>
    </div>
    
    <!-- Username Step (shown after sign in) -->
    <div id="usernameStep" style="display:none">
      <div style="display:flex;align-items:center;gap:8px;margin-bottom:16px;padding:10px;background:var(--panel2);border-radius:8px;border:1px solid var(--border)">
        <span style="font-size:.7rem;color:var(--muted)">Signed in as:</span>
        <span id="signedInEmail" style="font-size:.8rem;color:#4ade80;font-weight:700;flex:1"></span>
      </div>
      
      <div class="un-label">Choose your display name</div>
      <input class="un-input" id="unInput" placeholder="Username..." maxlength="20"
        onkeydown="if(event.key==='Enter')startGame()"/>
      <div class="un-hint">3–20 characters · shown on leaderboard</div>
      <div class="un-err" id="unErr">Name must be 3–20 characters</div>
      <button class="un-btn" onclick="startGame()">▶ ENTER THE VOID</button>
    </div>
  </div>
</div>

<!-- HEADER -->
<header>
  <div class="logo"><span class="logo-hex">⬡</span> FATE ROLL</div>
  <div class="hstats">
    <div class="hstat"><div class="hstat-lbl">Player</div><div class="hstat-val" id="hs-name" style="color:#fbbf24">—</div></div>
    <div class="hstat"><div class="hstat-lbl">Rolls</div><div class="hstat-val" id="hs-rolls">0</div></div>
    <div class="hstat"><div class="hstat-lbl">Best</div><div class="hstat-val" id="hs-best" style="color:var(--muted)">—</div></div>
    <div class="coin-pill"><span style="font-size:.9rem">🪙</span><span class="coin-val" id="hs-coins">0</span></div>
    <div class="boost-pill" id="boostPill">
      <span class="boost-txt" id="boostTxt">LUCK</span>
      <span class="boost-timer" id="boostTimer"></span>
    </div>
    <div class="bg-indicator" id="bgIndicator">
      <span class="bg-txt">⟳ ROLLING</span>
    </div>
  </div>
  <div class="hdr-acts">
    <button class="hdr-btn save" onclick="saveGame()">💾 Save</button>
    <button id="signInBtn" class="hdr-btn" onclick="signInWithGoogle()" style="border-color:#4ade8050;color:#4ade80">🔐 Sign In</button>
    <button id="adminBtn" class="hdr-btn admin" onclick="openAdmin()" style="display:none">⚙ Admin</button>
    <button class="hdr-btn reset" onclick="openModal('resetMod')">↺ Reset</button>
  </div>
</header>

<!-- LEFT PANEL -->
<div class="left-panel">
  <div class="sec-head"><span>Rarity &amp; Odds</span><span style="font-size:.46rem;letter-spacing:.06em;">1-IN-X</span></div>
  <div class="rar-table" id="rarTable"></div>
  <div class="controls">
    <button class="roll-btn" id="rollBtn" onclick="doRoll()">▶ ROLL <span style="opacity:.4;font-size:.75em">[SPC]</span></button>
    <div class="auto-row">
      <button class="auto-btn" id="autoBtn" onclick="toggleAuto()">⟳ AUTO <span style="opacity:.4;font-size:.75em">[A]</span></button>
      <div id="speedLabel" style="font-size:.52rem;color:var(--muted2);text-align:center;padding:2px 6px;letter-spacing:.05em;font-family:'Orbitron',sans-serif;">Speed: Normal (1s)</div>
    </div>
  </div>
  <div class="prog-wrap" id="progWrap"><div class="prog-fill" id="progFill"></div></div>
  <div class="bg-badge" id="bgBadge">⟳ AUTO ROLLING IN BACKGROUND</div>
  <div class="hist-wrap">
    <div class="sec-head"><span>Recent Rolls</span><span style="cursor:pointer;font-size:.55rem" onclick="document.getElementById('histList').innerHTML=''">CLEAR</span></div>
    <div class="hist-list" id="histList"></div>
  </div>
</div>

<!-- RIGHT PANEL -->
<div class="right-panel">
  <div class="tabs">
    <button class="tab-btn active" id="tab-roll" onclick="switchTab('roll')">🎲 Roll</button>
    <button class="tab-btn" id="tab-inv"  onclick="switchTab('inv')">🎒 Inv <span class="tab-badge" id="invBadge">0</span></button>
    <button class="tab-btn" id="tab-shop" onclick="switchTab('shop')">⚡ Upgrades</button>
    <button class="tab-btn" id="tab-ach" onclick="switchTab('ach')">🏅 Achieve <span class="tab-badge" id="achBadge">0</span></button>
    <button class="tab-btn" id="tab-board" onclick="switchTab('board')">🏆 Board</button>
    <button class="tab-btn" id="tab-editor" onclick="switchTab('editor')" style="display:none;">⚙️ Editor</button>
  </div>

  <!-- ROLL VIEW -->
  <div class="tab-view active" id="view-roll">
    <div id="flash"></div>
    <div id="toast">✦ NEW BEST ✦</div>
    <div id="coin-pop"></div>
    <div class="idle-msg" id="idleMsg">PRESS ROLL TO BEGIN</div>
    <div class="card-wrap" id="cardWrap" style="display:none">
      <div class="pcvs" id="pcvs"></div>
      <div class="shock" id="shock"></div>
      <div class="card" id="card"></div>
    </div>
    <div class="roll-lbl" id="rollLbl" style="visibility:hidden">ROLL #0</div>
    <div id="cinematic">
      <div id="cin-bg"></div>
      <canvas id="cin-canvas"></canvas>
      <div id="cin-card"></div>
      <div id="cin-label"></div>
      <button id="cin-skip" onclick="skipCin()">SKIP [ESC]</button>
    </div>
  </div>

  <!-- INVENTORY VIEW -->
  <div class="tab-view" id="view-inv">
    <div class="inv-toolbar" id="invToolbar">
      <button class="inv-filt on" id="filt-all" onclick="setFilter('all')"
        style="background:var(--muted);border-color:var(--muted);color:#060810">All</button>
      <select class="inv-sort" id="invSort" onchange="renderInv()">
        <option value="rarity-desc">Rarest first</option>
        <option value="rarity-asc">Common first</option>
        <option value="count-desc">Most owned</option>
        <option value="az">A → Z</option>
      </select>
    </div>
    <div class="inv-sum" id="invSum"><span style="color:var(--text);font-weight:700">0 items</span></div>
    <div class="inv-grid" id="invGrid">
      <div class="inv-empty"><div class="inv-empty-icon">🎒</div><div class="inv-empty-txt">No items yet</div></div>
    </div>
    <div class="det-overlay" id="detOv" onclick="if(event.target===this)this.classList.remove('open')">
      <div class="det-card" id="detCard"></div>
    </div>
  </div>

  <!-- SHOP VIEW -->
  <div class="tab-view" id="view-shop">
    <div class="shop-hdr">
      <div class="shop-title-grp">
        <div class="shop-title">UPGRADES</div>
        <div class="shop-sub">Permanently upgrade your power</div>
      </div>
      <div class="shop-bal">🪙 <span id="shopCoins">0</span></div>
    </div>
    <div class="shop-body" id="shopBody"></div>
  </div>

  <!-- ACHIEVEMENT VIEW -->
  <div class="tab-view" id="view-ach">
    <div class="ach-hdr">
      <div>
        <div class="ach-title">ACHIEVEMENTS</div>
        <div class="ach-sub" id="achSubtitle">Loading...</div>
      </div>
    </div>
    <div class="ach-progress-bar"><div class="ach-progress-fill" id="achProgressFill" style="width:0%"></div></div>
    <div class="ach-body" id="achBody"></div>
  </div>

  <!-- LEADERBOARD VIEW -->
  <div class="tab-view" id="view-board">
    <div class="board-hdr">
      <div><div class="board-title">LEADERBOARD</div><div class="board-sub">Global rankings — updates live</div></div>
      <button class="board-refresh" onclick="loadBoard(true, true)" title="Force refresh - get latest data">↺ Refresh</button>
    </div>
    <div class="board-body" id="boardBody">
      <div class="board-status" id="boardStatus">
        <span class="board-dot" style="background:#fbbf24"></span>
        <span>Waiting for game to start...</span>
      </div>
      <div class="board-col-head"><span>#</span><span>Player</span>
        <span style="text-align:right">Coins</span>
        <span style="text-align:right">Rolls</span>
        <span style="text-align:right">Best Pull</span>
      </div>
      <div id="boardList"></div>
    </div>
  </div>

  <!-- EDITOR VIEW -->
  <div class="tab-view" id="view-editor">
    <div class="editor-wrap">
      
      <!-- WELCOME MESSAGE -->
      <div class="editor-section" style="background:linear-gradient(135deg,#c084fc22,#a78bfa22);border:1px solid #c084fc44;">
        <div style="text-align:center;padding:20px;">
          <div style="font-size:2rem;margin-bottom:10px;">✨ Custom Content Editor</div>
          <div style="font-size:.85rem;color:var(--muted);line-height:1.6;">
            Create your own rarities and items! This is where you design custom content for your game.<br>
            <strong style="color:var(--text);">Changes apply immediately</strong> — no restart needed!
          </div>
        </div>
      </div>

      <!-- STEP 1: RARITIES SECTION -->
      <div class="editor-section">
        <div class="editor-title">
          <span style="background:linear-gradient(135deg,#c084fc,#a78bfa);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;font-size:1.1rem;">
            STEP 1: Create Custom Rarities
          </span>
        </div>
        <div class="editor-subtitle" style="margin-bottom:20px;padding:12px;background:var(--panel2);border-radius:8px;border-left:3px solid #c084fc;">
          <strong>What are rarities?</strong> Rarities determine how rare an item is (like "Legendary" or "Mythic").<br>
          <strong>Start here:</strong> Create a rarity first, then add items to it in Step 2.
        </div>
        
        <!-- Existing Rarities List -->
        <div style="margin-bottom:20px;">
          <div style="font-size:.75rem;font-weight:700;color:var(--muted);margin-bottom:10px;text-transform:uppercase;letter-spacing:.1em;">
            📋 Your Custom Rarities
          </div>
          <div class="editor-list" id="editorRarityList">
            <div style="text-align:center;padding:30px;color:var(--muted);font-size:.85rem;">
              No custom rarities yet. Create one below! 👇
            </div>
          </div>
        </div>
        
        <!-- Create New Rarity Form -->
        <div style="background:var(--panel2);padding:20px;border-radius:12px;border:2px dashed var(--border);">
          <div style="font-size:.8rem;font-weight:700;margin-bottom:15px;color:#c084fc;">
            ➕ CREATE NEW RARITY
          </div>
          
          <div class="editor-form" id="rarityForm">
            <div class="editor-form-group">
              <label class="editor-label">
                <span style="color:#fbbf24;">①</span> Rarity Name 
                <span style="color:var(--muted);font-weight:400;font-size:.7rem;">(Required)</span>
              </label>
              <input type="text" class="editor-input" id="rarityName" placeholder="Example: Supreme, Ultimate, Godlike">
              <div style="font-size:.65rem;color:var(--muted);margin-top:4px;">
                💡 Tip: Make it sound epic! This shows up when players roll items.
              </div>
            </div>
            
            <div class="editor-form-group">
              <label class="editor-label">
                <span style="color:#fbbf24;">②</span> Color 
                <span style="color:var(--muted);font-weight:400;font-size:.7rem;">(Pick any color)</span>
              </label>
              <div style="display:flex;gap:8px;align-items:center;">
                <input type="text" class="editor-input" id="rarityColor" placeholder="#ff00ff" style="flex:1;">
                <input type="color" id="rarityColorPicker" value="#c084fc" style="width:60px;height:40px;border:2px solid var(--border);border-radius:8px;cursor:pointer;">
              </div>
              <div style="font-size:.65rem;color:var(--muted);margin-top:4px;">
                💡 Click the color box to pick a color, or type a hex code like #ff6b9d
              </div>
            </div>
            
            <div class="editor-form-group">
              <label class="editor-label">
                <span style="color:#fbbf24;">③</span> Drop Chance (%) 
                <span style="color:var(--muted);font-weight:400;font-size:.7rem;">(How rare is it?)</span>
              </label>
              <input type="number" class="editor-input" id="rarityChance" placeholder="0.05" step="0.01" min="0.001" max="100">
              <div style="font-size:.65rem;color:var(--muted);margin-top:4px;line-height:1.5;">
                💡 Examples:<br>
                • <strong style="color:#4ade80;">10%</strong> = Common (1 in 10 rolls)<br>
                • <strong style="color:#fbbf24;">1%</strong> = Rare (1 in 100 rolls)<br>
                • <strong style="color:#f43f5e;">0.1%</strong> = Very Rare (1 in 1,000 rolls)<br>
                • <strong style="color:#c084fc;">0.01%</strong> = Ultra Rare (1 in 10,000 rolls)
              </div>
            </div>
            
            <div class="editor-form-group">
              <label class="editor-label">
                <span style="color:#fbbf24;">④</span> Emoji/Icon 
                <span style="color:var(--muted);font-weight:400;font-size:.7rem;">(Optional but recommended)</span>
              </label>
              <input type="text" class="editor-input" id="rarityEmoji" placeholder="Examples: ✨ 🌟 💎 👑 ⚡ 🔥">
              <div style="font-size:.65rem;color:var(--muted);margin-top:4px;">
                💡 Use any emoji! Try: ✨🌟💫⭐🌠💎👑⚡🔥🌈🦄🐲
              </div>
            </div>
            
            <button class="editor-btn primary" onclick="saveRarity()" style="width:100%;font-size:.9rem;padding:14px;">
              ✅ CREATE THIS RARITY
            </button>
          </div>
        </div>
      </div>

      <!-- STEP 2: ITEMS SECTION -->
      <div class="editor-section">
        <div class="editor-title">
          <span style="background:linear-gradient(135deg,#38bdf8,#818cf8);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;font-size:1.1rem;">
            STEP 2: Add Items to Your Rarities
          </span>
        </div>
        <div class="editor-subtitle" style="margin-bottom:20px;padding:12px;background:var(--panel2);border-radius:8px;border-left:3px solid #38bdf8;">
          <strong>What are items?</strong> Items are the actual things players get when they roll (like "Cosmic Sword" or "Dragon Scale").<br>
          <strong>Note:</strong> You must create a rarity first (Step 1) before you can add items to it.
        </div>
        
        <div class="editor-form-group" style="margin-bottom:20px;">
          <label class="editor-label" style="font-size:.85rem;">
            <span style="color:#fbbf24;">⑤</span> Choose Which Rarity to Add Items To
          </label>
          <select class="editor-input" id="itemRaritySelect" onchange="renderEditorItems()" style="font-size:.9rem;padding:12px;">
            <option value="">👈 Select a rarity first...</option>
          </select>
          <div style="font-size:.65rem;color:var(--muted);margin-top:4px;">
            💡 Pick one of your custom rarities from the dropdown above
          </div>
        </div>

        <!-- Items List for Selected Rarity -->
        <div style="margin-bottom:20px;">
          <div style="font-size:.75rem;font-weight:700;color:var(--muted);margin-bottom:10px;text-transform:uppercase;letter-spacing:.1em;">
            📋 Items in This Rarity
          </div>
          <div class="editor-item-list" id="editorItemList">
            <div style="text-align:center;padding:30px;color:var(--muted);font-size:.85rem;">
              Select a rarity above to see and add items 👆
            </div>
          </div>
        </div>
        
        <!-- Create New Item Form -->
        <div style="background:var(--panel2);padding:20px;border-radius:12px;border:2px dashed var(--border);">
          <div style="font-size:.8rem;font-weight:700;margin-bottom:15px;color:#38bdf8;">
            ➕ ADD NEW ITEM
          </div>
          
          <div class="editor-form" id="itemForm">
            <div class="editor-form-group">
              <label class="editor-label">
                <span style="color:#fbbf24;">⑥</span> Item Name 
                <span style="color:var(--muted);font-weight:400;font-size:.7rem;">(Required)</span>
              </label>
              <input type="text" class="editor-input" id="itemName" placeholder="Example: Cosmic Blade, Ancient Scroll, Dragon Heart">
              <div style="font-size:.65rem;color:var(--muted);margin-top:4px;">
                💡 Give it a cool name! Players will see this in their inventory.
              </div>
            </div>
            
            <div class="editor-form-group">
              <label class="editor-label">
                <span style="color:#fbbf24;">⑦</span> Icon 
                <span style="color:var(--muted);font-weight:400;font-size:.7rem;">(Emoji or upload image)</span>
              </label>
              <div style="display:flex;gap:8px;">
                <input type="text" class="editor-input" id="itemEmoji" placeholder="🗡️ Try an emoji!" style="flex:1;">
                <label for="itemImageUpload" class="editor-upload-btn" style="flex:1;display:flex;align-items:center;justify-content:center;gap:6px;">
                  📁 Upload Image
                </label>
                <input type="file" id="itemImageUpload" class="editor-file-input" accept="image/*" onchange="handleImageUpload(event)">
              </div>
              <div style="font-size:.65rem;color:var(--muted);margin-top:4px;">
                💡 Use emoji (🗡️⚔️🛡️🏹🔮💎👑) OR upload your own image (PNG/JPG)
              </div>
              <div id="imagePreview" style="margin-top:12px;display:none;text-align:center;padding:12px;background:var(--panel);border-radius:8px;">
                <div style="font-size:.7rem;color:var(--muted);margin-bottom:8px;">Preview:</div>
                <img id="imagePreviewImg" style="width:80px;height:80px;object-fit:cover;border-radius:8px;border:2px solid var(--border);">
              </div>
            </div>
            
            <button class="editor-btn primary" onclick="saveItem()" style="width:100%;font-size:.9rem;padding:14px;">
              ✅ ADD THIS ITEM
            </button>
          </div>
        </div>
      </div>

      <!-- STEP 3: ACTIONS SECTION -->
      <div class="editor-section">
        <div class="editor-title">
          <span style="background:linear-gradient(135deg,#fbbf24,#f97316);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;font-size:1.1rem;">
            STEP 3: Manage Your Custom Content
          </span>
        </div>
        <div class="editor-subtitle" style="margin-bottom:20px;">
          Save, share, or reset all your custom rarities and items.
        </div>
        <div style="display:flex;gap:10px;flex-wrap:wrap;">
          <button class="editor-btn" onclick="exportCustomData()" style="flex:1;min-width:200px;">
            💾 Export Custom Data<br>
            <span style="font-size:.65rem;opacity:.7;">Download as file to share or backup</span>
          </button>
          <button class="editor-btn" onclick="importCustomData()" style="flex:1;min-width:200px;">
            📥 Import Custom Data<br>
            <span style="font-size:.65rem;opacity:.7;">Load from a file</span>
          </button>
          <button class="editor-btn danger" onclick="resetCustomData()" style="flex:1;min-width:200px;">
            🗑️ Reset All Custom Data<br>
            <span style="font-size:.65rem;opacity:.7;">Delete everything and start over</span>
          </button>
        </div>
      </div>
      
      <!-- HELP SECTION -->
      <div class="editor-section" style="background:var(--panel2);border:1px solid var(--border);">
        <div class="editor-title" style="font-size:.9rem;">❓ Need Help?</div>
        <div style="font-size:.75rem;color:var(--muted);line-height:1.8;">
          <strong style="color:var(--text);">Quick Tutorial:</strong><br>
          1️⃣ Create a rarity (name it, pick color, set drop chance)<br>
          2️⃣ Select that rarity from the dropdown in Step 2<br>
          3️⃣ Add items to it (give them names and icons)<br>
          4️⃣ Test by using "Force Roll" in the Admin Panel!<br><br>
          
          <strong style="color:var(--text);">Tips:</strong><br>
          • Lower drop chance = more rare (0.01% is super rare!)<br>
          • You can add multiple items to one rarity<br>
          • Changes happen instantly - no restart needed<br>
          • Use Export to backup your custom content
        </div>
      </div>
      
    </div>
  </div>
    </div>
  </div>
</div>

<!-- MODALS -->
<div class="modal-ov" id="resetMod">
  <div class="modal-box">
    <div class="modal-hdr"><div class="modal-ttl">RESET PROGRESS</div><button class="modal-x" onclick="closeModal('resetMod')">✕</button></div>
    <div class="modal-body">
      <p style="color:var(--muted);font-size:.8rem;margin-bottom:16px;line-height:1.6">This permanently erases <strong style="color:var(--text)">all rolls, coins, inventory and upgrades</strong>. Cannot be undone.</p>
      <button class="m-btn danger" onclick="confirmReset()">⚠ DELETE EVERYTHING</button>
      <button class="m-btn sec" onclick="closeModal('resetMod')">Cancel</button>
    </div>
  </div>
</div>

<div class="modal-ov" id="adminMod">
  <div class="modal-box" style="width:480px">
    <div class="modal-hdr">
      <div class="modal-ttl">⚙ ADMIN PANEL</div>
      <button class="modal-x" onclick="closeModal('adminMod')">✕</button>
    </div>
    <div class="modal-body">
      <div style="display:flex;align-items:center;gap:8px;margin-bottom:16px;padding:8px;background:var(--panel2);border-radius:6px;border:1px solid var(--border)">
        <span style="font-size:.7rem;color:var(--muted)">Signed in as:</span>
        <span id="adminEmail" style="font-size:.75rem;color:#4ade80;font-weight:700;flex:1"></span>
        <button class="m-btn sec" style="padding:4px 10px;margin:0;font-size:.6rem" onclick="signOutAdmin()">Sign Out</button>
      </div>
      <div id="adminBody"></div>
    </div>
  </div>
</div>

<div class="modal-ov" id="rarityCreatorMod">
  <div class="modal-box" style="width:520px">
    <div class="modal-hdr">
      <div class="modal-ttl">✨ CREATE CUSTOM RARITY</div>
      <button class="modal-x" onclick="closeModal('rarityCreatorMod')">✕</button>
    </div>
    <div class="modal-body">
      <div class="m-lbl">Rarity Name</div>
      <input class="m-inp" id="rarName" placeholder="e.g. Mythical, Ultimate, Supreme..." maxlength="20"/>
      
      <div class="m-lbl">Icon / Emoji</div>
      <div style="display:flex;gap:8px;margin-bottom:12px">
        <input class="m-inp" id="rarIcon" placeholder="Paste emoji or text..." maxlength="5" style="flex:1;margin-bottom:0"/>
        <label style="cursor:pointer">
          <input type="file" id="rarIconFile" accept="image/*" style="display:none" onchange="handleRarityImage(this)"/>
          <button class="m-btn sec" style="width:auto;padding:8px 13px;margin:0" onclick="document.getElementById('rarIconFile').click();event.preventDefault()">📁 Upload</button>
        </label>
      </div>
      <div id="rarIconPreview" style="display:none;text-align:center;padding:12px;background:var(--panel2);border-radius:6px;margin-bottom:12px">
        <img id="rarIconImg" style="max-width:80px;max-height:80px;border-radius:4px"/>
      </div>
      
      <div class="m-lbl">Color (Hex)</div>
      <div style="display:flex;gap:8px;margin-bottom:12px">
        <input class="m-inp" id="rarColor" placeholder="#ff6b9d" maxlength="7" style="flex:1;margin-bottom:0"/>
        <input type="color" id="rarColorPicker" style="width:50px;height:38px;border:1px solid var(--border);border-radius:6px;background:var(--panel2);cursor:pointer" onchange="document.getElementById('rarColor').value=this.value"/>
      </div>
      
      <div class="m-lbl">Drop Rate (%)</div>
      <input class="m-inp" id="rarPct" type="number" step="0.001" min="0.001" max="100" placeholder="e.g. 0.05 for 0.05%"/>
      
      <div class="m-lbl">Coin Reward</div>
      <input class="m-inp" id="rarCoins" type="number" min="1" placeholder="e.g. 5000"/>
      
      <div style="padding:10px;background:var(--panel2);border-radius:6px;border:1px solid var(--border);margin-bottom:12px">
        <div style="font-size:.65rem;color:var(--muted);margin-bottom:6px">PREVIEW:</div>
        <div style="display:flex;align-items:center;gap:10px">
          <span id="rarPreviewIcon" style="font-size:2rem">✨</span>
          <div>
            <div id="rarPreviewName" style="font-weight:700;font-size:.9rem;color:#c084fc">NEW RARITY</div>
            <div style="font-size:.65rem;color:var(--muted)">
              <span id="rarPreviewPct">0.05%</span> · 
              <span id="rarPreviewCoins">🪙 5000</span>
            </div>
          </div>
        </div>
      </div>
      
      <div class="m-err" id="rarErr" style="display:none"></div>
      <button class="m-btn" onclick="saveCustomRarity()">✨ CREATE RARITY</button>
      <button class="m-btn sec" onclick="closeModal('rarityCreatorMod')">CANCEL</button>

      <!-- Live list of existing custom rarities -->
      <div style="margin-top:18px;padding-top:16px;border-top:1px solid var(--border);">
        <div style="font-family:'Orbitron',sans-serif;font-size:.56rem;letter-spacing:.16em;text-transform:uppercase;color:var(--muted);margin-bottom:10px;">YOUR CUSTOM RARITIES</div>
        <div id="modalCustomList"></div>
      </div>
    </div>
  </div>
</div>

<div class="notif" id="notif"></div>

<script>
// ══════════════════════════════════════════════════════════
// ANTI-CHEAT  (clean, no obfuscation)
// ══════════════════════════════════════════════════════════

// Track flag reasons
const _secFlags = new Set();
window._secFlags = _secFlags;

function flagCheat(reason) {
  _secFlags.add(reason);
  if (typeof S !== 'undefined') S._flagged = true;
}
function unflagCheat(reason) {
  _secFlags.delete(reason);
  if (_secFlags.size === 0 && typeof S !== 'undefined') S._flagged = false;
}

// Velocity check — runs every 2 s
// Blocks coin gains that are physically impossible given max roll speed
let _prevSnap = { coins: 0, total: 0, ts: Date.now() };
setInterval(function velocityCheck() {
  if (typeof S === 'undefined') return;
  if (typeof isAdmin !== 'undefined' && isAdmin) return;

  const now     = Date.now();
  const elapsed = (now - _prevSnap.ts) / 1000;
  const coinDelta = S.coins - _prevSnap.coins;

  // Max possible: 150,000 coins/roll × 10× multiplier × ~12 rolls/sec × elapsed
  const maxPossible = 150000 * getCoinMult() * 15 * elapsed;
  if (coinDelta > maxPossible && coinDelta > 500000) {
    S.coins = _prevSnap.coins;
    flagCheat('coin-spike');
  }

  // Sanity guards
  if (S.bestIdx > ORDER.length - 1) { S.bestIdx = -1; flagCheat('bestidx-oob'); }
  if (S.coins < 0)  { S.coins = 0;  flagCheat('negative-coins'); }
  if (S.total < 0)  { S.total = 0;  flagCheat('negative-rolls'); }

  _prevSnap = { coins: S.coins, total: S.total, ts: now };
}, 2000);

// Protect Math.random from replacement
const _origRandom = Math.random.bind(Math);
Object.defineProperty(Math, 'random', {
  get() { return _origRandom; },
  set() { flagCheat('math-random-override'); },
  configurable: false
});

let RARITIES = [
  // Ultra-endgame — astronomically rare (100x harder than before)
  {key:'primordial', label:'Primordial', pct:0.000008, color:'#06b6d4', np:100, fx:15},
  {key:'genesis',    label:'Genesis',    pct:0.000012, color:'#22d3ee', np:85,  fx:13},
  {key:'cosmic',     label:'Cosmic',     pct:0.00003,  color:'#a78bfa', np:80,  fx:12},
  {key:'eternal',    label:'Eternal',    pct:0.00007,  color:'#818cf8', np:75,  fx:11},
  {key:'celestial',  label:'Celestial',  pct:0.00012,  color:'#e879f9', np:70,  fx:10},
  {key:'transcendent',label:'Transcendent',pct:0.00025, color:'#ec4899', np:67, fx:10},
  {key:'divine',     label:'Divine',     pct:0.0005,   color:'#f43f5e', np:65,  fx:9 },
  // Hard mid-game
  {key:'ancient',    label:'Ancient',    pct:0.0012,   color:'#f59e0b', np:60,  fx:8 },
  {key:'mythic',     label:'Mythic',     pct:0.003,    color:'#fb923c', np:55,  fx:7 },
  {key:'exalted',    label:'Exalted',    pct:0.80,     color:'#eab308', np:35,  fx:4 },
  // Standard
  {key:'legendary',  label:'Legendary',  pct:2.00,     color:'#fbbf24', np:28,  fx:3 },
  {key:'epic',       label:'Epic',       pct:6.00,     color:'#c084fc', np:20,  fx:2 },
  {key:'rare',       label:'Rare',       pct:15.00,    color:'#38bdf8', np:14,  fx:1 },
  {key:'uncommon',   label:'Uncommon',   pct:27.00,    color:'#4ade80', np:7,   fx:0 },
  {key:'common',     label:'Common',     pct:49.18801, color:'#94a3b8', np:4,   fx:0 },
];
(()=>{let c=0; RARITIES.forEach(r=>{c+=r.pct/100; r.threshold=Math.min(1,c);}); RARITIES[RARITIES.length-1].threshold=1.0;})();

let ORDER = ['common','uncommon','rare','epic','legendary','exalted','mythic','ancient','divine','transcendent','celestial','eternal','cosmic','genesis','primordial'];

const COIN_REWARDS = {
  primordial:150000, genesis:75000, cosmic:35000, eternal:18000, celestial:9000, 
  transcendent:5000, divine:2500, ancient:800, mythic:400, exalted:150, 
  legendary:80, epic:25, rare:8, uncommon:3, common:1
};

// ── ITEMS — 3+ per all tiers except eternal (3) and celestial (3) ──
const ITEMS = {
  primordial:[['🌀','Origin Vortex'],['💠','Universe Seed'],['⚛️','First Atom'],['🌊','Primordial Tide']],
  genesis:   [['🌊','The Primeval Wave'],['⚛️','Quark Singularity'],['🪐','Titan Core'],
               ['🌐','World Engine'],['💥','Big Bang Echo'],['⚡','Void Lightning'],['🧬','Genesis Strand']],
  cosmic:    [['🌌','Cosmic Nexus'],['💫','Galaxy Heart'],['🌠','Nebula Crown'],['🪐','Planet Forge']],
  eternal:   [['🔮','Eternal Prism'],['🌙','Lunar Epoch'],['🌀','Time Spiral']],
  celestial: [['🌌','Celestial Crown'],['💫','Star Weaver'],['☄️','Comet Throne']],
  transcendent:[['✨','Beyond Mortal'],['🌟','Ascension Orb'],['💎','Transcendent Gem']],
  divine:    [['✨','The First Light'],['🌠','Soul of Creation'],['🌟','Infinity Shard'],
               ['🕊️','Divine Feather'],['⚗️','Sacred Elixir'],['🏛️','God\'s Pillar'],['🌅','Dawn Eternal']],
  ancient:   [['🗿','Elder Monolith'],['📿','Ancient Beads'],['🏺','Timeless Urn'],['🪙','Forgotten Coin']],
  mythic:    [['🌀','Gravity Core'],['🔥','Primordial Flame'],['💧','God\'s Tear'],
               ['🌋','Volcano Heart'],['🧿','Mythic Eye'],['🪬','Fate Ward'],['🐲','Ancient Wyrm']],
  exalted:   [['👁️','All-Seeing Eye'],['🔱','Exalted Trident'],['⚜️','Royal Emblem'],['🎭','Sovereign Mask']],
  legendary: [['👑','Crown of Ages'],['🐉','Dragonheart'],['⭐','Starblade'],['⏳','Time Fragment'],
               ['🗝️','Master Key'],['📿','Dragon Rosary'],['🎴','Fate Sigil'],['🛡️','Aegis Ward']],
  epic:      [['👁️','Spectral Eye'],['⚡','Thunder Rune'],['🌑','Void Orb'],['📕','Ancient Tome'],
               ['🧥','Phantom Cloak'],['💠','Soul Prism'],['🔆','Ember Core'],['🗡️','Shadow Blade'],['🌒','Eclipse Gem']],
  rare:      [['💎','Soul Crystal'],['🗡️','Elven Dagger'],['💍','Sapphire Ring'],['📜','Arcane Scroll'],
               ['🗺️','Explorer\'s Map'],['🔱','Trident Shard'],['🦋','Moon Wing'],['🌺','Spirit Bloom'],['🎭','Masque']],
  uncommon:  [['🔮','Jade Amulet'],['🪙','Silver Coin'],['🏹','Forest Bow'],['🏮','Storm Lantern'],
               ['🛡️','Iron Shield'],['🌱','Life Root'],['🐺','Wolf Pelt'],['🧲','Lodestone'],['🎵','Song Shard']],
  common:    [['🌿','Common Herb'],['🪨','Iron Pebble'],['🥄','Bent Spoon'],['🗺️','Dusty Map'],
               ['🪞','Cracked Mirror'],['🧻','Torn Scroll'],['🍂','Withered Leaf'],['🪵','Rough Wood'],['🧂','Salt Pinch']],
};

const ITEM_THEMES = {
  // Primordial items
  '💠':{bg:'radial-gradient(ellipse at 50% 50%,#001a25,#000)',fx:'nova'},
  '🗿':{bg:'radial-gradient(ellipse at 50% 50%,#1a1510,#000)',fx:'starburst'},
  '🏺':{bg:'radial-gradient(ellipse at 50% 50%,#1a1208,#000)',fx:'vortex'},
  '⚜️':{bg:'radial-gradient(ellipse at 50% 50%,#1a1500,#000)',fx:'starburst'},
  // Existing items
  '🌊':{bg:'radial-gradient(ellipse at 50% 50%,#002030,#000)',fx:'tearfall'},
  '⚛️':{bg:'radial-gradient(ellipse at 50% 50%,#001530,#000)',fx:'nova'},
  '🪐':{bg:'radial-gradient(ellipse at 50% 50%,#100020,#000)',fx:'vortex'},
  '🌐':{bg:'radial-gradient(ellipse at 50% 50%,#001820,#000)',fx:'nova'},
  '💥':{bg:'radial-gradient(ellipse at 50% 50%,#200010,#000)',fx:'nova'},
  '⚡':{bg:'radial-gradient(ellipse at 50% 50%,#101500,#000)',fx:'starburst'},
  '🧬':{bg:'radial-gradient(ellipse at 50% 50%,#001520,#000)',fx:'nova'},
  '🔮':{bg:'radial-gradient(ellipse at 50% 50%,#0a0020,#000)',fx:'starburst'},
  '🌙':{bg:'radial-gradient(ellipse at 50% 50%,#050015,#000)',fx:'meteors'},
  '🌀':{bg:'radial-gradient(ellipse at 50% 50%,#050018,#000)',fx:'vortex'},
  '🌌':{bg:'radial-gradient(ellipse at 50% 50%,#080018,#000)',fx:'starburst'},
  '💫':{bg:'radial-gradient(ellipse at 50% 50%,#100025,#000)',fx:'nova'},
  '☄️':{bg:'radial-gradient(ellipse at 50% 50%,#150010,#000)',fx:'meteors'},
  '✨':{bg:'radial-gradient(ellipse at 50% 50%,#1a0020,#000)',fx:'starburst'},
  '🌠':{bg:'radial-gradient(ellipse at 50% 50%,#000820,#000)',fx:'meteors'},
  '🌟':{bg:'radial-gradient(ellipse at 50% 50%,#001510,#000)',fx:'nova'},
  '🕊️':{bg:'radial-gradient(ellipse at 50% 50%,#001a1a,#000)',fx:'nova'},
  '⚗️':{bg:'radial-gradient(ellipse at 50% 50%,#1a0010,#000)',fx:'starburst'},
  '🏛️':{bg:'radial-gradient(ellipse at 50% 50%,#181800,#000)',fx:'nova'},
  '🌅':{bg:'radial-gradient(ellipse at 50% 50%,#1a0800,#000)',fx:'inferno'},
  '🔥':{bg:'radial-gradient(ellipse at 50% 50%,#1a0500,#000)',fx:'inferno'},
  '💧':{bg:'radial-gradient(ellipse at 50% 50%,#000d1a,#000)',fx:'tearfall'},
  '🌋':{bg:'radial-gradient(ellipse at 50% 50%,#1a0300,#000)',fx:'inferno'},
  '🧿':{bg:'radial-gradient(ellipse at 50% 50%,#050015,#000)',fx:'vortex'},
  '🪬':{bg:'radial-gradient(ellipse at 50% 50%,#0a0015,#000)',fx:'vortex'},
  '🐲':{bg:'radial-gradient(ellipse at 50% 50%,#0a1500,#000)',fx:'inferno'},
};

// ── PERMANENT UPGRADES ──────────────────────────────────────
// ── UPGRADE TREES ─────────────────────────────────────────────
// Each node: { label, bonus, icon, coins, rolls, requires[], ...effect }
const TREE_NODES = {
  // ── LUCK TREE ──────────────────────────────────────────────
  luck1:  { tree:'luck',  label:'Lucky Start',    icon:'🍀', bonus:'+10% luck',   shift:0.06, coins:10000,      rolls:0,       requires:[] },
  luck2:  { tree:'luck',  label:'Fortune',        icon:'🍀', bonus:'+25% luck',   shift:0.14, coins:200000,     rolls:500,     requires:['luck1'] },
  luck3:  { tree:'luck',  label:'Blessed',        icon:'🍀', bonus:'+50% luck',   shift:0.25, coins:3000000,    rolls:5000,    requires:['luck2'] },
  luck4:  { tree:'luck',  label:'Fated',          icon:'🌟', bonus:'+100% luck',  shift:0.38, coins:40000000,   rolls:50000,   requires:['luck3'] },
  luck5:  { tree:'luck',  label:'Destiny',        icon:'✨', bonus:'+200% luck',  shift:0.55, coins:500000000,  rolls:500000,  requires:['luck4'] },
  coin1:  { tree:'luck',  label:'Silver Touch',   icon:'🪙', bonus:'1.5× coins',  mult:1.5,   coins:25000,      rolls:100,     requires:['luck1'] },
  coin2:  { tree:'luck',  label:'Gold Rush',      icon:'💰', bonus:'2× coins',    mult:2.0,   coins:500000,     rolls:2000,    requires:['coin1'] },
  coin3:  { tree:'luck',  label:'Treasure Sense', icon:'💰', bonus:'3× coins',    mult:3.0,   coins:8000000,    rolls:20000,   requires:['coin2'] },
  coin4:  { tree:'luck',  label:'Vault Keeper',   icon:'🏦', bonus:'5× coins',    mult:5.0,   coins:100000000,  rolls:200000,  requires:['coin3'] },
  coin5:  { tree:'luck',  label:'Midas Touch',    icon:'🏦', bonus:'10× coins',   mult:10.0,  coins:1000000000, rolls:2000000, requires:['coin4'] },
  // ── SPEED TREE ─────────────────────────────────────────────
  speed1: { tree:'speed', label:'Quick Hands',    icon:'⚡', bonus:'1.5× speed',  ms:700,     coins:5000,       rolls:0,       requires:[] },
  speed2: { tree:'speed', label:'Fleet Fingers',  icon:'⚡', bonus:'2× speed',    ms:450,     coins:75000,      rolls:200,     requires:['speed1'] },
  speed3: { tree:'speed', label:'Swift Fate',     icon:'💨', bonus:'3× speed',    ms:280,     coins:1000000,    rolls:2000,    requires:['speed2'] },
  speed4: { tree:'speed', label:'Blur Roll',      icon:'💨', bonus:'5× speed',    ms:150,     coins:15000000,   rolls:20000,   requires:['speed3'] },
  speed5: { tree:'speed', label:'Lightning Pull', icon:'🌩️', bonus:'10× speed',   ms:80,      coins:200000000,  rolls:200000,  requires:['speed4'] },
  double: { tree:'speed', label:'Double Roll',    icon:'🎲', bonus:'Roll ×2',     count:2,    coins:50000,      rolls:500,     requires:['speed1'] },
  triple: { tree:'speed', label:'Triple Roll',    icon:'🎲', bonus:'Roll ×3',     count:3,    coins:5000000,    rolls:10000,   requires:['double','speed3'] },
};

// Tree layouts — rows of node IDs (null = empty slot)
const TREES = {
  luck: {
    name:'Luck Tree', icon:'🍀',
    desc:'Upgrade your fate — more luck for rare pulls, and more coins from each roll.',
    rows:[
      ['luck1','luck2','luck3','luck4','luck5'],
      ['coin1','coin2','coin3','coin4','coin5'],
    ],
    rowLabels:['⬆ Luck Path','⬆ Coin Path'],
  },
  speed: {
    name:'Speed Tree', icon:'⚡',
    desc:'Roll faster and hit harder — multi-roll unlocks let you chain pulls instantly.',
    rows:[
      ['speed1','speed2','speed3','speed4','speed5'],
      ['double','triple',null,null,null],
    ],
    rowLabels:['⬆ Speed Path','⬆ Multi-Roll Path'],
  },
};

// Legacy UPGRADES shim (achievements + helpers still reference it)
const UPGRADES = {
  luck:  {name:'Luck Multiplier',  icon:'🍀', tiers:[{},{},{},{},{}]},
  coin:  {name:'Coin Multiplier',  icon:'🪙', tiers:[{},{},{},{},{}]},
  speed: {name:'Roll Speed',       icon:'⚡', tiers:[{},{},{},{},{}]},
};

// ── SETTINGS ─────────────────────────────────────────────────
let gameSettings = { skipCinematic: false };
function loadSettings() {
  try { const s = localStorage.getItem('fate_settings'); if (s) Object.assign(gameSettings, JSON.parse(s)); } catch(e) {}
}
function saveSettings() {
  try { localStorage.setItem('fate_settings', JSON.stringify(gameSettings)); } catch(e) {}
}

// ── UPGRADE TREE HELPERS ─────────────────────────────────────
function getOwned() {
  if (!S.upgrades || typeof S.upgrades !== 'object' || Array.isArray(S.upgrades)) return {};
  return S.upgrades;
}
function hasNode(id) { return !!getOwned()[id]; }
function canUnlock(id) {
  const n = TREE_NODES[id]; if (!n) return false;
  if (hasNode(id)) return false;
  return n.requires.every(r => hasNode(r));
}
function canAffordNode(id) {
  const n = TREE_NODES[id]; if (!n) return false;
  return S.coins >= n.coins && S.total >= n.rolls;
}

// Legacy shim for achievements
function getUpgTier(type) {
  const owned = getOwned();
  if (type === 'luck')  { let t=-1; ['luck1','luck2','luck3','luck4','luck5'].forEach((id,i)=>{ if(owned[id]) t=i; }); return t; }
  if (type === 'coin')  { let t=-1; ['coin1','coin2','coin3','coin4','coin5'].forEach((id,i)=>{ if(owned[id]) t=i; }); return t; }
  if (type === 'speed') { let t=-1; ['speed1','speed2','speed3','speed4','speed5'].forEach((id,i)=>{ if(owned[id]) t=i; }); return t; }
  return -1;
}

function getCoinMult() {
  const mults = {coin1:1.5,coin2:2,coin3:3,coin4:5,coin5:10};
  const owned = getOwned();
  let best = 1;
  Object.entries(mults).forEach(([id,m]) => { if(owned[id] && m > best) best = m; });
  return best;
}
function getLuckShiftUpg() {
  const shifts = {luck1:0.06,luck2:0.14,luck3:0.25,luck4:0.38,luck5:0.55};
  const owned = getOwned();
  let best = 0;
  Object.entries(shifts).forEach(([id,s]) => { if(owned[id] && s > best) best = s; });
  return best;
}
function getAutoSpeedMs() {
  const speeds = {speed1:700,speed2:450,speed3:280,speed4:150,speed5:80};
  const owned = getOwned();
  let best = 1000;
  Object.entries(speeds).forEach(([id,ms]) => { if(owned[id] && ms < best) best = ms; });
  return best;
}
function getMultiRollCount() {
  if (hasNode('triple')) return 3;
  if (hasNode('double')) return 2;
  return 1;
}
function getSpeedLabel() {
  const t = getUpgTier('speed');
  if (t < 0) return 'Normal (1s)';
  const labels = ['Quick Hands (1.5×)','Fleet Fingers (2×)','Swift Fate (3×)','Blur Roll (5×)','Lightning Pull (10×)'];
  return labels[t] || 'Normal';
}

// ═══════════════════════════════════════════════════════════
// ACHIEVEMENTS
// ═══════════════════════════════════════════════════════════
const ACHIEVEMENTS = [
  // ── ROLLS ──────────────────────────────────────────────
  { id:'rolls_10',      cat:'Rolls',      icon:'🎲', name:'First Steps',       desc:'Roll 10 times',                         req:()=>S.total>=10,         reward:50 },
  { id:'rolls_100',     cat:'Rolls',      icon:'🎲', name:'Getting Warmed Up', desc:'Roll 100 times',                        req:()=>S.total>=100,        reward:500, prog:()=>[S.total,100] },
  { id:'rolls_1k',      cat:'Rolls',      icon:'🎲', name:'Dedicated Roller',  desc:'Roll 1,000 times',                      req:()=>S.total>=1000,       reward:5000, prog:()=>[S.total,1000] },
  { id:'rolls_10k',     cat:'Rolls',      icon:'🌀', name:'Fate Fanatic',      desc:'Roll 10,000 times',                     req:()=>S.total>=10000,      reward:50000, prog:()=>[S.total,10000] },
  { id:'rolls_100k',    cat:'Rolls',      icon:'🌀', name:'Roll Obsessed',     desc:'Roll 100,000 times',                    req:()=>S.total>=100000,     reward:500000, prog:()=>[S.total,100000] },
  { id:'rolls_1m',      cat:'Rolls',      icon:'⚡', name:'Infinity Roller',   desc:'Roll 1,000,000 times',                  req:()=>S.total>=1000000,    reward:5000000, prog:()=>[S.total,1000000] },

  // ── COINS ──────────────────────────────────────────────
  { id:'coins_1k',      cat:'Coins',      icon:'🪙', name:'Pocket Change',     desc:'Earn 1,000 coins total',                req:()=>S.coins>=1000,       reward:100 },
  { id:'coins_10k',     cat:'Coins',      icon:'🪙', name:'Small Fortune',     desc:'Earn 10,000 coins',                     req:()=>S.coins>=10000,      reward:1000, prog:()=>[S.coins,10000] },
  { id:'coins_100k',    cat:'Coins',      icon:'💰', name:'Big Spender',       desc:'Have 100,000 coins at once',            req:()=>S.coins>=100000,     reward:10000, prog:()=>[S.coins,100000] },
  { id:'coins_1m',      cat:'Coins',      icon:'💰', name:'Millionaire',       desc:'Have 1,000,000 coins at once',          req:()=>S.coins>=1000000,    reward:100000, prog:()=>[S.coins,1000000] },
  { id:'coins_10m',     cat:'Coins',      icon:'🏦', name:'Coin Hoarder',      desc:'Have 10,000,000 coins at once',         req:()=>S.coins>=10000000,   reward:1000000, prog:()=>[S.coins,10000000] },
  { id:'coins_100m',    cat:'Coins',      icon:'🏦', name:'Fate Billionaire',  desc:'Have 100,000,000 coins at once',        req:()=>S.coins>=100000000,  reward:10000000, prog:()=>[S.coins,100000000] },

  // ── RARITY PULLS ───────────────────────────────────────
  { id:'pull_rare',     cat:'Pulls',      icon:'💎', name:'Worth Something',   desc:'Pull a Rare or better',                 req:()=>(S.counts.rare||0)+(S.counts.epic||0)+(S.counts.legendary||0)+(S.counts.exalted||0)+(S.counts.mythic||0)+(S.counts.ancient||0)+(S.counts.divine||0)+(S.counts.transcendent||0)+(S.counts.celestial||0)+(S.counts.eternal||0)+(S.counts.cosmic||0)+(S.counts.genesis||0)+(S.counts.primordial||0)>=1, reward:200 },
  { id:'pull_epic',     cat:'Pulls',      icon:'👁️', name:'Something Special', desc:'Pull an Epic or better',               req:()=>(S.counts.epic||0)+(S.counts.legendary||0)+(S.counts.exalted||0)+(S.counts.mythic||0)+(S.counts.ancient||0)+(S.counts.divine||0)+(S.counts.transcendent||0)+(S.counts.celestial||0)+(S.counts.eternal||0)+(S.counts.cosmic||0)+(S.counts.genesis||0)+(S.counts.primordial||0)>=1, reward:1000 },
  { id:'pull_legendary',cat:'Pulls',      icon:'👑', name:'Legendary Pull',    desc:'Pull a Legendary or better',            req:()=>(S.counts.legendary||0)+(S.counts.exalted||0)+(S.counts.mythic||0)+(S.counts.ancient||0)+(S.counts.divine||0)+(S.counts.transcendent||0)+(S.counts.celestial||0)+(S.counts.eternal||0)+(S.counts.cosmic||0)+(S.counts.genesis||0)+(S.counts.primordial||0)>=1, reward:5000 },
  { id:'pull_mythic',   cat:'Pulls',      icon:'🌀', name:'Mythic Force',      desc:'Pull a Mythic or better',              req:()=>(S.counts.mythic||0)+(S.counts.ancient||0)+(S.counts.divine||0)+(S.counts.transcendent||0)+(S.counts.celestial||0)+(S.counts.eternal||0)+(S.counts.cosmic||0)+(S.counts.genesis||0)+(S.counts.primordial||0)>=1, reward:20000 },
  { id:'pull_divine',   cat:'Pulls',      icon:'✨', name:'Divine Touch',      desc:'Pull a Divine or better',              req:()=>(S.counts.divine||0)+(S.counts.transcendent||0)+(S.counts.celestial||0)+(S.counts.eternal||0)+(S.counts.cosmic||0)+(S.counts.genesis||0)+(S.counts.primordial||0)>=1, reward:100000 },
  { id:'pull_transcend',cat:'Pulls',      icon:'🌟', name:'Beyond Mortal',     desc:'Pull a Transcendent or better',        req:()=>(S.counts.transcendent||0)+(S.counts.celestial||0)+(S.counts.eternal||0)+(S.counts.cosmic||0)+(S.counts.genesis||0)+(S.counts.primordial||0)>=1, reward:500000 },
  { id:'pull_celestial',cat:'Pulls',      icon:'🌌', name:'Touched by Stars',  desc:'Pull a Celestial or better',           req:()=>(S.counts.celestial||0)+(S.counts.eternal||0)+(S.counts.cosmic||0)+(S.counts.genesis||0)+(S.counts.primordial||0)>=1, reward:2000000 },
  { id:'pull_eternal',  cat:'Pulls',      icon:'🔮', name:'Eternal Moment',    desc:'Pull an Eternal or better',            req:()=>(S.counts.eternal||0)+(S.counts.cosmic||0)+(S.counts.genesis||0)+(S.counts.primordial||0)>=1, reward:10000000 },
  { id:'pull_cosmic',   cat:'Pulls',      icon:'💫', name:'Cosmic Event',      desc:'Pull a Cosmic or better',              req:()=>(S.counts.cosmic||0)+(S.counts.genesis||0)+(S.counts.primordial||0)>=1, reward:50000000 },
  { id:'pull_genesis',  cat:'Pulls',      icon:'⚛️', name:'Genesis Moment',    desc:'Pull a Genesis or better',             req:()=>(S.counts.genesis||0)+(S.counts.primordial||0)>=1, reward:200000000 },
  { id:'pull_primordial',cat:'Pulls',     icon:'🌊', name:'Origin Found',      desc:'Pull a Primordial — near impossible',   req:()=>(S.counts.primordial||0)>=1, reward:999999999 },

  // ── COLLECTION ─────────────────────────────────────────
  { id:'inv_10',        cat:'Collection', icon:'🎒', name:'Collector',         desc:'Discover 10 unique items',              req:()=>Object.keys(S.inventory).length>=10,   reward:500 },
  { id:'inv_50',        cat:'Collection', icon:'🎒', name:'Hoarder',           desc:'Discover 50 unique items',              req:()=>Object.keys(S.inventory).length>=50,   reward:5000, prog:()=>[Object.keys(S.inventory).length,50] },
  { id:'inv_100',       cat:'Collection', icon:'📦', name:'Archivist',         desc:'Discover 100 unique items',             req:()=>Object.keys(S.inventory).length>=100,  reward:50000, prog:()=>[Object.keys(S.inventory).length,100] },
  { id:'inv_200',       cat:'Collection', icon:'📦', name:'Grand Curator',     desc:'Discover 200 unique items',             req:()=>Object.keys(S.inventory).length>=200,  reward:500000, prog:()=>[Object.keys(S.inventory).length,200] },

  // ── UPGRADES ───────────────────────────────────────────
  { id:'upg_any',       cat:'Upgrades',   icon:'⚡', name:'First Upgrade',     desc:'Unlock any upgrade node',               req:()=>Object.keys(getOwned()).length>0, reward:2000 },
  { id:'upg_luck3',     cat:'Upgrades',   icon:'🍀', name:'Lucky Charm',       desc:'Unlock Blessed (Luck III)',              req:()=>hasNode('luck3'), reward:500000, prog:()=>[getUpgTier('luck')+1,3] },
  { id:'upg_coin3',     cat:'Upgrades',   icon:'🪙', name:'Money Maker',       desc:'Unlock Treasure Sense (Coin III)',       req:()=>hasNode('coin3'), reward:500000, prog:()=>[getUpgTier('coin')+1,3] },
  { id:'upg_speed3',    cat:'Upgrades',   icon:'⚡', name:'Speed Demon',       desc:'Unlock Swift Fate (Speed III)',           req:()=>hasNode('speed3'), reward:500000, prog:()=>[getUpgTier('speed')+1,3] },
  { id:'upg_multiroll', cat:'Upgrades',   icon:'🎲', name:'Multi-Roller',      desc:'Unlock the Double Roll node',             req:()=>hasNode('double'), reward:100000 },
];

// Track unlocked achievements in S
function getAchState() {
  if (!S.achievements || typeof S.achievements !== 'object') S.achievements = {};
  return S.achievements;
}

let _lastAchCheck = 0;
function checkAchievements() {
  const now = Date.now();
  if (now - _lastAchCheck < 2000) return; // throttle
  _lastAchCheck = now;
  const state = getAchState();
  let anyNew = false;
  ACHIEVEMENTS.forEach(a => {
    if (!state[a.id] && a.req()) {
      state[a.id] = true;
      anyNew = true;
      // Award coins
      S.coins += a.reward;
      saveGame(false);
      // Toast
      setTimeout(() => notify('🏅 Achievement: ' + a.name + ' (+' + a.reward.toLocaleString() + ' coins)', 'ok'), 200);
    }
  });
  if (anyNew) {
    updateAchBadge();
    if (currentTab === 'ach') renderAch();
  }
}

function updateAchBadge() {
  const state = getAchState();
  const count = ACHIEVEMENTS.filter(a => state[a.id]).length;
  const el = document.getElementById('achBadge');
  if (el) el.textContent = count;
}

function renderAch() {
  const body = document.getElementById('achBody');
  if (!body) return;
  const state = getAchState();
  const total = ACHIEVEMENTS.length;
  const done = ACHIEVEMENTS.filter(a => state[a.id]).length;

  // Update header
  const sub = document.getElementById('achSubtitle');
  if (sub) sub.textContent = done + ' / ' + total + ' unlocked';
  const fill = document.getElementById('achProgressFill');
  if (fill) fill.style.width = ((done/total)*100).toFixed(1) + '%';
  updateAchBadge();

  // Group by category
  const cats = [...new Set(ACHIEVEMENTS.map(a => a.cat))];
  let html = '';
  cats.forEach(cat => {
    const achs = ACHIEVEMENTS.filter(a => a.cat === cat);
    html += '<div class="ach-section-title">' + cat + '</div><div class="ach-grid">';
    achs.forEach(a => {
      const unlocked = !!state[a.id];
      const prog = a.prog ? a.prog() : null;
      const pct = prog ? Math.min(100, (prog[0]/prog[1]*100)).toFixed(0) : 0;
      html += '<div class="ach-card' + (unlocked ? ' unlocked' : ' locked') + '">';
      html += '<div style="display:flex;align-items:center;gap:8px;">';
      html += '<div class="ach-icon">' + a.icon + '</div>';
      html += '<div class="ach-name">' + a.name + '</div>';
      html += '</div>';
      html += '<div class="ach-desc">' + a.desc + '</div>';
      html += '<div class="ach-reward">🪙 +' + a.reward.toLocaleString() + '</div>';
      if (!unlocked && prog) {
        html += '<div class="ach-prog"><div class="ach-prog-fill" style="width:' + pct + '%"></div></div>';
        html += '<div class="ach-prog-txt">' + prog[0].toLocaleString() + ' / ' + prog[1].toLocaleString() + '</div>';
      }
      html += '<div class="ach-check">' + (unlocked ? '✅' : '🔒') + '</div>';
      html += '</div>';
    });
    html += '</div>';
  });
  body.innerHTML = html;
}

// ══════════════════════════════════════════════════════════
// STATE
// ══════════════════════════════════════════════════════════
let S = {
  total:0, bestIdx:-1, coins:0, counts:{},
  inventory:{}, upgrades:{}, achievements:{}, playerName:'',
  activeLuck: null,   // kept for backward compat
  customRarities: []  // Custom admin-created rarities
};
ORDER.forEach(k => S.counts[k] = 0);

// ── XOR Memory Obfuscation ──────────────────────────────────
// coins and total are stored in memory XORed with a random session key.
// If someone uses a memory scanner (Chrome Memory tab) and searches for
// their coin count, they'll find garbage — not the real value.
// All normal game code works transparently through the Proxy.
(function _initXOR() {
  const _K = (Math.random() * 0x7FFFFFFF | 0) | 0xACE1; // random non-zero key
  const _enc = v => ((Math.floor(+v) || 0) ^ _K) >>> 0;
  const _dec = v => (v ^ _K) | 0; // signed int so negatives work (for bestIdx if ever needed)
  const _obf = { coins: _enc(0), total: _enc(0) };
  const _base = S;

  S = new Proxy(_base, {
    get(t, k) {
      if (k === 'coins') return _dec(_obf.coins);
      if (k === 'total') return _dec(_obf.total);
      return t[k];
    },
    set(t, k, v) {
      if (k === 'coins') { _obf.coins = _enc(v); return true; }
      if (k === 'total') { _obf.total = _enc(v); return true; }
      t[k] = v; return true;
    }
  });

  // Re-apply after confirmReset which replaces the S object entirely
  window._rewrapS = function(newS) {
    _obf.coins = _enc(newS.coins || 0);
    _obf.total = _enc(newS.total || 0);
  };
})();

let newItems = new Set();
let rolling = false, autoInt = null;
let cinematicActive = false, pendingResumeAuto = false;
let currentTab = 'roll', activeFilter = 'all';
let boostTick = null;
let gameStarted = false;

// ══════════════════════════════════════════════════════════
// ADMIN EMAIL WHITELIST
// ══════════════════════════════════════════════════════════
// Only these email addresses can access admin features
// ⚠️  SECURITY: Only add emails YOU personally control here.
// Anyone in this list gets full admin access to the panel.
// Email check is case-insensitive — always store as lowercase.
const ADMIN_EMAILS = [
  'guest93617@gmail.com',
  // 'trustedfriend@gmail.com',  // uncomment to add more admins
];

let currentUserEmail = null;
let isAdmin = false;

// ══════════════════════════════════════════════════════════
// CUSTOM RARITIES & ITEMS EDITOR SYSTEM
// ══════════════════════════════════════════════════════════
let customRarities = [];
let customItems = {};
let editingRarityIndex = null;
let editingItemKey = null;
let uploadedImageData = null;

// Load custom data from localStorage on init
function loadCustomData() {
  try {
    const saved = localStorage.getItem('fateRoll_customData');
    if (saved) {
      const data = JSON.parse(saved);
      customRarities = data.rarities || [];
      customItems = data.items || {};
      
      // Integrate custom rarities into RARITIES array
      customRarities.forEach(cr => {
        if (!RARITIES.find(r => r.key === cr.key)) {
          // Insert before common
          const ci = RARITIES.findIndex(r => r.key === 'common');
          if (ci >= 0) RARITIES.splice(ci, 0, cr);
          else RARITIES.push(cr);
          // ORDER
          const oi = ORDER.indexOf('common');
          if (oi >= 0) ORDER.splice(oi, 0, cr.key);
          else ORDER.push(cr.key);
          if (!ITEMS[cr.key]) ITEMS[cr.key] = [[cr.emoji || '⭐', cr.label]];
        }
      });
      // Recalculate thresholds after loading
      (function(){let c=0;RARITIES.forEach(r=>{c+=r.pct/100;r.threshold=Math.min(1,c);});RARITIES[RARITIES.length-1].threshold=1.0;})();
      
      // Integrate custom items into ITEMS
      Object.keys(customItems).forEach(rarityKey => {
        if (!ITEMS[rarityKey]) ITEMS[rarityKey] = [];
        customItems[rarityKey].forEach(item => {
          if (!ITEMS[rarityKey].find(i => i[0] === item[0] && i[1] === item[1])) {
            ITEMS[rarityKey].push(item);
          }
        });
      });
    }
  } catch(e) {
    console.error('Failed to load custom data:', e);
  }
}

// Save custom data to localStorage
function saveCustomData() {
  try {
    const data = {
      rarities: customRarities,
      items: customItems
    };
    localStorage.setItem('fateRoll_customData', JSON.stringify(data));
    return true;
  } catch(e) {
    console.error('Failed to save custom data:', e);
    return false;
  }
}

// Render rarities in editor
function renderEditorRarities() {
  const list = document.getElementById('editorRarityList');
  const select = document.getElementById('itemRaritySelect');
  if (!list || !select) return;
  
  list.innerHTML = '';
  let selectHTML = '<option value="">Choose a rarity...</option>';
  
  RARITIES.forEach((r, index) => {
    const isCustom = customRarities.find(cr => cr.key === r.key);
    const div = document.createElement('div');
    div.className = 'editor-rarity-item';
    div.innerHTML = `
      <div class="editor-rarity-color" style="background:${r.color}" onclick="editRarity(${index})"></div>
      <div class="editor-rarity-info">
        <div class="editor-rarity-name" style="color:${r.color}">${r.emoji||''} ${r.label}</div>
        <div class="editor-rarity-chance">${(r.chance||r.pct||0)}% chance</div>
      </div>
      <button class="editor-btn" onclick="editRarity(${index})">✏️ Edit</button>
      ${isCustom ? '<button class="editor-btn danger" onclick="deleteRarity('+index+')">🗑️ Delete</button>' : '<span style="font-size:.65rem;color:var(--muted);">Built-in</span>'}
    `;
    list.appendChild(div);
    
    selectHTML += `<option value="${r.key}">${r.emoji} ${r.label}</option>`;
  });
  
  select.innerHTML = selectHTML;
}

// Render items in editor
function renderEditorItems() {
  const rarityKey = document.getElementById('itemRaritySelect').value;
  const list = document.getElementById('editorItemList');
  if (!list) return;
  
  if (!rarityKey) {
    list.innerHTML = '<div style="grid-column:1/-1;text-align:center;color:var(--muted);padding:20px;">Select a rarity to view/edit items</div>';
    return;
  }
  
  const items = ITEMS[rarityKey] || [];
  const rarity = RARITIES.find(r => r.key === rarityKey);
  
  if (items.length === 0) {
    list.innerHTML = '<div style="grid-column:1/-1;text-align:center;color:var(--muted);padding:20px;">No items yet. Add one below!</div>';
    return;
  }
  
  list.innerHTML = '';
  items.forEach((item, index) => {
    const [emoji, name] = item;
    const isImage = emoji.startsWith('data:image');
    const itemKey = `${rarityKey}|${index}`;
    const isCustom = customItems[rarityKey] && customItems[rarityKey].find(ci => ci[1] === name);
    
    const div = document.createElement('div');
    div.className = 'editor-item-card';
    div.style.borderColor = rarity.color + '40';
    div.innerHTML = `
      <div class="editor-item-preview">
        <div class="editor-item-emoji">
          ${isImage ? '<img src="'+emoji+'">' : emoji}
        </div>
        <div class="editor-item-details">
          <div class="editor-item-name">${name}</div>
          <div class="editor-item-rarity" style="color:${rarity.color}">${rarity.label}</div>
        </div>
      </div>
      <div class="editor-item-actions">
        <button class="editor-btn" onclick="editItem('${rarityKey}',${index})" style="flex:1;">✏️ Edit</button>
        ${isCustom ? '<button class="editor-btn danger" onclick="deleteItem(\''+rarityKey+'\','+index+')">🗑️</button>' : '<span style="font-size:.6rem;color:var(--muted);padding:6px;">Built-in</span>'}
      </div>
    `;
    list.appendChild(div);
  });
}

// Save/Edit rarity
window.saveRarity = function() {
  const name = document.getElementById('rarityName').value.trim();
  const color = document.getElementById('rarityColor').value.trim();
  const chance = parseFloat(document.getElementById('rarityChance').value);
  const emoji = document.getElementById('rarityEmoji').value.trim();
  
  if (!name || !color || !chance || !emoji) {
    notify('Please fill all rarity fields', 'err');
    return;
  }
  
  if (chance <= 0 || chance > 100) {
    notify('Chance must be between 0 and 100', 'err');
    return;
  }
  
  const key = name.toLowerCase().replace(/[^a-z0-9]/g, '_');
  
  if (editingRarityIndex !== null) {
    // Edit existing rarity
    const rarity = RARITIES[editingRarityIndex];
    const customIndex = customRarities.findIndex(cr => cr.key === rarity.key);
    
    rarity.label = name;
    rarity.color = color;
    rarity.chance = chance;
    rarity.emoji = emoji;
    
    if (customIndex >= 0) {
      customRarities[customIndex] = rarity;
    }
    
    notify('Rarity updated!', 'ok');
    editingRarityIndex = null;
    document.querySelector('#rarityForm .editor-btn.primary').textContent = '➕ CREATE RARITY';
  } else {
    // Add new rarity
    if (RARITIES.find(r => r.key === key)) {
      notify('Rarity with this name already exists', 'err');
      return;
    }
    
    const newRarity = {
      key: key,
      label: name,
      emoji: emoji,
      color: color,
      chance: chance,
      fx: 1 // default effect level
    };
    
    RARITIES.push(newRarity);
    ORDER.push(key);
    ITEMS[key] = [];
    customRarities.push(newRarity);
    
    notify('Custom rarity added!', 'ok');
  }
  
  saveCustomData();
  renderEditorRarities();
  renderEditorItems();
  updateUI();
  
  // Clear form
  document.getElementById('rarityName').value = '';
  document.getElementById('rarityColor').value = '';
  document.getElementById('rarityChance').value = '';
  document.getElementById('rarityEmoji').value = '';
};

// Edit rarity
window.editRarity = function(index) {
  editingRarityIndex = index;
  const rarity = RARITIES[index];
  
  document.getElementById('rarityName').value = rarity.label;
  document.getElementById('rarityColor').value = rarity.color;
  document.getElementById('rarityColorPicker').value = rarity.color;
  document.getElementById('rarityChance').value = rarity.chance || rarity.pct || '';
  document.getElementById('rarityEmoji').value = rarity.emoji || '';
  
  document.querySelector('#rarityForm .editor-btn.primary').textContent = '💾 UPDATE RARITY';
  document.getElementById('rarityName').scrollIntoView({behavior: 'smooth', block: 'center'});
  notify('Editing rarity - click Update to save changes', 'info');
};

// Delete rarity
window.deleteRarity = function(index) {
  const rarity = RARITIES[index];
  const isCustom = customRarities.find(cr => cr.key === rarity.key);
  
  if (!isCustom) {
    notify('Cannot delete built-in rarities', 'err');
    return;
  }
  
  if (!confirm(`Delete rarity "${rarity.label}" and all its items?`)) return;
  
  // Remove from arrays
  RARITIES.splice(index, 1);
  const orderIndex = ORDER.indexOf(rarity.key);
  if (orderIndex >= 0) ORDER.splice(orderIndex, 1);
  delete ITEMS[rarity.key];
  delete customItems[rarity.key];
  
  const customIndex = customRarities.findIndex(cr => cr.key === rarity.key);
  if (customIndex >= 0) customRarities.splice(customIndex, 1);
  
  saveCustomData();
  renderEditorRarities();
  renderEditorItems();
  updateUI();
  notify('Rarity deleted', 'ok');
};

// Handle image upload
window.handleImageUpload = function(event) {
  const file = event.target.files[0];
  if (!file) return;
  
  if (!file.type.startsWith('image/')) {
    notify('Please upload an image file', 'err');
    return;
  }
  
  const reader = new FileReader();
  reader.onload = function(e) {
    uploadedImageData = e.target.result;
    document.getElementById('imagePreview').style.display = 'block';
    document.getElementById('imagePreviewImg').src = uploadedImageData;
    document.getElementById('itemEmoji').value = '[IMAGE]';
    notify('Image uploaded! Click Create to save item', 'ok');
  };
  reader.readAsDataURL(file);
};

// Save/Edit item
window.saveItem = function() {
  const rarityKey = document.getElementById('itemRaritySelect').value;
  const name = document.getElementById('itemName').value.trim();
  let emoji = document.getElementById('itemEmoji').value.trim();
  
  if (!rarityKey) {
    notify('Please select a rarity first', 'err');
    return;
  }
  
  if (!name) {
    notify('Please enter an item name', 'err');
    return;
  }
  
  if (!emoji && !uploadedImageData) {
    notify('Please enter an emoji or upload an image', 'err');
    return;
  }
  
  // Use uploaded image if available
  if (uploadedImageData) {
    emoji = uploadedImageData;
  }
  
  if (editingItemKey) {
    // Edit existing item
    const [editRarityKey, editIndex] = editingItemKey.split('|');
    const index = parseInt(editIndex);
    ITEMS[editRarityKey][index] = [emoji, name];
    
    // Update custom items if it exists there
    if (customItems[editRarityKey]) {
      const customIndex = customItems[editRarityKey].findIndex(ci => ci[1] === name);
      if (customIndex >= 0) {
        customItems[editRarityKey][customIndex] = [emoji, name];
      }
    }
    
    notify('Item updated!', 'ok');
    editingItemKey = null;
  } else {
    // Add new item
    if (!ITEMS[rarityKey]) ITEMS[rarityKey] = [];
    ITEMS[rarityKey].push([emoji, name]);
    
    if (!customItems[rarityKey]) customItems[rarityKey] = [];
    customItems[rarityKey].push([emoji, name]);
    
    notify('Custom item added!', 'ok');
  }
  
  saveCustomData();
  renderEditorItems();
  
  // Clear form
  document.getElementById('itemName').value = '';
  document.getElementById('itemEmoji').value = '';
  document.getElementById('itemImageUpload').value = '';
  document.getElementById('imagePreview').style.display = 'none';
  uploadedImageData = null;
};

// Edit item
window.editItem = function(rarityKey, index) {
  const item = ITEMS[rarityKey][index];
  const [emoji, name] = item;
  
  editingItemKey = `${rarityKey}|${index}`;
  document.getElementById('itemRaritySelect').value = rarityKey;
  document.getElementById('itemName').value = name;
  
  if (emoji.startsWith('data:image')) {
    uploadedImageData = emoji;
    document.getElementById('imagePreview').style.display = 'block';
    document.getElementById('imagePreviewImg').src = emoji;
    document.getElementById('itemEmoji').value = '[IMAGE]';
  } else {
    document.getElementById('itemEmoji').value = emoji;
    uploadedImageData = null;
  }
  
  renderEditorItems();
  document.getElementById('itemName').scrollIntoView({behavior: 'smooth', block: 'center'});
  notify('Editing item - click Create to save changes', 'info');
};

// Delete item
window.deleteItem = function(rarityKey, index) {
  const item = ITEMS[rarityKey][index];
  const isCustom = customItems[rarityKey] && customItems[rarityKey].find(ci => ci[1] === item[1]);
  
  if (!isCustom) {
    notify('Cannot delete built-in items', 'err');
    return;
  }
  
  if (!confirm(`Delete item "${item[1]}"?`)) return;
  
  ITEMS[rarityKey].splice(index, 1);
  
  const customIndex = customItems[rarityKey].findIndex(ci => ci[1] === item[1]);
  if (customIndex >= 0) {
    customItems[rarityKey].splice(customIndex, 1);
  }
  
  saveCustomData();
  renderEditorItems();
  notify('Item deleted', 'ok');
};

// Export custom data
window.exportCustomData = function() {
  const data = {
    rarities: customRarities,
    items: customItems,
    exportDate: new Date().toISOString()
  };
  
  const blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'fate-roll-custom-data.json';
  a.click();
  URL.revokeObjectURL(url);
  
  notify('Custom data exported!', 'ok');
};

// Import custom data
window.importCustomData = function() {
  const input = document.createElement('input');
  input.type = 'file';
  input.accept = 'application/json';
  input.onchange = function(e) {
    const file = e.target.files[0];
    if (!file) return;
    
    const reader = new FileReader();
    reader.onload = function(event) {
      try {
        const data = JSON.parse(event.target.result);
        
        if (!data.rarities || !data.items) {
          notify('Invalid custom data file', 'err');
          return;
        }
        
        customRarities = data.rarities;
        customItems = data.items;
        
        // Clear existing custom data from arrays
        RARITIES = RARITIES.filter(r => !customRarities.find(cr => cr.key === r.key));
        ORDER = ORDER.filter(k => !customRarities.find(cr => cr.key === k));
        
        // Re-add imported data
        customRarities.forEach(cr => {
          RARITIES.push(cr);
          ORDER.push(cr.key);
          if (!ITEMS[cr.key]) ITEMS[cr.key] = [];
        });
        
        Object.keys(customItems).forEach(rarityKey => {
          customItems[rarityKey].forEach(item => {
            if (!ITEMS[rarityKey].find(i => i[0] === item[0] && i[1] === item[1])) {
              ITEMS[rarityKey].push(item);
            }
          });
        });
        
        saveCustomData();
        renderEditorRarities();
        renderEditorItems();
        updateUI();
        
        notify('Custom data imported!', 'ok');
      } catch(err) {
        console.error(err);
        notify('Failed to import data', 'err');
      }
    };
    reader.readAsText(file);
  };
  input.click();
};

// Reset custom data
window.resetCustomData = function() {
  if (!confirm('This will delete ALL custom rarities and items. Are you sure?')) return;
  
  // Remove custom rarities from RARITIES
  customRarities.forEach(cr => {
    const index = RARITIES.findIndex(r => r.key === cr.key);
    if (index >= 0) RARITIES.splice(index, 1);
    
    const orderIndex = ORDER.indexOf(cr.key);
    if (orderIndex >= 0) ORDER.splice(orderIndex, 1);
    
    delete ITEMS[cr.key];
  });
  
  // Remove custom items from ITEMS
  Object.keys(customItems).forEach(rarityKey => {
    if (ITEMS[rarityKey]) {
      customItems[rarityKey].forEach(customItem => {
        const index = ITEMS[rarityKey].findIndex(i => i[1] === customItem[1]);
        if (index >= 0) ITEMS[rarityKey].splice(index, 1);
      });
    }
  });
  
  customRarities = [];
  customItems = {};
  
  localStorage.removeItem('fateRoll_customData');
  
  renderEditorRarities();
  renderEditorItems();
  updateUI();
  
  notify('All custom data reset', 'ok');
};

// ══════════════════════════════════════════════════════════
// FIREBASE CONFIG - Replace with your own Firebase config
// ══════════════════════════════════════════════════════════
// SETUP INSTRUCTIONS:
// 1. Create a Firebase project at https://console.firebase.google.com/
// 2. Enable Realtime Database in your project
// 3. Enable Google Authentication (Authentication → Sign-in method → Google)
// 4. Get your config from Project Settings → Your apps → Web app
// 5. Replace the values below with your actual Firebase config
// 6. See FIREBASE_SETUP.md for detailed instructions
//
// NOTE: The game will work without Firebase, but the leaderboard won't function.
// All other features (rolling, inventory, shop, etc.) work perfectly offline.
// Admin features require Google Sign-In to be enabled in Firebase.
// ══════════════════════════════════════════════════════════

// ╔══════════════════════════════════════════════════════════════╗
// ║  SECURITY CHECKLIST — DO THESE IN FIREBASE CONSOLE          ║
// ║  1. Authentication → Settings → Authorized Domains          ║
// ║     Only: localhost + ibunnz.github.io                      ║
// ║  2. Realtime Database → Rules → paste these rules:          ║
// ║     { "rules": { "leaderboard": {                           ║
// ║       ".read": true,                                        ║
// ║       "$uid": { ".write": "auth != null &&                  ║
// ║                 $uid === auth.uid" } } } }                  ║
// ║  3. NEVER put Admin SDK JSON or private_key here            ║
// ║  The apiKey below is PUBLIC by design — that's fine.        ║
// ╚══════════════════════════════════════════════════════════════╝
// ══════════════════════════════════════════════════════════
// SUPABASE CONFIG
// ══════════════════════════════════════════════════════════
// 1. Go to https://supabase.com and create a project
// 2. Go to Project Settings → API
// 3. Copy your Project URL and anon/public key and paste below
// ══════════════════════════════════════════════════════════
const SUPABASE_URL  = 'https://zcmujmqgfkxygzwefrbo.supabase.co';   // e.g. https://xyzxyz.supabase.co
const SUPABASE_ANON = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InpjbXVqbXFnZmt4eWd6d2VmcmJvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE1NjIyNjMsImV4cCI6MjA4NzEzODI2M30.UjoGHRkwhItCB7cQgUpuRWcW-BJPIUgmsKCyav9mbo4'; // safe to expose — RLS protects data

let sbClient = null;
let sbUser   = null;
let SUPABASE_READY = false;

function initSupabase() {
  try {
    if (SUPABASE_URL === 'YOUR_SUPABASE_URL') return; // not configured yet
    const { createClient } = window.supabase;
    sbClient = createClient(SUPABASE_URL, SUPABASE_ANON);
    SUPABASE_READY = true;

    // Auth state listener — fires on sign-in, sign-out, token refresh
    sbClient.auth.onAuthStateChange(async (event, session) => {
      sbUser = session?.user || null;
      const email = sbUser?.email || null;
      currentUserEmail = email;
      isAdmin = email ? ADMIN_EMAILS.some(e => e.toLowerCase() === email.toLowerCase()) : false;

      if (isAdmin) {
        window._restoreConsole && window._restoreConsole();
        window._unlockCodeExec && window._unlockCodeExec();
      } else {
        window._silenceConsole && window._silenceConsole();
        window._lockCodeExec && window._lockCodeExec();
      }
      updateAdminUI();

      // If user just signed in on the username screen, move to username step
      const signInStep   = document.getElementById('signInStep');
      const usernameStep = document.getElementById('usernameStep');
      const emailDisplay = document.getElementById('signedInEmail');
      if (signInStep && usernameStep && email && signInStep.style.display !== 'none') {
        signInStep.style.display   = 'none';
        usernameStep.style.display = 'block';
        if (emailDisplay) emailDisplay.textContent = email;
        setTimeout(() => { const i = document.getElementById('unInput'); if(i) i.focus(); }, 100);
      }

      // Update board ID to use server-verified UID
      if (sbUser) myBoardId = sbUser.id;
    });
  } catch(e) {
    SUPABASE_READY = false;
  }
}

// Update UI based on admin status
function updateAdminUI() {
  const adminBtn = document.getElementById('adminBtn');
  const signInBtn = document.getElementById('signInBtn');
  
  if (signInBtn) {
    // Show Sign In button when not signed in, hide when signed in
    signInBtn.style.display = currentUserEmail ? 'none' : '';
    // Update text if signed in but not admin
    if (currentUserEmail && !isAdmin) {
      signInBtn.style.display = '';
      signInBtn.textContent = '👤 ' + currentUserEmail.split('@')[0];
      signInBtn.onclick = signOutAdmin;
    }
  }
  
  if (adminBtn) {
    // Show Admin button only if user is admin
    adminBtn.style.display = isAdmin ? '' : 'none';
  }
  
  // Show Editor tab only for admins
  const editorTab = document.getElementById('tab-editor');
  if (editorTab) {
    editorTab.style.display = isAdmin ? '' : 'none';
  }
}
// ══════════════════════════════════════════════════════════
// USERNAME CONTENT FILTER
// ══════════════════════════════════════════════════════════
const BLOCKED_WORDS = [
  // Racial slurs and variants
  'nig','niga','nigg','nigr','n1g','n1gg','niqq','niqa','niqg',
  // Common profanity
  'fuck','fuk','fck','f4ck','fuq','phuck',
  'shit','sh1t','sht','shyt',
  'bitch','b1tch','btch','biatch',
  'ass','a55','azz','asz',
  'dick','d1ck','dik','dck',
  'cock','c0ck','cok','cck',
  'cunt','cnt','kunt',
  'damn','dmn','dam',
  'hell','hel','h3ll',
  // Other offensive terms
  'fag','f4g','phag',
  'retard','tard','r3tard',
  'rape','r4pe','rpe',
  'nazi','nzi','n4zi',
  'kill','kil','kll','k1ll',
  'die','d1e',
  'kys',
  // Add more as needed
];

function containsBlockedContent(username) {
  const clean = username.toLowerCase().replace(/[^a-z0-9]/g, '');
  
  // Check for exact matches and substrings
  for (const word of BLOCKED_WORDS) {
    if (clean.includes(word)) {
      return true;
    }
  }
  
  // Check for leet speak variations
  const leet = clean
    .replace(/0/g, 'o')
    .replace(/1/g, 'i')
    .replace(/3/g, 'e')
    .replace(/4/g, 'a')
    .replace(/5/g, 's')
    .replace(/7/g, 't')
    .replace(/8/g, 'b');
  
  for (const word of BLOCKED_WORDS) {
    if (leet.includes(word)) {
      return true;
    }
  }
  
  return false;
}

// ══════════════════════════════════════════════════════════
// USERNAME
// ══════════════════════════════════════════════════════════
async function startGame() {
  const v = document.getElementById('unInput').value.trim();
  const err = document.getElementById('unErr');
  
  // Length check
  if (v.length < 3 || v.length > 20) { 
    err.textContent = 'Username must be 3-20 characters';
    err.style.display = 'block'; 
    return; 
  }
  
  // Content filter check
  if (containsBlockedContent(v)) {
    err.textContent = 'Username contains inappropriate content';
    err.style.display = 'block';
    return;
  }
  
  err.style.display = 'none';
  S.playerName = v.replace(/[<>&"'`]/g, '').trim();
  document.getElementById('un-screen').style.display = 'none';
  gameStarted = true;

  // Silently sign in anonymously so every player has a server-verified UID
  if (SUPABASE_READY && sbClient && !sbUser) {
    try { 
      const { data } = await sbClient.auth.signInAnonymously();
      if (data?.user) { sbUser = data.user; myBoardId = data.user.id; }
    } catch(e) { /* continue offline */ }
  }

  saveGame(false);
  updateUI();
  submitScore().then(() => loadBoard(false));
  updateAchBadge();
}

// ══════════════════════════════════════════════════════════
// SAVE / LOAD
// ══════════════════════════════════════════════════════════
function _makeIntegrity(s) {
  // Simple checksum — hard to fake without knowing the formula
  const v = (s.coins * 7 + s.total * 13 + s.bestIdx * 31 + (s.playerName||'').length * 17) ^ 0xF8A3C21E;
  return (v >>> 0).toString(16);
}

function saveGame(showMsg = true) {
  try {
    const snap = {...S};
    // Serialize inventory (convert rarity object to key only)
    const inv = {};
    Object.entries(S.inventory).forEach(([k,v]) => {
      inv[k] = {...v, rarity:{key:v.rarity.key}};
    });
    snap.inventory = inv;
    snap._ic = _makeIntegrity(S); // integrity checksum
    localStorage.setItem('fate_v5', JSON.stringify(snap));
  } catch(e) {}
  if (showMsg) notify('Saved!', 'ok');
}

function loadGame() {
  try {
    const raw = localStorage.getItem('fate_v5');
    if (raw) {
      const d = JSON.parse(raw);
      // Integrity check — detect manual localStorage edits
      if (d._ic !== undefined) {
        const stored = d._ic;
        delete d._ic;
        const expected = _makeIntegrity(d);
        if (stored !== expected) {
          // Tampered save detected — reset coins and flag
          d.coins = 0;
          d.total = Math.max(0, Math.floor(d.total));
          d.bestIdx = -1;
          // Remove from leaderboard on next submit by zeroing
          setTimeout(() => notify('Save data corrupted. Progress reset.', 'err'), 1500);
        }
      }
      // Rehydrate rarity objects
      if (d.inventory) {
        Object.entries(d.inventory).forEach(([k,v]) => {
          const r = RARITIES.find(x => x.key === (v.rarity?.key)) || RARITIES[RARITIES.length-1];
          d.inventory[k].rarity = r;
        });
      }
      // Sanity cap — prevent absurd values
      if (d.coins > 999999999) d.coins = 999999999;
      if (d.total > 999999999) d.total = 999999999;
      ORDER.forEach(k => { if(!d.counts) d.counts={}; if(d.counts[k]===undefined) d.counts[k]=0; });
      // Migrate old upgrades to tree node format
      if (Array.isArray(d.upgrades)) d.upgrades = {};
      if (d.upgrades && typeof d.upgrades === 'object') {
        const old = d.upgrades;
        // If old format (luck:N numbers), convert to node IDs
        if (typeof old.luck === 'number' || typeof old.coin === 'number' || typeof old.speed === 'number') {
          const newUpg = {};
          const lNodes = ['luck1','luck2','luck3','luck4','luck5'];
          const cNodes = ['coin1','coin2','coin3','coin4','coin5'];
          const sNodes = ['speed1','speed2','speed3','speed4','speed5'];
          if (typeof old.luck  === 'number') for(let i=0;i<=old.luck  && i<lNodes.length;i++) newUpg[lNodes[i]]=true;
          if (typeof old.coin  === 'number') for(let i=0;i<=old.coin  && i<cNodes.length;i++) newUpg[cNodes[i]]=true;
          if (typeof old.speed === 'number') for(let i=0;i<=old.speed && i<sNodes.length;i++) newUpg[sNodes[i]]=true;
          d.upgrades = newUpg;
        }
      }
      if (!d.achievements) d.achievements = {};
      Object.assign(S, d);
    }
  } catch(e) { /* silent */ }
}

function confirmReset() {
  closeModal('resetMod');
  const name = S.playerName;
  // Reset fields individually so the XOR proxy stays intact
  S.total = 0; S.bestIdx = -1; S.coins = 0;
  S.inventory = {}; S.upgrades = {}; S.achievements = {}; S.playerName = name; S.activeLuck = null;
  S.counts = {};
  ORDER.forEach(k => S.counts[k] = 0);
  newItems.clear();
  localStorage.removeItem('fate_v5');
  document.getElementById('histList').innerHTML = '';
  document.getElementById('idleMsg').style.display = '';
  document.getElementById('cardWrap').style.display = 'none';
  document.getElementById('rollLbl').style.visibility = 'hidden';
  updateUI(); renderInv();
  notify('Progress reset.', 'info');
}

// ══════════════════════════════════════════════════════════
// LEADERBOARD — Supabase
// Score submissions go through the Edge Function (server validates).
// Direct client writes are blocked by Row Level Security (RLS).
// ══════════════════════════════════════════════════════════
const BOARD_PREFIX = 'fate_brd_';

function _getBoardId() {
  if (sbUser?.id) return sbUser.id;
  let id = localStorage.getItem('fate_bid2');
  if (!id) {
    const ts  = Date.now().toString(36);
    const rnd = Math.random().toString(36).replace(/[^a-z0-9]/g,'').slice(0,8);
    id = ts + '_' + rnd;
    localStorage.setItem('fate_bid2', id);
  }
  return id;
}
let myBoardId = _getBoardId();

let lastScoreSubmit = 0;

async function submitScore() {
  if (!SUPABASE_READY) return false;
  if (!S.playerName || S.playerName.length < 1) return false;
  if (S._flagged) return false;

  const now = Date.now();
  if (now - lastScoreSubmit < 10000) return false;

  // ── CLIENT-SIDE INPUT VALIDATION ─────────────────────────────────
  const rawCoins = S.coins;
  if (typeof rawCoins !== 'number' || !isFinite(rawCoins) || isNaN(rawCoins)) return false;
  if (rawCoins < 0) return false;
  const safeCoins = Math.floor(rawCoins);

  const rawRolls = S.total;
  if (typeof rawRolls !== 'number' || !isFinite(rawRolls) || isNaN(rawRolls)) return false;
  if (rawRolls < 0) return false;
  const safeRolls = Math.floor(rawRolls);

  const MAX_PER_ROLL = 150000 * getCoinMult(); // account for coin multiplier upgrade
  if (safeRolls > 0 && safeCoins > safeRolls * MAX_PER_ROLL * 3) return false;

  const cappedCoins = Math.min(safeCoins, 999999999);
  const cappedRolls = Math.min(safeRolls, 999999999);

  const rawName = S.playerName;
  if (typeof rawName !== 'string') return false;
  const safeName = rawName.slice(0, 20).replace(/[<>&"'`\\]/g, '').trim();
  if (!safeName || safeName.length < 3) return false;

  const rawBest = S.bestIdx;
  if (typeof rawBest !== 'number' || !isFinite(rawBest) || isNaN(rawBest)) return false;
  if (rawBest < -1 || rawBest >= ORDER.length) return false;

  const bestLabel = rawBest >= 0
    ? (RARITIES.find(r => r.key === ORDER[rawBest])?.label || '—')
    : '—';

  try {
    myBoardId = _getBoardId();

    // ── Edge Function path (server re-validates independently) ────────
    const { data, error } = await sbClient.functions.invoke('submit-score', {
      body: { name: safeName, coins: cappedCoins, rolls: cappedRolls, best: bestLabel }
    });
    if (!error && data?.success) { lastScoreSubmit = now; return true; }

    // ── Fallback: direct upsert (protected by RLS) ────────────────────
    if (sbUser) {
      const { error: upsertErr } = await sbClient
        .from('leaderboard')
        .upsert({
          uid: myBoardId, name: safeName, coins: cappedCoins,
          rolls: cappedRolls, best: bestLabel,
          updated_at: new Date().toISOString()
        }, { onConflict: 'uid' });
      if (!upsertErr) { lastScoreSubmit = now; return true; }
    }
    return false;
  } catch(e) {
    return false;
  }
}

let lastBoardLoad = 0;
let leaderboardListener = null;
let isListenerActive = false;

async function loadBoard(showMsg = true, forceRefresh = false) {
  const now = Date.now();
  if (!forceRefresh && showMsg && now - lastBoardLoad < 10000) {
    notify('Please wait a moment before refreshing again', 'info');
    return;
  }
  lastBoardLoad = now;
  const listEl   = document.getElementById('boardList');
  const statusEl = document.getElementById('boardStatus');

  if (!SUPABASE_READY) {
    listEl.innerHTML = `<div class="board-loading">
      <div style="font-size:2rem;margin-bottom:12px;">⚡</div>
      <div style="font-weight:700;margin-bottom:8px;">Leaderboard Not Set Up</div>
      <div style="color:var(--muted);font-size:.8rem;line-height:1.6;max-width:400px;margin:0 auto;">
        Add your Supabase URL and anon key to the top of the game file to enable the global leaderboard.<br><br>
        All other game features work perfectly without it!
      </div>
    </div>`;
    return;
  }

  statusEl.innerHTML = '<span class="board-dot" style="background:#fbbf24"></span><span>Submitting your score...</span>';

  if (gameStarted) {
    const oldLastSubmit = lastScoreSubmit;
    if (forceRefresh) lastScoreSubmit = 0;
    await submitScore();
    if (forceRefresh) lastScoreSubmit = now;
  }

  if (isListenerActive && !forceRefresh) {
    if (showMsg) notify('Board updated!', 'ok');
    return;
  }

  statusEl.innerHTML = '<span class="board-dot" style="background:#38bdf8"></span><span>Fetching rankings...</span>';

  try {
    const { data, error } = await sbClient
      .from('leaderboard')
      .select('uid, name, coins, rolls, best')
      .order('coins', { ascending: false })
      .limit(50);

    if (error) throw error;
    if (!data || data.length === 0) {
      statusEl.innerHTML = '';
      listEl.innerHTML = '<div class="board-loading">No entries yet — be the first!</div>';
      return;
    }

    const entries = data.map(r => ({ id: r.uid, ...r }));
    const liveTag = isListenerActive ? ' • Live' : '';
    statusEl.innerHTML = `<span class="board-dot" style="background:#4ade80"></span><span>${entries.length} player${entries.length!==1?'s':''} ranked${liveTag}</span>`;
    renderBoard(entries);
    if (showMsg) notify('Board updated!', 'ok');
  } catch(e) {
    statusEl.innerHTML = '';
    listEl.innerHTML = `<div class="board-loading" style="color:#f43f5e">Error loading leaderboard.<br>Please try again later.</div>`;
  }
}

function renderBoard(entries) {
  const list = document.getElementById('boardList');
  list.innerHTML = '';
  const medals = ['🥇','🥈','🥉'];
  if (!entries.length) {
    list.innerHTML = '<div class="board-loading">No entries!</div>';
    return;
  }
  entries.slice(0, 50).forEach((e, i) => {
    const isMe = e.id === myBoardId;
    const rank = i + 1;
    const div = document.createElement('div');
    div.className = 'board-entry' + (isMe?' me':'') +
      (rank===1?' top1':rank===2?' top2':rank===3?' top3':'');
    const rStr = rank <= 3
      ? `<span style="font-size:1.08rem">${medals[rank-1]}</span>`
      : `<span class="board-rank" style="color:var(--muted)">#${rank}</span>`;
    const col = (e.best && e.best !== '—')
      ? (RARITIES.find(r => r.label === e.best)?.color || 'var(--muted)')
      : 'var(--muted)';
    div.innerHTML = `${rStr}
      <span class="board-name">${esc(e.name||'?')}${isMe?'<span class="you-tag">YOU</span>':''}</span>
      <span class="board-coins">🪙 ${(e.coins||0).toLocaleString()}</span>
      <span class="board-rolls">${(e.rolls||0).toLocaleString()}</span>
      <span class="board-best" style="color:${col}">${esc(e.best||'—')}</span>`;
    list.appendChild(div);
  });
}
function esc(s){ return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }

// ══════════════════════════════════════════════════════════
// REAL-TIME LEADERBOARD — Supabase Realtime
// ══════════════════════════════════════════════════════════
function startLeaderboardListen() {
  if (!SUPABASE_READY) return;
  stopLeaderboardListen();
  isListenerActive = true;

  leaderboardListener = sbClient
    .channel('leaderboard-changes')
    .on('postgres_changes', { event: '*', schema: 'public', table: 'leaderboard' }, async () => {
      // Re-fetch sorted data whenever any row changes
      const { data } = await sbClient
        .from('leaderboard')
        .select('uid, name, coins, rolls, best')
        .order('coins', { ascending: false })
        .limit(50);

      if (!data) return;
      const entries = data.map(r => ({ id: r.uid, ...r }));
      const statusEl = document.getElementById('boardStatus');
      if (statusEl) statusEl.innerHTML = `<span class="board-dot" style="background:#4ade80"></span><span>${entries.length} player${entries.length!==1?'s':''} ranked • Live</span>`;
      renderBoard(entries);
    })
    .subscribe();
}

function stopLeaderboardListen() {
  if (leaderboardListener) {
    sbClient.removeChannel(leaderboardListener);
    leaderboardListener = null;
  }
  isListenerActive = false;
}

// ══════════════════════════════════════════════════════════
// BOOST SYSTEM
// ══════════════════════════════════════════════════════════
function getLuckShift() {
  return getLuckShiftUpg();
}

function updateBoostUI() {
  // Boost pill shows luck upgrade tier if owned
  const pill = document.getElementById('boostPill');
  const t = getUpgTier('luck');
  if (t >= 0) {
    pill.classList.add('on');
    document.getElementById('boostTxt').textContent = '🍀 LUCK';
    const lLabels=['Lucky Start','Fortune','Blessed','Fated','Destiny']; document.getElementById('boostTimer').textContent = lLabels[t]||'';
  } else {
    pill.classList.remove('on');
  }
}

function fmtTime(s) {
  if (s >= 3600) return Math.floor(s/3600)+'h '+Math.floor((s%3600)/60)+'m';
  if (s >= 60) return Math.floor(s/60)+'m '+('0'+Math.floor(s%60)).slice(-2)+'s';
  return s+'s';
}

function startBoostTick() {
  // No timed boosts anymore — keep function for compat
  updateBoostUI();
}

function buyTreeNode(id) {
  const n = TREE_NODES[id];
  if (!n) return;
  if (!S.upgrades || typeof S.upgrades !== 'object' || Array.isArray(S.upgrades)) S.upgrades = {};
  if (hasNode(id)) { notify('Already owned!', 'info'); return; }
  if (!canUnlock(id)) { notify('Unlock prerequisites first!', 'err'); return; }
  if (S.coins < n.coins) { notify('Not enough coins! Need ' + n.coins.toLocaleString(), 'err'); return; }
  if (S.total < n.rolls) { notify('Need ' + n.rolls.toLocaleString() + ' total rolls first!', 'err'); return; }
  S.coins -= n.coins;
  S.upgrades[id] = true;
  if (n.tree === 'speed' && autoInt) { stopAuto(); toggleAuto(); }
  updateUI();
  renderShop();
  saveGame(false);
  notify('Unlocked: ' + n.label + '!', 'ok');
}

// Legacy shim
function buyUpgrade(type) { buyTreeNode(type); }

// ══════════════════════════════════════════════════════════
// BUILD TABLE & FILTERS
// ══════════════════════════════════════════════════════════
(function buildTable() {
  const t = document.getElementById('rarTable');
  // Use log scale for bars so ultra-rare rarities are still visible
  const logPcts = RARITIES.map(r => Math.log10(r.pct + 0.000001) + 7);
  const maxLog = Math.max(...logPcts);
  RARITIES.forEach((r, i) => {
    const w = Math.max(1, (logPcts[i] / maxLog) * 100).toFixed(1);
    const pct = r.pct;
    let pStr, oneIn;
    if (pct < 0.0001) {
      pStr = pct.toExponential(1) + '%';
    } else if (pct < 0.001) {
      pStr = pct.toFixed(5) + '%';
    } else if (pct < 0.01) {
      pStr = pct.toFixed(4) + '%';
    } else if (pct < 0.1) {
      pStr = pct.toFixed(3) + '%';
    } else if (pct < 1) {
      pStr = pct.toFixed(2) + '%';
    } else {
      pStr = pct.toFixed(1) + '%';
    }
    const oneInNum = Math.round(100 / pct);
    if (oneInNum >= 1000000) oneIn = '1 in ' + (oneInNum/1000000).toFixed(1) + 'M';
    else if (oneInNum >= 1000) oneIn = '1 in ' + (oneInNum/1000).toFixed(oneInNum<10000?1:0) + 'K';
    else oneIn = '1 in ' + oneInNum;
    const row = document.createElement('div'); row.className = 'rar-row';
    row.innerHTML = `<span class="rar-name" style="color:${r.color}">${r.label}</span>
      <span class="rar-pct">${pStr}</span>
      <span class="rar-1in" style="color:${r.color}88">${oneIn}</span>
      <div class="bar-bg"><div class="bar-fill" style="width:${w}%;background:${r.color};box-shadow:0 0 6px ${r.color}55"></div></div>
      <span class="rar-cnt" id="cnt-${r.key}">0</span>`;
    t.appendChild(row);
  });
})();

(function buildFilters() {
  const tb = document.getElementById('invToolbar');
  const sort = document.getElementById('invSort');
  RARITIES.forEach(r => {
    const btn = document.createElement('button'); btn.className = 'inv-filt';
    btn.id = 'filt-'+r.key; btn.textContent = r.label;
    btn.style.color = r.color; btn.style.borderColor = r.color+'44';
    btn.onclick = () => setFilter(r.key);
    tb.insertBefore(btn, sort);
  });
})();

// ══════════════════════════════════════════════════════════
// ROLL ENGINE
// ══════════════════════════════════════════════════════════
function getRarity(v) {
  const shift = getLuckShift();
  if (shift > 0) v = Math.pow(v, 1 + shift * 2.2); // power bias toward 0 = rarer
  for (const r of RARITIES) if (v < r.threshold) return r;
  return RARITIES[RARITIES.length - 1];
}

function doRoll() {
  const mc = getMultiRollCount();
  if (mc > 1) { doMultiRoll(mc); return; }
  if (rolling || cinematicActive) return;
  rolling = true;
  const rand = Math.random();
  const r = getRarity(rand);
  const pool = ITEMS[r.key];
  const [emoji, name] = pool[Math.floor(Math.random() * pool.length)];

  S.total++;
  S.counts[r.key]++;
  const ri = ORDER.indexOf(r.key);
  const newBest = ri > S.bestIdx;
  if (newBest) S.bestIdx = ri;

  const earned = Math.floor((COIN_REWARDS[r.key] || r.coins || 1) * getCoinMult());
  S.coins += earned;

  const iKey = `${emoji}|${name}|${r.key}`;
  if (!S.inventory[iKey]) {
    S.inventory[iKey] = {emoji, name, rarity:r, count:0, firstRollNum:S.total};
    newItems.add(iKey);
  }
  S.inventory[iKey].count++;

  updateUI();
  addHist(r, emoji, name, earned);
  checkAchievements();
  if (currentTab === 'inv') renderInv();
  if (currentTab === 'shop') renderShop();
  if (newBest && S.total > 1) {
    const t = document.getElementById('toast'); t.classList.add('show');
    setTimeout(() => t.classList.remove('show'), 2000);
  }
  if (currentTab === 'roll') showCoinPop('+' + earned.toLocaleString());

  // Cinematic for ultra-rare — only if user is on roll tab and setting allows
  if (r.fx >= 9) {
    if (currentTab === 'roll' && !gameSettings.skipCinematic) {
      if (autoInt) {
        pendingResumeAuto = true;
        stopAuto();
      }
      rolling = false;
      triggerCin(r, emoji, name, earned);
      return;
    }
    // On background tab — skip cinematic, just render card silently
  }

  // Normal card (only render visually if on roll tab)
  if (currentTab === 'roll') {
    renderCard(r, emoji, name, earned);
  }
  const spd = getAutoSpeedMs();
  setTimeout(() => { rolling = false; }, spd < 600 ? 140 : 300);
}


function doMultiRoll(count) {
  if (cinematicActive) return;
  // Silent-roll (count-1) times, then show the last one visually
  for (let i = 0; i < count; i++) {
    const isLast = i === count - 1;
    const rand = Math.random();
    const r = getRarity(rand);
    const pool = ITEMS[r.key];
    const [emoji, name] = pool[Math.floor(Math.random() * pool.length)];

    S.total++;
    S.counts[r.key]++;
    const ri = ORDER.indexOf(r.key);
    const newBest = ri > S.bestIdx;
    if (newBest) S.bestIdx = ri;

    const earned = Math.floor((COIN_REWARDS[r.key] || r.coins || 1) * getCoinMult());
    S.coins += earned;

    const iKey = `${emoji}|${name}|${r.key}`;
    if (!S.inventory[iKey]) {
      S.inventory[iKey] = {emoji, name, rarity:r, count:0, firstRollNum:S.total};
      newItems.add(iKey);
    }
    S.inventory[iKey].count++;
    addHist(r, emoji, name, earned);

    if (isLast) {
      updateUI();
      checkAchievements();
      if (currentTab === 'inv') renderInv();
      if (currentTab === 'shop') renderShop();
      if (newBest && S.total > 1) {
        const t = document.getElementById('toast'); t.classList.add('show');
        setTimeout(() => t.classList.remove('show'), 2000);
      }
      if (currentTab === 'roll') showCoinPop('+' + (earned * count).toLocaleString());
      if (r.fx >= 9 && currentTab === 'roll' && !gameSettings.skipCinematic) {
        triggerCin(r, emoji, name, earned);
        return;
      }
      if (currentTab === 'roll') renderCard(r, emoji, name, earned);
    }
  }
}

function showCoinPop(txt) {
  const el = document.getElementById('coin-pop');
  el.textContent = txt; el.className = ''; void el.offsetWidth; el.classList.add('show');
}

// ══════════════════════════════════════════════════════════
// CARD RENDER
// ══════════════════════════════════════════════════════════
function renderCard(r, emoji, name, earned) {
  document.getElementById('idleMsg').style.display = 'none';
  document.getElementById('cardWrap').style.display = 'block';
  const lbl = document.getElementById('rollLbl'); lbl.style.visibility = 'visible'; lbl.textContent = `ROLL #${S.total}`;
  const card = document.getElementById('card');
  card.className = 'card'; void card.offsetWidth;
  card.style.setProperty('--c', r.color);
  card.innerHTML = cardHTML(r, emoji, name, 'card-ring', earned);
  card.classList.add('show');
  spawnP(document.getElementById('pcvs'), r);
  if (r.fx >= 2) {
    const sw = document.getElementById('shock');
    sw.style.cssText = `background:${r.color}22;position:absolute;width:10px;height:10px;border-radius:50%;top:50%;left:50%;transform:translate(-50%,-50%) scale(0);opacity:0;pointer-events:none;z-index:1`;
    void sw.offsetWidth; sw.style.animation = 'shockAnim .52s ease-out forwards';
  }
  if (r.fx >= 3) {
    const fl = document.getElementById('flash');
    fl.style.background = r.color; fl.style.animation = 'none'; void fl.offsetWidth;
    fl.style.animation = 'flashOut .33s ease forwards';
  }
}

function cardHTML(r, emoji, name, ringCls, earned) {
  const pStr = r.pct < 0.01 ? r.pct.toFixed(3)+'%' : r.pct < 0.1 ? r.pct.toFixed(3)+'%' : r.pct < 1 ? r.pct.toFixed(2)+'%' : r.pct+'%';
  const oneIn = fmtOdds(r);
  const coinLine = earned !== undefined ? `<div class="card-coin">🪙 +${earned.toLocaleString()}</div>` : '';
  return `<div class="card-top-bar" style="background:${r.color};box-shadow:0 0 12px ${r.color}88"></div>
    <div class="card-body">
      <div class="card-icon">${emoji}</div>
      <div class="card-rar" style="color:${r.color}">${r.label}</div>
      <div class="card-name" style="color:${r.color}">${name}</div>
      <div class="card-sep" style="background:${r.color}"></div>
      <div class="card-odds">
        <div class="odds-col"><span class="odds-key">Chance</span><span class="odds-val" style="color:${r.color}">${pStr}</span></div>
        <div class="odds-col"><span class="odds-key">Odds</span><span class="odds-val" style="color:${r.color}">${oneIn}</span></div>
      </div>${coinLine}
    </div>
    <div class="${ringCls}" style="box-shadow:inset 0 0 0 1px ${r.color}44,0 0 22px ${r.color}44"></div>`;
}

function fmtOdds(r) {
  const n = 100 / r.pct;
  if (n >= 1000) return `1 in ${Math.round(n).toLocaleString()}`;
  if (n >= 10)   return `1 in ${Math.round(n)}`;
  return `1 in ${n.toFixed(1)}`;
}

function spawnP(container, r) {
  container.innerHTML = '';
  for (let i = 0; i < r.np; i++) {
    const p = document.createElement('div'); p.className = 'p';
    const a = (360/r.np)*i + Math.random()*(360/r.np);
    const d = 70+Math.random()*120, sz = 4+Math.random()*5, dur = .35+Math.random()*.3;
    p.style.cssText = `--a:${a}deg;--d:${d}px;width:${sz}px;height:${sz}px;background:${r.color};box-shadow:0 0 ${sz*2}px ${r.color};animation:pBurst ${dur}s ease-out ${Math.random()*.07}s forwards`;
    container.appendChild(p);
  }
}

// ══════════════════════════════════════════════════════════
// CINEMATIC
// ══════════════════════════════════════════════════════════
let cinCtx=null,cinAnim=null,cinP=[],cinSkipped=false;
function triggerCin(r,emoji,name,earned){
  cinematicActive=true; cinSkipped=false;
  const el=document.getElementById('cinematic'),bg=document.getElementById('cin-bg'),
    cardEl=document.getElementById('cin-card'),lbl=document.getElementById('cin-label'),
    skip=document.getElementById('cin-skip'),canvas=document.getElementById('cin-canvas'),
    rp=document.getElementById('view-roll');
  canvas.width=rp.offsetWidth; canvas.height=rp.offsetHeight;
  cinCtx=canvas.getContext('2d');
  const theme=ITEM_THEMES[emoji]||{bg:'radial-gradient(ellipse at 50% 50%,#0a0010,#000)',fx:'starburst'};
  el.style.opacity='0'; el.classList.add('active');
  bg.style.cssText=`position:absolute;inset:0;background:${theme.bg}`;
  let op=0;
  const fi=setInterval(()=>{ op=Math.min(1,op+.05); el.style.opacity=op; if(op>=1){ clearInterval(fi); startCinFX(theme.fx,r,canvas); } },28);
  setTimeout(()=>{ cardEl.className=''; cardEl.style.background='var(--panel2)'; cardEl.innerHTML=cardHTML(r,emoji,name,'card-ring',earned); void cardEl.offsetWidth; cardEl.classList.add('reveal'); },600);
  lbl.textContent=`${r.label.toUpperCase()}  ·  ${fmtOdds(r)} CHANCE`;
  lbl.className=''; void lbl.offsetWidth; lbl.classList.add('show');
  setTimeout(()=>skip.classList.add('vis'),900);
  document.getElementById('idleMsg').style.display='none';
  document.getElementById('cardWrap').style.display='block';
  const rl=document.getElementById('rollLbl'); rl.style.visibility='visible'; rl.textContent=`ROLL #${S.total}`;
  const card=document.getElementById('card'); card.className='card'; void card.offsetWidth;
  card.style.setProperty('--c',r.color); card.innerHTML=cardHTML(r,emoji,name,'card-ring',earned); card.classList.add('show');
  setTimeout(()=>{ if(!cinSkipped) skipCin(); },8000);
}
function skipCin(){
  if(cinSkipped)return; cinSkipped=true;
  const el=document.getElementById('cinematic');
  document.getElementById('cin-skip').classList.remove('vis');
  if(cinAnim){ cancelAnimationFrame(cinAnim); cinAnim=null; }
  let op=1;
  const fo=setInterval(()=>{ op=Math.max(0,op-.08); el.style.opacity=op;
    if(op<=0){ clearInterval(fo); el.classList.remove('active'); el.style.opacity='0';
      if(cinCtx) cinCtx.clearRect(0,0,cinCtx.canvas.width,cinCtx.canvas.height);
      cinP=[]; cinematicActive=false;
      if(pendingResumeAuto){ pendingResumeAuto=false; toggleAuto(); }
    } },18);
}
function startCinFX(fx,r,canvas){ cinP=[];
  if(fx==='starburst') cinStar(r.color,canvas);
  else if(fx==='meteors') cinMet(r.color,canvas);
  else if(fx==='nova') cinNova(r.color,canvas);
  else if(fx==='vortex') cinVort(r.color,canvas);
  else if(fx==='inferno') cinInf(r.color,canvas);
  else if(fx==='tearfall') cinTear(r.color,canvas);
  else cinStar(r.color,canvas);
  animCin(canvas);
}
function animCin(c){ const ctx=cinCtx; if(!ctx)return; ctx.clearRect(0,0,c.width,c.height); cinP=cinP.filter(p=>{p.update();p.draw(ctx);return p.alive;}); cinAnim=requestAnimationFrame(()=>animCin(c)); }
function cinStar(col,cv){const cx=cv.width/2,cy=cv.height/2;for(let i=0;i<200;i++){const a=Math.random()*Math.PI*2,sp=.3+Math.random()*2.5,d=30+Math.random()*Math.max(cv.width,cv.height)*.7;cinP.push({x:cx,y:cy,vx:Math.cos(a)*sp,vy:Math.sin(a)*sp,sz:1+Math.random()*3,al:.8+Math.random()*.2,col:i%3===0?'#fff':i%3===1?col:'#ffd6e0',mD:d,dist:0,alive:true,tail:[],update(){this.dist+=sp;this.x+=this.vx;this.y+=this.vy;this.tail.push({x:this.x,y:this.y});if(this.tail.length>8)this.tail.shift();if(this.dist>=this.mD)this.alive=false;},draw(ctx){ctx.save();for(let t=0;t<this.tail.length;t++){ctx.fillStyle=`rgba(255,255,255,${(t/this.tail.length)*this.al*.5})`;ctx.beginPath();ctx.arc(this.tail[t].x,this.tail[t].y,this.sz*(t/this.tail.length),0,Math.PI*2);ctx.fill();}ctx.shadowBlur=8;ctx.shadowColor=this.col;ctx.fillStyle=this.col;ctx.globalAlpha=this.al;ctx.beginPath();ctx.arc(this.x,this.y,this.sz,0,Math.PI*2);ctx.fill();ctx.restore();}});}for(let r=0;r<3;r++){const ra=80+r*100,cnt=60+r*20,sp2=.008*(r%2===0?1:-1);for(let i=0;i<cnt;i++){const ba=(i/cnt)*Math.PI*2;cinP.push({cx,cy,ra,sp:sp2,col,alive:true,a:ba,update(){this.a+=this.sp;},draw(ctx){const x=this.cx+Math.cos(this.a)*this.ra,y=this.cy+Math.sin(this.a)*this.ra,g=Math.sin(this.a*3+Date.now()*.002)*.4+.6;ctx.save();ctx.shadowBlur=12;ctx.shadowColor=this.col;ctx.fillStyle=this.col;ctx.globalAlpha=g*.7;ctx.beginPath();ctx.arc(x,y,2,0,Math.PI*2);ctx.fill();ctx.restore();}});}}}
function cinMet(col,cv){function sp(){const sx=Math.random()*cv.width*1.5-cv.width*.25,ag=.4+Math.random()*.4,spd=8+Math.random()*10;cinP.push({x:sx,y:-50,vx:Math.cos(ag)*spd,vy:Math.sin(ag)*spd,col,alive:true,al:1,sz:1.5+Math.random()*2,trail:[],update(){this.trail.push({x:this.x,y:this.y});if(this.trail.length>20)this.trail.shift();this.x+=this.vx;this.y+=this.vy;if(this.x>cv.width+100||this.y>cv.height+100)this.alive=false;if(Math.random()<.3)cinP.push({x:this.x,y:this.y,vx:(Math.random()-.5)*2,vy:(Math.random()-.5)*2,sz:Math.random()*2,al:.8,col:this.col,alive:true,life:0,mL:20,update(){this.x+=this.vx;this.y+=this.vy;this.life++;this.al=.8*(1-this.life/this.mL);if(this.life>=this.mL)this.alive=false;},draw(c){c.save();c.globalAlpha=this.al;c.fillStyle=this.col;c.beginPath();c.arc(this.x,this.y,this.sz,0,Math.PI*2);c.fill();c.restore();}});},draw(c){if(this.trail.length<2)return;c.save();for(let i=1;i<this.trail.length;i++){c.strokeStyle=`rgba(255,255,255,${(i/this.trail.length)*this.al})`;c.lineWidth=this.sz*(i/this.trail.length);c.shadowBlur=10;c.shadowColor=this.col;c.beginPath();c.moveTo(this.trail[i-1].x,this.trail[i-1].y);c.lineTo(this.trail[i].x,this.trail[i].y);c.stroke();}c.restore();}});}for(let i=0;i<15;i++)setTimeout(sp,i*200);let t=0;cinP.push({alive:true,update(){t++;if(t%18===0)sp();},draw(){}});for(let i=0;i<150;i++){const sx=Math.random()*cv.width,sy=Math.random()*cv.height,r2=Math.random()*1.5,ph=Math.random()*Math.PI*2,sp2=.02+Math.random()*.04;cinP.push({alive:true,sx,sy,r2,ph,sp2,col,update(){this.ph+=this.sp2;},draw(c){const a=Math.sin(this.ph)*.4+.5;c.save();c.globalAlpha=a;c.fillStyle='#fff';c.shadowBlur=4;c.shadowColor=this.col;c.beginPath();c.arc(this.sx,this.sy,this.r2,0,Math.PI*2);c.fill();c.restore();}});}}
function cinNova(col,cv){const cx=cv.width/2,cy=cv.height/2;for(let r=0;r<6;r++){const dl=r*12;cinP.push({cx,cy,radius:0,mR:Math.max(cv.width,cv.height)*.8,al:.9,sp:4+r*1.5,dl,t:0,col,alive:true,update(){this.t++;if(this.t<this.dl)return;this.radius+=this.sp;this.al=Math.max(0,(1-this.radius/this.mR)*.8);if(this.radius>=this.mR)this.alive=false;},draw(c){if(this.t<this.dl)return;c.save();c.globalAlpha=this.al;c.strokeStyle=this.col;c.lineWidth=2;c.shadowBlur=20;c.shadowColor=this.col;c.beginPath();c.arc(this.cx,this.cy,this.radius,0,Math.PI*2);c.stroke();c.restore();}});}for(let i=0;i<120;i++){const a=Math.random()*Math.PI*2,sp=2+Math.random()*6;cinP.push({x:cx,y:cy,vx:Math.cos(a)*sp,vy:Math.sin(a)*sp,col,alive:true,al:1,life:0,mL:80,update(){this.x+=this.vx;this.y+=this.vy;this.vx*=.97;this.vy*=.97;this.life++;this.al=1-this.life/this.mL;if(this.life>=this.mL)this.alive=false;},draw(c){c.save();c.globalAlpha=this.al;c.strokeStyle=this.col;c.lineWidth=1.5;c.shadowBlur=8;c.shadowColor=this.col;c.beginPath();c.moveTo(this.x,this.y);c.lineTo(this.x-this.vx*8,this.y-this.vy*8);c.stroke();c.restore();}});}let p=0;cinP.push({alive:true,cx,cy,col,update(){p+=.05;},draw(c){const r=40+Math.sin(p)*15,g=c.createRadialGradient(cx,cy,0,cx,cy,r*3);g.addColorStop(0,col+'cc');g.addColorStop(.3,col+'44');g.addColorStop(1,'transparent');c.save();c.globalAlpha=.6+Math.sin(p)*.2;c.fillStyle=g;c.beginPath();c.arc(cx,cy,r*3,0,Math.PI*2);c.fill();c.restore();}});}
function cinVort(col,cv){const cx=cv.width/2,cy=cv.height/2;for(let i=0;i<300;i++){const a=Math.random()*Math.PI*2,d=50+Math.random()*(Math.max(cv.width,cv.height)*.6),sp=(.02+Math.random()*.04)*(Math.random()<.5?1:-1);cinP.push({cx,cy,a,d,sp,col,alive:true,update(){this.a+=this.sp*(200/this.d);this.d=Math.max(20,this.d-.4);if(this.d<=20)this.alive=false;},draw(c){const x=this.cx+Math.cos(this.a)*this.d,y=this.cy+Math.sin(this.a)*this.d,al=Math.min(1,(this.d-20)/100),sz=.5+2*(this.d/500);c.save();c.globalAlpha=al*.8;c.fillStyle=this.col;c.shadowBlur=6;c.shadowColor=this.col;c.beginPath();c.arc(x,y,sz,0,Math.PI*2);c.fill();c.restore();}});}cinP.push({alive:true,cx,cy,col,update(){},draw(c){const g=c.createRadialGradient(cx,cy,0,cx,cy,80);g.addColorStop(0,'rgba(0,0,0,1)');g.addColorStop(.5,col+'66');g.addColorStop(1,'transparent');c.save();c.globalAlpha=.8;c.fillStyle=g;c.beginPath();c.arc(cx,cy,80,0,Math.PI*2);c.fill();c.restore();}});}
function cinInf(col,cv){function se(){cinP.push({x:cv.width/2+(Math.random()-.5)*200,y:cv.height+10,vx:(Math.random()-.5)*1.5,vy:-(2+Math.random()*4),sz:3+Math.random()*8,al:.9,col,alive:true,life:0,mL:40+Math.random()*40,update(){this.x+=this.vx+(Math.random()-.5)*.5;this.y+=this.vy;this.life++;this.sz*=.98;this.al=.9*(1-this.life/this.mL);if(this.life>=this.mL||this.sz<.5)this.alive=false;},draw(c){const g=c.createRadialGradient(this.x,this.y,0,this.x,this.y,this.sz*2);g.addColorStop(0,`rgba(255,255,180,${this.al})`);g.addColorStop(1,'transparent');c.save();c.globalAlpha=this.al;c.fillStyle=g;c.beginPath();c.arc(this.x,this.y,this.sz*2,0,Math.PI*2);c.fill();c.restore();}});}for(let i=0;i<60;i++)setTimeout(se,i*30);let t2=0;cinP.push({alive:true,update(){t2++;if(t2%3===0)se();},draw(){}});cinP.push({alive:true,col,update(){},draw(c){const g=c.createLinearGradient(0,cv.height-200,0,cv.height);g.addColorStop(0,'transparent');g.addColorStop(1,col+'88');c.save();c.globalAlpha=.5;c.fillStyle=g;c.fillRect(0,cv.height-200,cv.width,200);c.restore();}});}
function cinTear(col,cv){function st(){cinP.push({x:Math.random()*cv.width,y:-20,vx:(Math.random()-.5)*.5,vy:2+Math.random()*4,sz:3+Math.random()*6,al:.7+Math.random()*.3,col,alive:true,trail:[],update(){this.trail.push({x:this.x,y:this.y});if(this.trail.length>12)this.trail.shift();this.x+=this.vx;this.y+=this.vy;if(this.y>cv.height+20)this.alive=false;},draw(c){for(let i=0;i<this.trail.length;i++){c.save();c.globalAlpha=(i/this.trail.length)*this.al*.5;c.fillStyle=this.col;c.shadowBlur=8;c.shadowColor=this.col;c.beginPath();c.arc(this.trail[i].x,this.trail[i].y,this.sz*(i/this.trail.length),0,Math.PI*2);c.fill();c.restore();}c.save();c.globalAlpha=this.al;c.fillStyle=this.col;c.shadowBlur=15;c.shadowColor=this.col;c.beginPath();c.moveTo(this.x,this.y-this.sz*2);c.bezierCurveTo(this.x+this.sz,this.y-this.sz,this.x+this.sz,this.y+this.sz,this.x,this.y+this.sz*1.5);c.bezierCurveTo(this.x-this.sz,this.y+this.sz,this.x-this.sz,this.y-this.sz,this.x,this.y-this.sz*2);c.fill();c.restore();}});}for(let i=0;i<40;i++)setTimeout(st,i*80);let t3=0;cinP.push({alive:true,update(){t3++;if(t3%8===0)st();},draw(){}});}

const _ds=document.createElement('style');
_ds.textContent='@keyframes flashOut{0%{opacity:.25}100%{opacity:0}}@keyframes shockAnim{0%{transform:translate(-50%,-50%) scale(0);opacity:.6}100%{transform:translate(-50%,-50%) scale(26);opacity:0}}';
document.head.appendChild(_ds);

// ══════════════════════════════════════════════════════════
// SHOP
// ══════════════════════════════════════════════════════════
function renderTreeNode(id) {
  const n = TREE_NODES[id];
  if (!n) return '<div class="tree-node-empty"></div>';
  const owned = hasNode(id);
  const unlockable = canUnlock(id);
  const affordable = canAffordNode(id);
  const locked = !owned && !unlockable;
  let state = locked ? 'locked' : owned ? 'owned' : unlockable ? (affordable ? 'ready' : 'unafford') : 'locked';
  const colors = {owned:'#4ade80', ready:'var(--gold)', unafford:'var(--muted)', locked:'var(--muted)'};
  const borders = {owned:'rgba(74,222,128,.35)', ready:'rgba(240,180,41,.4)', unafford:'var(--border)', locked:'var(--border)'};
  const bg = {owned:'rgba(74,222,128,.04)', ready:'rgba(240,180,41,.04)', unafford:'transparent', locked:'transparent'};
  const c = colors[state], b = borders[state], bg2 = bg[state];
  let costHtml = '';
  if (!owned) {
    const coinOk = S.coins >= n.coins;
    const rollOk = S.total >= n.rolls;
    costHtml = `<div style="font-size:.57rem;margin-top:5px;display:flex;flex-direction:column;gap:2px;">
      <span style="color:${coinOk?'#fbbf24':'#f43f5e'}">🪙 ${n.coins.toLocaleString()}</span>
      ${n.rolls>0?`<span style="color:${rollOk?'var(--muted2)':'#f43f5e'}">🎲 ${n.rolls.toLocaleString()} rolls needed</span>`:''}
    </div>`;
  }
  const btnLabel = owned ? '✓ Owned' : locked ? '🔒 Locked' : !affordable ? 'Need more' : 'Unlock';
  const btnStyle = owned
    ? 'background:rgba(74,222,128,.12);color:#4ade80;border:1px solid rgba(74,222,128,.3);cursor:default;'
    : locked || !affordable
    ? 'background:rgba(255,255,255,.04);color:var(--muted);border:1px solid var(--border);cursor:not-allowed;opacity:.5;'
    : 'background:linear-gradient(135deg,#f0b429,#fb923c);color:#060810;border:none;cursor:pointer;box-shadow:0 2px 10px rgba(240,180,41,.2);';
  return `<div class="tree-node" style="border-color:${b};background:${bg2};">
    <div style="font-size:1.35rem;line-height:1;">${n.icon}</div>
    <div style="font-family:'Orbitron',sans-serif;font-size:.58rem;font-weight:700;letter-spacing:.04em;color:${c};margin-top:4px;">${n.label}</div>
    <div style="font-size:.64rem;color:${owned?'#4ade80':'var(--text)'};font-weight:600;margin-top:2px;">${n.bonus}</div>
    ${costHtml}
    <button onclick="buyTreeNode('${id}')" style="width:100%;margin-top:7px;padding:5px 8px;font-family:'Orbitron',sans-serif;font-size:.52rem;font-weight:700;letter-spacing:.08em;border-radius:6px;transition:opacity .15s;${btnStyle}" ${owned||locked||!affordable?owned?'':'disabled':''}>${btnLabel}</button>
  </div>`;
}

function renderShop() {
  const body = document.getElementById('shopBody');
  document.getElementById('shopCoins').textContent = S.coins.toLocaleString();
  let html = '';

  // ── Render each tree ───────────────────────────────────────
  Object.entries(TREES).forEach(([treeId, tree]) => {
    html += `<div class="shop-section">
      <div class="shop-sec-title">${tree.icon} ${tree.name}</div>
      <div style="font-size:.72rem;color:var(--muted2);margin-bottom:14px;">${tree.desc}</div>`;

    tree.rows.forEach((row, ri) => {
      html += `<div style="margin-bottom:6px;">
        <div style="font-size:.5rem;letter-spacing:.14em;text-transform:uppercase;color:var(--muted);margin-bottom:8px;font-family:'Orbitron',sans-serif;">${tree.rowLabels[ri]}</div>
        <div class="tree-row">`;
      row.forEach((id, ci) => {
        if (id === null) { html += '<div class="tree-node-empty"></div>'; return; }
        html += renderTreeNode(id);
        // Arrow connector (not after last)
        if (ci < row.length - 1 && row[ci+1] !== null) {
          const nextOwned = hasNode(row[ci+1]);
          const nextUnlockable = canUnlock(row[ci+1]);
          const arrowColor = nextOwned ? '#4ade80' : nextUnlockable ? 'var(--gold)' : 'var(--border)';
          html += `<div class="tree-arrow" style="color:${arrowColor}">→</div>`;
        } else if (ci < row.length - 1) {
          html += '<div class="tree-arrow" style="color:var(--border)">→</div>';
        }
      });
      html += `</div></div>`;

      // Vertical connector between rows (from first node of row 0 to first node of row 1)
      if (ri < tree.rows.length - 1) {
        const fromId = row[0];
        const toId = tree.rows[ri+1][0];
        if (fromId && toId) {
          const lineColor = hasNode(fromId) ? 'rgba(74,222,128,.3)' : 'var(--border)';
          html += `<div style="display:flex;align-items:center;padding:0 0 6px 0;">
            <div style="width:calc(${100/row.length}% / 2 + ${100/row.length/2}%);"></div>
            <div style="font-size:.7rem;color:${lineColor};line-height:1;padding-left:0;">↓</div>
          </div>`;
        }
      }
    });

    html += `</div>`;
  });

  // ── Settings section ───────────────────────────────────────
  html += `<div class="shop-section">
    <div class="shop-sec-title">⚙️ Settings</div>
    <div style="display:flex;flex-direction:column;gap:12px;padding:4px 0;">
      <div style="display:flex;align-items:center;justify-content:space-between;background:var(--panel2);border:1px solid var(--border);border-radius:8px;padding:12px 14px;">
        <div>
          <div style="font-size:.75rem;font-weight:700;color:var(--text);margin-bottom:3px;">Skip Cinematic Animations</div>
          <div style="font-size:.68rem;color:var(--muted);">Skip the divine/transcendent reveal animation when auto-rolling</div>
        </div>
        <button onclick="toggleSkipCinematic()" style="min-width:52px;padding:6px 10px;font-family:'Orbitron',sans-serif;font-size:.6rem;font-weight:700;border-radius:6px;cursor:pointer;border:1px solid ${gameSettings.skipCinematic?'#4ade80':'var(--border)'};background:${gameSettings.skipCinematic?'#4ade8022':'var(--panel)'};color:${gameSettings.skipCinematic?'#4ade80':'var(--muted)'};">
          ${gameSettings.skipCinematic?'ON':'OFF'}
        </button>
      </div>
    </div>
  </div>`;

  body.innerHTML = html;
}

function toggleSkipCinematic() {
  gameSettings.skipCinematic = !gameSettings.skipCinematic;
  saveSettings();
  renderShop();
  notify(gameSettings.skipCinematic ? 'Cinematic animations OFF' : 'Cinematic animations ON', 'info');
}

// ══════════════════════════════════════════════════════════
// INVENTORY
// ══════════════════════════════════════════════════════════
function setFilter(key) {
  activeFilter = key;
  document.querySelectorAll('.inv-filt').forEach(btn => {
    btn.classList.remove('on'); btn.style.background = '';
    const k = btn.id.replace('filt-','');
    if (k === 'all') { btn.style.color=''; btn.style.borderColor=''; }
    else { const r = RARITIES.find(x=>x.key===k); if(r){ btn.style.color=r.color; btn.style.borderColor=r.color+'44'; }}
  });
  const ab = document.getElementById('filt-'+key);
  if (ab) {
    ab.classList.add('on');
    if (key === 'all') { ab.style.background='var(--muted)'; ab.style.borderColor='var(--muted)'; ab.style.color='#07090f'; }
    else { const r=RARITIES.find(x=>x.key===key); ab.style.background=r.color; ab.style.borderColor=r.color; ab.style.color='#07090f'; }
  }
  renderInv();
}

function renderInv() {
  const grid = document.getElementById('invGrid'), sum = document.getElementById('invSum');
  let items = Object.entries(S.inventory).map(([k,v]) => ({k,...v}));
  if (activeFilter !== 'all') items = items.filter(i => i.rarity.key === activeFilter);
  const sort = document.getElementById('invSort').value;
  if (sort==='rarity-desc') items.sort((a,b)=>ORDER.indexOf(b.rarity.key)-ORDER.indexOf(a.rarity.key));
  else if(sort==='rarity-asc') items.sort((a,b)=>ORDER.indexOf(a.rarity.key)-ORDER.indexOf(b.rarity.key));
  else if(sort==='count-desc') items.sort((a,b)=>b.count-a.count);
  else if(sort==='az') items.sort((a,b)=>a.name.localeCompare(b.name));
  const total = Object.values(S.inventory).reduce((s,v)=>s+v.count,0);
  const unique = Object.keys(S.inventory).length;
  const possible = Object.values(ITEMS).flat().length;
  const chips = RARITIES.filter(r=>S.counts[r.key]>0)
    .map(r=>`<span style="display:flex;align-items:center;gap:4px"><span class="i-dot" style="background:${r.color}"></span>${Object.values(S.inventory).filter(i=>i.rarity.key===r.key).length}</span>`).join('');
  sum.innerHTML = `<span style="color:var(--text);font-weight:700">${unique}/${possible} unique</span><span style="color:var(--muted)">·</span><span>${total} total</span>${chips?`<span style="color:var(--muted)">·</span>${chips}`:''}`;
  grid.innerHTML = '';
  if (!items.length) {
    grid.innerHTML = `<div class="inv-empty"><div class="inv-empty-icon">${activeFilter==='all'?'🎒':'🔍'}</div><div class="inv-empty-txt">${activeFilter==='all'?'Start rolling!':'No '+RARITIES.find(r=>r.key===activeFilter)?.label+' yet'}</div></div>`;
    return;
  }
  items.forEach(({k,emoji,isImage,name,rarity,count}) => {
    const isNew = newItems.has(k) && count === 1;
    const div = document.createElement('div'); div.className = 'inv-item';
    div.style.boxShadow = `0 0 0 1px ${rarity.color}25`; div.onclick = () => openDet(k);
    const emojiHtml = isImage ? `<img src="${emoji}" style="width:48px;height:48px;border-radius:6px">` : emoji;
    div.innerHTML = `<div class="inv-item-bar" style="background:${rarity.color};box-shadow:0 0 6px ${rarity.color}66"></div>
      <div class="inv-item-body"><div class="inv-em">${emojiHtml}</div><div class="inv-iname">${name}</div>
      <div class="inv-itar" style="color:${rarity.color}">${rarity.label}</div></div>
      <div class="inv-cnt">×${count}</div>${isNew?'<div class="inv-new">NEW</div>':''}`;
    grid.appendChild(div);
  });
}

function openDet(iKey) {
  const item = S.inventory[iKey]; if(!item) return;
  const {emoji,isImage,name,rarity,count,firstRollNum} = item;
  const emojiHtml = isImage ? `<img src="${emoji}" style="width:80px;height:80px;border-radius:8px">` : emoji;
  document.getElementById('detCard').innerHTML = `
    <div class="det-bar" style="background:${rarity.color};box-shadow:0 0 12px ${rarity.color}99"></div>
    <button class="det-close" onclick="document.getElementById('detOv').classList.remove('open')">✕</button>
    <div class="det-body">
      <div class="det-icon" style="filter:drop-shadow(0 0 16px ${rarity.color})">${emojiHtml}</div>
      <div class="det-rar" style="color:${rarity.color}">${rarity.label}</div>
      <div class="det-name" style="color:${rarity.color}">${name}</div>
      <div class="det-sep" style="background:${rarity.color}"></div>
      <div class="det-stats">
        <div class="det-stat"><span class="det-sk">Owned</span><span class="det-sv" style="color:${rarity.color}">×${count}</span></div>
        <div class="det-stat"><span class="det-sk">Odds</span><span class="det-sv" style="color:${rarity.color}">${fmtOdds(rarity)}</span></div>
        <div class="det-stat"><span class="det-sk">1st Roll</span><span class="det-sv" style="color:${rarity.color}">#${firstRollNum}</span></div>
      </div>
    </div>
    <div class="det-ring" style="box-shadow:inset 0 0 0 1px ${rarity.color}44,0 0 26px ${rarity.color}30"></div>`;
  document.getElementById('detOv').classList.add('open');
}

// ══════════════════════════════════════════════════════════
// ADMIN PANEL
// ══════════════════════════════════════════════════════════
// ══════════════════════════════════════════════════════════
// SIGN IN FLOW
// ══════════════════════════════════════════════════════════
async function startSignIn() {
  if (!SUPABASE_READY) {
    // No Supabase — skip straight to username
    document.getElementById('signInStep').style.display = 'none';
    document.getElementById('usernameStep').style.display = 'block';
    document.getElementById('signedInEmail').parentElement.style.display = 'none';
    setTimeout(() => document.getElementById('unInput').focus(), 100);
    return;
  }

  try {
    const { error } = await sbClient.auth.signInWithOAuth({
      provider: 'google',
      options: { redirectTo: window.location.href }
    });
    if (error) throw error;
    // Page redirects — auth listener handles result on return
  } catch (error) {
    notify('Sign-in failed. You can skip and play without signing in.', 'err');
    document.getElementById('signInStep').style.display = 'none';
    document.getElementById('usernameStep').style.display = 'block';
    document.getElementById('signedInEmail').parentElement.style.display = 'none';
    setTimeout(() => document.getElementById('unInput').focus(), 100);
  }
}

// ══════════════════════════════════════════════════════════
// ADMIN FUNCTIONS
// ══════════════════════════════════════════════════════════
async function signInWithGoogle() {
  if (!SUPABASE_READY) {
    notify('Supabase not configured', 'err');
    return;
  }

  try {
    const { error } = await sbClient.auth.signInWithOAuth({
      provider: 'google',
      options: { redirectTo: window.location.href }
    });
    if (error) throw error;
    // Page will redirect — auth state listener handles the rest on return
  } catch (error) {
    notify('Sign-in failed. Please try again.', 'err');
  }
}

async function openAdmin() {
  if (!SUPABASE_READY) {
    notify('Supabase not configured', 'err');
    return;
  }

  if (!currentUserEmail) {
    await signInWithGoogle();
    return;
  }

  if (!isAdmin) {
    notify('Access denied — not an admin', 'err');
    return;
  }

  renderAdmin();
  document.getElementById('adminEmail').textContent = currentUserEmail;
  openModal('adminMod');
}

async function signOutAdmin() {
  try {
    await sbClient.auth.signOut();
    closeModal('adminMod');
    notify('Signed out', 'info');
  } catch (error) {
    notify('Sign-out failed', 'err');
  }
}

async function renderAdmin() {
  const body = document.getElementById('adminBody');
  const bestR = S.bestIdx >= 0 ? RARITIES.find(r=>r.key===ORDER[S.bestIdx])?.label||'None' : 'None';
  body.innerHTML = `
    <div class="adm-grid">
      <div class="adm-stat"><div class="adm-sl">Rolls</div><div class="adm-sv">${S.total.toLocaleString()}</div></div>
      <div class="adm-stat"><div class="adm-sl">Coins</div><div class="adm-sv" style="color:#fbbf24">🪙 ${S.coins.toLocaleString()}</div></div>
      <div class="adm-stat"><div class="adm-sl">Best Pull</div><div class="adm-sv" style="color:${RARITIES.find(r=>r.label===bestR)?.color||'var(--text)'}">${bestR}</div></div>
      <div class="adm-stat"><div class="adm-sl">Upgrades</div><div class="adm-sv">${S.upgrades.length}</div></div>
    </div>

    <div class="adm-sec">💰 Give Coins</div>
    <div class="m-row">
      <input class="m-inp" id="admCoins" placeholder="Amount..." type="number" style="margin-bottom:0"/>
      <button class="m-btn" style="width:auto;padding:8px 13px;margin-bottom:0" onclick="admGiveCoins()">Give</button>
    </div>

    <div class="adm-sec">🎲 Force Roll</div>
    <div class="m-row">
      <select class="m-inp" id="admRar" style="margin-bottom:0">
        ${RARITIES.map(r=>`<option value="${r.key}">${r.emoji||''} ${r.label}</option>`).join('')}
      </select>
      <button class="m-btn" style="width:auto;padding:8px 13px;margin-bottom:0" onclick="admForce()">Force</button>
    </div>

    <div class="adm-sec">📊 Set Roll Count <small style="color:var(--muted);font-family:'Outfit'">(cosmetic)</small></div>
    <div class="m-row">
      <input class="m-inp" id="admRollCount" type="number" value="${S.total}" style="margin-bottom:0"/>
      <button class="m-btn" style="width:auto;padding:8px 13px;margin-bottom:0" onclick="admSetRolls()">Set</button>
    </div>

    <div class="adm-sec">⚡ Turbo Batch Roll <small style="color:var(--muted);font-family:'Outfit'">(silent, no animations)</small></div>
    <div class="m-row">
      <input class="m-inp" id="admTurboN" placeholder="Number of rolls..." type="number" style="margin-bottom:0"/>
      <button class="m-btn" style="width:auto;padding:8px 13px;margin-bottom:0;background:linear-gradient(135deg,#e879f9,#818cf8)" onclick="admTurbo()">RUN</button>
    </div>
    <div id="admTurboProg" style="margin-top:5px;display:none">
      <div style="height:3px;background:rgba(255,255,255,.06);border-radius:2px">
        <div id="admTurboBar" style="height:100%;background:linear-gradient(90deg,#e879f9,#818cf8);border-radius:2px;width:0%;transition:width .1s"></div>
      </div>
      <div id="admTurboTxt" style="font-size:.62rem;color:var(--muted);margin-top:4px;text-align:center"></div>
    </div>

    <div class="adm-sec">🏆 Board Players</div>
    <div id="admPlayers"><div style="color:var(--muted);font-size:.7rem">Loading...</div></div>`;

  renderCustomRaritiesList();

  if (!SUPABASE_READY) {
    document.getElementById('admPlayers').innerHTML = '<div style="color:var(--muted);font-size:.7rem">Supabase not configured.</div>';
    return;
  }

  try {
    const { data, error } = await sbClient
      .from('leaderboard')
      .select('uid, name, coins, rolls')
      .order('coins', { ascending: false });

    const el = document.getElementById('admPlayers');
    if (error || !data || data.length === 0) {
      el.innerHTML = '<div style="color:var(--muted);font-size:.7rem">No players yet.</div>';
      return;
    }
    el.innerHTML = '';
    for (const player of data) {
      const row = document.createElement('div');
      row.className = 'adm-row';
      row.innerHTML = `<span class="adm-name">${esc(player.name||'?')}</span>
        <span class="adm-coins">🪙 ${(player.coins||0).toLocaleString()}</span>
        <span style="color:var(--muted);font-size:.62rem">${player.rolls||0} rolls</span>
        <button class="adm-del" onclick="admDelPlayer('${player.uid}')">DEL</button>`;
      el.appendChild(row);
    }
  } catch(e) {
    document.getElementById('admPlayers').innerHTML = '<div style="color:var(--muted);font-size:.7rem">Error loading players.</div>';
  }
}

function admGiveCoins() {
  const n = parseInt(document.getElementById('admCoins').value);
  if (isNaN(n) || n <= 0 || n > 100000000) { notify('Invalid amount (1 – 100,000,000)','err'); return; }
  S.coins += n; updateUI(); renderAdmin(); notify(`+${n.toLocaleString()} coins`,'ok');
}

function admForce() {
  const key = document.getElementById('admRar').value;
  
  // Get rarity from RARITIES array (works for both built-in and custom)
  const r = RARITIES.find(x => x.key === key);
  if (!r) {
    notify('Rarity not found', 'err');
    return;
  }
  
  // Check if this rarity has items
  if (!ITEMS[r.key] || ITEMS[r.key].length === 0) {
    notify(`No items available for ${r.label}`, 'err');
    return;
  }
  
  // Pick random item from this rarity
  const [emoji, name] = ITEMS[r.key][Math.floor(Math.random() * ITEMS[r.key].length)];
  
  // Update stats
  S.total++;
  if (!S.counts[r.key]) S.counts[r.key] = 0;
  S.counts[r.key]++;
  
  const earned = COIN_REWARDS[r.key] || 10; // Default to 10 coins if not defined
  S.coins += earned;
  
  const ri = ORDER.indexOf(r.key);
  if (ri > S.bestIdx) S.bestIdx = ri;
  
  // Add to inventory
  const isImage = emoji.startsWith('data:image');
  const iKey = `${emoji}|${name}|${r.key}`;
  if (!S.inventory[iKey]) {
    S.inventory[iKey] = {
      emoji: emoji,
      isImage: isImage,
      name: name,
      rarity: r,
      count: 0,
      firstRollNum: S.total
    };
    newItems.add(iKey);
  }
  S.inventory[iKey].count++;
  
  updateUI();
  addHist(r, emoji, name, earned);
  if (currentTab === 'inv') renderInv();
  renderAdmin();
  notify(`Forced ${r.emoji||''} ${r.label}: ${name}!`, 'ok');
}

function admSetRolls() {
  const n = parseInt(document.getElementById('admRollCount').value);
  if (isNaN(n)||n<0) { notify('Invalid','err'); return; }
  S.total = n; updateUI(); notify(`Roll count set to ${n.toLocaleString()}`,'info');
}

function admTurbo() {
  const n = parseInt(document.getElementById('admTurboN').value);
  if (isNaN(n)||n<1||n>100000000000) { notify('Enter 1–100000000000','err'); return; }
  closeModal('adminMod');
  let i = 0;
  const batch = 500;
  function run() {
    const end = Math.min(i+batch, n);
    for (; i<end; i++) {
      const r = getRarity(Math.random());
      const [em,nm] = ITEMS[r.key][Math.floor(Math.random()*ITEMS[r.key].length)];
      S.total++; S.counts[r.key]++;
      const earned = COIN_REWARDS[r.key]||1; S.coins += earned;
      const ri=ORDER.indexOf(r.key); if(ri>S.bestIdx) S.bestIdx=ri;
      const ik=`${em}|${nm}|${r.key}`;
      if(!S.inventory[ik]){ S.inventory[ik]={emoji:em,name:nm,rarity:r,count:0,firstRollNum:S.total}; newItems.add(ik); }
      S.inventory[ik].count++;
    }
    updateUI();
    notify(`Turbo: ${i.toLocaleString()} / ${n.toLocaleString()}`, 'info');
    if (i < n) setTimeout(run, 5);
    else { notify(`Turbo done! ${n.toLocaleString()} rolls`, 'ok'); saveGame(false); }
  }
  run();
}

async function admDelPlayer(uid) {
  if (!confirm('Delete this player from leaderboard?')) return;
  try {
    // Call Edge Function (admin-only server-side delete)
    const { error } = await sbClient.functions.invoke('delete-player', {
      body: { targetUid: uid }
    });
    if (error) throw error;
    renderAdmin();
    notify('Removed', 'info');
  } catch(e) {
    notify('Failed to delete', 'err');
  }
}

// ══════════════════════════════════════════════════════════
// CUSTOM RARITY CREATOR
// ══════════════════════════════════════════════════════════
let currentRarityImage = null;

function openRarityCreator() {
  // Reset form
  document.getElementById('rarName').value = '';
  document.getElementById('rarIcon').value = '';
  document.getElementById('rarColor').value = '#c084fc';
  document.getElementById('rarColorPicker').value = '#c084fc';
  document.getElementById('rarPct').value = '';
  document.getElementById('rarCoins').value = '';
  document.getElementById('rarIconPreview').style.display = 'none';
  document.getElementById('rarErr').style.display = 'none';
  currentRarityImage = null;
  
  // Set up live preview
  ['rarName', 'rarIcon', 'rarColor', 'rarPct', 'rarCoins'].forEach(id => {
    document.getElementById(id).addEventListener('input', updateRarityPreview);
  });
  document.getElementById('rarColorPicker').addEventListener('input', () => {
    document.getElementById('rarColor').value = document.getElementById('rarColorPicker').value;
    updateRarityPreview();
  });
  
  updateRarityPreview();
  refreshModalCustomList();
  openModal('rarityCreatorMod');
}

function updateRarityPreview() {
  const name = document.getElementById('rarName').value || 'NEW RARITY';
  const icon = document.getElementById('rarIcon').value || '✨';
  const color = document.getElementById('rarColor').value || '#c084fc';
  const pct = document.getElementById('rarPct').value || '0.05';
  const coins = document.getElementById('rarCoins').value || '5000';
  
  document.getElementById('rarPreviewName').textContent = name.toUpperCase();
  document.getElementById('rarPreviewName').style.color = color;
  document.getElementById('rarPreviewIcon').textContent = icon;
  document.getElementById('rarPreviewPct').textContent = pct + '%';
  document.getElementById('rarPreviewCoins').textContent = '🪙 ' + parseInt(coins || 0).toLocaleString();
}

function handleRarityImage(input) {
  if (input.files && input.files[0]) {
    const file = input.files[0];
    const reader = new FileReader();
    reader.onload = function(e) {
      currentRarityImage = e.target.result;
      document.getElementById('rarIconImg').src = currentRarityImage;
      document.getElementById('rarIconPreview').style.display = 'block';
      document.getElementById('rarIcon').value = '[Image]';
      document.getElementById('rarPreviewIcon').innerHTML = `<img src="${currentRarityImage}" style="width:32px;height:32px;border-radius:4px">`;
    };
    reader.readAsDataURL(file);
  }
}

function saveCustomRarity() {
  const name = document.getElementById('rarName').value.trim();
  const icon = document.getElementById('rarIcon').value.trim();
  const color = document.getElementById('rarColor').value.trim();
  const pct  = parseFloat(document.getElementById('rarPct').value);
  const coins = parseInt(document.getElementById('rarCoins').value);
  const err  = document.getElementById('rarErr');

  // ── Validation ───────────────────────────────────────────
  const showErr = (msg) => { err.textContent = msg; err.style.display = 'block'; };
  if (!name)                               { showErr('Enter a rarity name'); return; }
  if (!icon && !currentRarityImage)        { showErr('Enter an emoji or upload an image'); return; }
  if (!color || !/^#[0-9a-fA-F]{6}$/.test(color)) { showErr('Enter a valid hex color e.g. #ff6b9d'); return; }
  if (isNaN(pct) || pct <= 0 || pct > 100){ showErr('Enter a drop rate between 0.0001 and 100'); return; }
  if (isNaN(coins) || coins < 1)           { showErr('Enter a valid coin reward'); return; }
  err.style.display = 'none';

  // ── Sanitise ─────────────────────────────────────────────
  const safeName  = name.replace(/[<>&"'`]/g, '').trim().slice(0, 20);
  const safeColor = color;
  const safePct   = Math.max(0.0001, Math.min(pct, 50)); // cap at 50% so common doesn't disappear
  const safeCoins = Math.max(1, Math.min(coins, 999999999));
  const safeIcon  = currentRarityImage || (icon.replace(/[<>&"']/g,'').trim() || '⭐');

  // ── Build key — unique, lowercase, no spaces ─────────────
  const baseKey = 'custom_' + safeName.toLowerCase().replace(/[^a-z0-9]/g, '_');
  let key = baseKey;
  let attempt = 1;
  while (RARITIES.find(r => r.key === key)) { key = baseKey + '_' + (++attempt); }

  // ── Determine fx level (cosmetic particle intensity) ─────
  let fx = 1;
  if (safePct < 0.001) fx = 10;
  else if (safePct < 0.01) fx = 7;
  else if (safePct < 0.1) fx = 5;
  else if (safePct < 1) fx = 3;
  else fx = 1;

  // ── Create proper rarity object ──────────────────────────
  const newRar = {
    key,
    label: safeName,
    emoji: safeIcon,
    isImage: !!currentRarityImage,
    color: safeColor,
    pct: safePct,
    coins: safeCoins,
    np: Math.min(50, Math.round(20 + (10 - fx) * 3)),
    fx,
    _custom: true,
  };

  // ── Recalculate common% to absorb this new rarity ────────
  const commonRar = RARITIES.find(r => r.key === 'common');
  if (commonRar) {
    commonRar.pct = Math.max(1, commonRar.pct - safePct);
  }

  // ── Insert into live arrays ───────────────────────────────
  // Insert just before 'common' so it appears in sensible position
  const commonIdx = RARITIES.findIndex(r => r.key === 'common');
  if (commonIdx >= 0) {
    RARITIES.splice(commonIdx, 0, newRar);
  } else {
    RARITIES.push(newRar);
  }

  // Recalculate all thresholds
  (function recalcThresholds() {
    let c = 0;
    RARITIES.forEach(r => { c += r.pct / 100; r.threshold = Math.min(1, c); });
    RARITIES[RARITIES.length - 1].threshold = 1.0;
  })();

  // Add to ORDER (before 'common')
  const commonOrderIdx = ORDER.indexOf('common');
  if (commonOrderIdx >= 0) ORDER.splice(commonOrderIdx, 0, key);
  else ORDER.push(key);

  // Initialise items pool — start with one placeholder item
  if (!ITEMS[key]) ITEMS[key] = [[safeIcon, safeName]];
  if (!S.counts) S.counts = {};
  S.counts[key] = 0;

  // ── Persist to fateRoll_customData ───────────────────────
  customRarities.push(newRar);
  saveCustomData();

  // ── Rebuild rarity table sidebar ─────────────────────────
  rebuildRarTable();

  closeModal('rarityCreatorMod');
  renderAdmin();
  refreshModalCustomList();
  updateUI();
  notify(`✨ "${safeName}" rarity created!`, 'ok');
}

// Rebuild the rarity table in the sidebar without page reload

function refreshModalCustomList() {
  const list = document.getElementById('modalCustomList');
  if (!list) return;
  const myRars = customRarities.filter(r => r._custom);
  if (!myRars.length) {
    list.innerHTML = '<div style="color:var(--muted2);font-size:.68rem;">None yet.</div>';
    return;
  }
  list.innerHTML = myRars.map(r => {
    const iconHtml = (r.isImage && r.emoji && r.emoji.startsWith('data:'))
      ? `<img src="${r.emoji}" style="width:20px;height:20px;border-radius:3px;object-fit:cover;vertical-align:middle">`
      : r.emoji || '⭐';
    return `<div style="display:flex;align-items:center;gap:8px;padding:7px 10px;
      background:var(--panel2);border-radius:8px;margin-bottom:6px;border:1px solid ${r.color}33;">
      <span style="font-size:1.1rem;">${iconHtml}</span>
      <div style="flex:1;">
        <span style="font-weight:700;font-size:.78rem;color:${r.color};">${r.label}</span>
        <span style="font-size:.62rem;color:var(--muted2);margin-left:7px;">${r.pct}% · 🪙 ${(r.coins||0).toLocaleString()}</span>
      </div>
      <button onclick="deleteCustomRarity('${r.key}');refreshModalCustomList();"
        style="padding:3px 8px;font-size:.52rem;font-family:'Orbitron',sans-serif;font-weight:700;
          cursor:pointer;border:1px solid rgba(244,63,94,.3);border-radius:5px;
          background:rgba(244,63,94,.07);color:#f43f5e;">DEL</button>
    </div>`;
  }).join('');
}

function rebuildRarTable() {
  const t = document.getElementById('rarTable');
  if (!t) return;
  t.innerHTML = '';
  const logPcts = RARITIES.map(r => Math.log10(r.pct + 0.000001) + 7);
  const maxLog = Math.max(...logPcts);
  RARITIES.forEach((r, i) => {
    const w = Math.max(1, (logPcts[i] / maxLog) * 100).toFixed(1);
    const pct = r.pct;
    let pStr;
    if (pct < 0.0001)      pStr = pct.toExponential(1) + '%';
    else if (pct < 0.001)  pStr = pct.toFixed(5) + '%';
    else if (pct < 0.01)   pStr = pct.toFixed(4) + '%';
    else if (pct < 0.1)    pStr = pct.toFixed(3) + '%';
    else if (pct < 1)      pStr = pct.toFixed(2) + '%';
    else                   pStr = pct.toFixed(1) + '%';
    const oneInNum = Math.round(100 / pct);
    let oneIn;
    if (oneInNum >= 1000000) oneIn = '1 in ' + (oneInNum/1000000).toFixed(1) + 'M';
    else if (oneInNum >= 1000) oneIn = '1 in ' + (oneInNum/1000).toFixed(oneInNum<10000?1:0) + 'K';
    else oneIn = '1 in ' + oneInNum;
    const row = document.createElement('div'); row.className = 'rar-row';
    const iconHtml = (r.isImage && r.emoji && r.emoji.startsWith('data:'))
      ? `<img src="${r.emoji}" style="width:14px;height:14px;border-radius:2px;vertical-align:middle;margin-right:3px">`
      : '';
    row.innerHTML = `<span class="rar-name" style="color:${r.color}">${iconHtml}${r.label}</span>
      <span class="rar-pct">${pStr}</span>
      <span class="rar-1in" style="color:${r.color}88">${oneIn}</span>
      <div class="bar-bg"><div class="bar-fill" style="width:${w}%;background:${r.color};box-shadow:0 0 6px ${r.color}55"></div></div>
      <span class="rar-cnt" id="cnt-${r.key}">0</span>`;
    t.appendChild(row);
  });
}

function renderCustomRaritiesList() {
  const list = document.getElementById('customRaritiesList');
  if (!list) return;
  const myRars = customRarities.filter(r => r._custom);
  if (!myRars.length) {
    list.innerHTML = '<div style="color:var(--muted2);font-size:.72rem;padding:12px 0;">No custom rarities yet. Hit ✨ Create above!</div>';
    return;
  }
  list.innerHTML = myRars.map(r => {
    const iconHtml = (r.isImage && r.emoji && r.emoji.startsWith('data:'))
      ? `<img src="${r.emoji}" style="width:28px;height:28px;border-radius:5px;object-fit:cover">`
      : `<span style="font-size:1.5rem">${r.emoji || '⭐'}</span>`;
    const oneIn = Math.round(100/r.pct);
    const oneInStr = oneIn >= 1000000 ? (oneIn/1000000).toFixed(1)+'M' : oneIn >= 1000 ? (oneIn/1000).toFixed(1)+'K' : oneIn;
    return `
      <div style="display:flex;align-items:center;gap:12px;padding:10px 13px;
        background:var(--panel2);border-radius:10px;margin-bottom:8px;
        border:1px solid ${r.color}44;position:relative;">
        <div style="flex-shrink:0">${iconHtml}</div>
        <div style="flex:1;min-width:0;">
          <div style="font-weight:700;font-size:.84rem;color:${r.color};letter-spacing:.03em;">${r.label}</div>
          <div style="font-size:.63rem;color:var(--muted2);margin-top:2px;display:flex;gap:10px;flex-wrap:wrap;">
            <span>📊 ${r.pct}% (1 in ${oneInStr})</span>
            <span>🪙 ${(r.coins||0).toLocaleString()}</span>
          </div>
        </div>
        <button onclick="deleteCustomRarity('${r.key}')"
          style="padding:5px 10px;font-family:'Orbitron',sans-serif;font-size:.5rem;font-weight:700;
            letter-spacing:.06em;cursor:pointer;border:1px solid rgba(244,63,94,.35);border-radius:6px;
            background:rgba(244,63,94,.07);color:#f43f5e;transition:all .15s;flex-shrink:0;"
          onmouseover="this.style.background='rgba(244,63,94,.15)'"
          onmouseout="this.style.background='rgba(244,63,94,.07)'">
          DELETE
        </button>
      </div>`;
  }).join('');
}

function deleteCustomRarity(key) {
  const r = customRarities.find(cr => cr.key === key);
  if (!r) return;
  if (!confirm(`Delete "${r.label}"? Items rolled with it stay in inventory but won't drop again.`)) return;

  // Give common its % back
  const commonRar = RARITIES.find(x => x.key === 'common');
  if (commonRar) commonRar.pct = Math.min(99, commonRar.pct + r.pct);

  // Remove from live arrays
  const ri = RARITIES.findIndex(x => x.key === key);
  if (ri >= 0) RARITIES.splice(ri, 1);
  const oi = ORDER.indexOf(key);
  if (oi >= 0) ORDER.splice(oi, 1);

  // Recalculate thresholds
  let c = 0;
  RARITIES.forEach(x => { c += x.pct/100; x.threshold = Math.min(1,c); });
  RARITIES[RARITIES.length-1].threshold = 1.0;

  // Remove from customRarities list
  const ci = customRarities.findIndex(cr => cr.key === key);
  if (ci >= 0) customRarities.splice(ci, 1);

  saveCustomData();
  rebuildRarTable();
  renderAdmin();
  updateUI();
  notify(`"${r.label}" deleted.`, 'info');
}


// ══════════════════════════════════════════════════════════
// UI / HISTORY
// ══════════════════════════════════════════════════════════
function updateUI() {
  document.getElementById('hs-name').textContent = S.playerName || '—';
  document.getElementById('hs-rolls').textContent = S.total.toLocaleString();
  document.getElementById('hs-coins').textContent = S.coins.toLocaleString();
  document.getElementById('shopCoins').textContent = S.coins.toLocaleString();
  document.getElementById('invBadge').textContent = Object.keys(S.inventory).length;
  RARITIES.forEach(r => {
    const el = document.getElementById('cnt-'+r.key);
    if (el) { el.textContent=S.counts[r.key]||0; if((S.counts[r.key]||0)>0) el.style.color=r.color; }
  });
  if (S.bestIdx >= 0) {
    const best = RARITIES.find(x=>x.key===ORDER[S.bestIdx]);
    if (best) { const el=document.getElementById('hs-best'); el.textContent=best.label; el.style.color=best.color; }
  }
  updateBoostUI();
  
  // Speed label
  const speedLbl = document.getElementById('speedLabel');
  if (speedLbl) speedLbl.textContent = 'Speed: ' + getSpeedLabel();

  // Bg indicator
  const bgOn = autoInt && currentTab !== 'roll';
  document.getElementById('bgIndicator').classList.toggle('on', !!bgOn);
  document.getElementById('bgBadge').classList.toggle('on', !!bgOn);
}

function addHist(r, emoji, name, earned) {
  const list = document.getElementById('histList');
  const item = document.createElement('div'); item.className = 'hist-item';
  item.innerHTML = `<span class="hi-em">${emoji}</span><span class="hi-name">${name}</span><span class="hi-tag" style="color:${r.color}">${r.label}</span>`;
  list.insertBefore(item, list.firstChild);
  while (list.children.length > 80) list.removeChild(list.lastChild);
}

// ══════════════════════════════════════════════════════════
// AUTO ROLL & TURBO — PERSISTS ACROSS TAB SWITCHES
// ══════════════════════════════════════════════════════════
function updateAutoBtn() {
  const btn = document.getElementById('autoBtn');
  const prog = document.getElementById('progWrap');
  const running = !!autoInt;
  btn.classList.toggle('active', !!autoInt);
  prog.classList.toggle('vis', running);
  if (autoInt) btn.innerHTML = '◼ STOP <span style="opacity:.4;font-size:.75em">[A]</span>';
  else btn.innerHTML = '⟳ AUTO <span style="opacity:.4;font-size:.75em">[A]</span>';
  updateUI();
}

function animProg(ms) {
  const f = document.getElementById('progFill');
  f.style.transition='none'; f.style.width='0%'; void f.offsetWidth;
  f.style.transition=`width ${ms}ms linear`; f.style.width='100%';
}

function stopAuto() {
  if (autoInt) { clearInterval(autoInt); autoInt=null; }
  updateAutoBtn();
}

function toggleAuto() {
  if (autoInt) { stopAuto(); return; }
  const ms = getAutoSpeedMs();
  const go = () => { if (!rolling && !cinematicActive) { doRoll(); if(currentTab==='roll') animProg(ms); } };
  go();
  autoInt = setInterval(go, ms);
  updateAutoBtn();
}

// ══════════════════════════════════════════════════════════
// TABS
// ══════════════════════════════════════════════════════════
function switchTab(tab) {
  // Stop leaderboard listener when leaving board tab
  if (currentTab === 'board' && tab !== 'board') {
    stopLeaderboardListen();
  }
  
  currentTab = tab;
  document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
  document.querySelectorAll('.tab-view').forEach(v=>v.classList.remove('active'));
  document.getElementById('tab-'+tab).classList.add('active');
  document.getElementById('view-'+tab).classList.add('active');
  if (tab==='inv') { renderInv(); setTimeout(()=>{ newItems.clear(); renderInv(); },2000); }
  if (tab==='shop') renderShop();
  if (tab==='ach') renderAch();
  if (tab==='board') { 
    loadBoard(false); 
    // Start real-time listening
    startLeaderboardListen();
  }
  if (tab==='editor') { renderEditorRarities(); renderEditorItems(); }
  updateUI(); // refresh bg indicator
}

// ══════════════════════════════════════════════════════════
// MODALS / NOTIFY
// ══════════════════════════════════════════════════════════
function openModal(id) { document.getElementById(id).classList.add('open'); }
function closeModal(id) { document.getElementById(id).classList.remove('open'); }

let _nTimer = null;
function notify(msg, type='info') {
  const el = document.getElementById('notif');
  el.textContent=msg; el.className='notif '+type;
  void el.offsetWidth; el.classList.add('show');
  if(_nTimer) clearTimeout(_nTimer);
  _nTimer = setTimeout(()=>el.classList.remove('show'), 2800);
}

// ══════════════════════════════════════════════════════════
// KEYBOARD
// ══════════════════════════════════════════════════════════
document.addEventListener('keydown', e => {
  const inGame = document.getElementById('un-screen').style.display === 'none';
  if (!inGame) {
    if (e.key === 'Enter') startGame();
    return;
  }
  if (e.key === ' ' && !autoInt && !cinematicActive) { e.preventDefault(); doRoll(); }
  if ((e.key==='a'||e.key==='A') && !cinematicActive) { e.preventDefault(); toggleAuto(); }
  if (e.key==='i'||e.key==='I') { e.preventDefault(); switchTab(currentTab==='inv'?'roll':'inv'); }
  if (e.key==='Escape') {
    document.getElementById('detOv').classList.remove('open');
    document.querySelectorAll('.modal-ov').forEach(m=>m.classList.remove('open'));
    if (cinematicActive) skipCin();
  }
  if ((e.ctrlKey||e.metaKey) && e.key==='s') { e.preventDefault(); saveGame(); }
});

// Ensure auto-roll continues even when tab is in background
document.addEventListener('visibilitychange', () => {
  if (!document.hidden && gameStarted) updateUI();
});

// Auto-save every 20s, also submit score
setInterval(() => { 
  if (typeof S !== 'undefined' && !S._flagged) {
    saveGame(false); 
    if(gameStarted && SUPABASE_READY) submitScore();
  }
}, 20000);

// ══════════════════════════════════════════════════════════
// INIT
// ══════════════════════════════════════════════════════════
// Load settings
loadSettings();

// Initialize Supabase
initSupabase();

// Load custom rarities and items first
loadCustomData();

loadGame();
updateUI();
if (S.total > 0) renderInv();
renderShop();
startBoostTick();

// Setup color picker sync
setTimeout(() => {
  const colorInput = document.getElementById('rarityColor');
  const colorPicker = document.getElementById('rarityColorPicker');
  
  if (colorInput && colorPicker) {
    colorInput.addEventListener('input', () => {
      if (colorInput.value.match(/^#[0-9A-Fa-f]{6}$/)) {
        colorPicker.value = colorInput.value;
      }
    });
    
    colorPicker.addEventListener('input', () => {
      colorInput.value = colorPicker.value;
    });
  }
}, 100);

// If returning player (already has name), skip username screen entirely
if (S.playerName && S.playerName.length >= 3) {
  document.getElementById('un-screen').style.display = 'none';
  gameStarted = true;
  updateUI();
  setTimeout(() => {
    if (SUPABASE_READY && currentTab === 'board') loadBoard(false);
  }, 500);
} else {
  if (SUPABASE_READY && sbUser) {
    document.getElementById('signInStep').style.display = 'none';
    document.getElementById('usernameStep').style.display = 'block';
    if (sbUser.email) document.getElementById('signedInEmail').textContent = sbUser.email;
    setTimeout(() => document.getElementById('unInput').focus(), 100);
  } else {
    setTimeout(() => {
      if (!SUPABASE_READY) {
        document.getElementById('signInStep').style.display = 'none';
        document.getElementById('usernameStep').style.display = 'block';
        document.getElementById('signedInEmail').parentElement.style.display = 'none';
        document.getElementById('unInput').focus();
      }
    }, 2000);
  }
}
</script>
</body>
</html>
